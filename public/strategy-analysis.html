<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radian Planner - Strategy Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Road+Rage&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
</head>
<body class="bg-neutral-900 text-neutral-100 p-4">

<div class="main-container">
    <div class="text-center mb-6">
        <img src="https://github.com/Radian-Motorsport/Endurance-Planner-Backend/blob/main/g457912.png?raw=true" alt="?" class="mx-auto w-100 h-auto">
    </div>
    
    <div class="inner-container">
        <!-- Navigation -->
        <nav class="flex justify-between items-center mb-6">
            <a href="index.html" class="btn-back">
                <i class="fa-solid fa-arrow-left"></i>
            </a>
            <div class="flex space-x-4">
                <a href="race-setup.html" class="text-neutral-400 hover:text-cyan-400">Setup</a>
                <a href="live-timing.html" class="text-neutral-400 hover:text-cyan-400">Live Timing</a>
                <a href="strategy-analysis.html" class="text-cyan-400 font-semibold">Analysis</a>
            </div>
        </nav>

        <h2 class="text-5xl road-rage-font text-center mb-8">STRATEGY ANALYSIS</h2>

        <!-- Garage61 Integration Status -->
        <div id="garage61-status" class="bg-neutral-700 p-6 rounded-lg mb-8">
            <h3 class="text-xl font-semibold mb-4 road-rage-font">Team Performance Data</h3>
            <div class="flex items-center justify-between">
                <div>
                    <div class="text-sm text-neutral-400">Garage61 Integration</div>
                    <div id="api-status" class="text-lg font-semibold text-yellow-400">Checking...</div>
                </div>
                <button id="test-connection" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200">
                    <i class="fa-solid fa-refresh mr-2"></i>Test Connection
                </button>
            </div>
        </div>

        <!-- Track Selection -->
        <div class="bg-neutral-700 p-6 rounded-lg mb-8">
            <h3 class="text-xl font-semibold mb-4 road-rage-font">Track Selection</h3>
            <div class="flex space-x-4">
                <div class="flex-1">
                    <label class="text-sm font-medium text-neutral-300">Select Track</label>
                    <select id="track-selector" class="w-full mt-1 p-2 border border-neutral-600 rounded-lg text-neutral-100 bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Loading tracks...</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button id="load-track-data" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition-all duration-200">
                        <i class="fa-solid fa-download mr-2"></i>Load Data
                    </button>
                </div>
            </div>
        </div>

        <!-- Team Performance Summary -->
        <div id="team-performance" class="bg-neutral-700 p-6 rounded-lg mb-8 hidden">
            <h3 class="text-xl font-semibold mb-4 road-rage-font">Team Performance Summary</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-neutral-600 p-4 rounded-lg text-center">
                    <div class="text-sm text-neutral-400">Average Lap Time</div>
                    <div id="avg-lap-time" class="text-2xl font-bold text-cyan-400">--:--.-</div>
                </div>
                <div class="bg-neutral-600 p-4 rounded-lg text-center">
                    <div class="text-sm text-neutral-400">Average Fuel per Lap</div>
                    <div id="avg-fuel-per-lap" class="text-2xl font-bold text-green-400">--.-- L</div>
                </div>
                <div class="bg-neutral-600 p-4 rounded-lg text-center">
                    <div class="text-sm text-neutral-400">Total Sessions</div>
                    <div id="total-sessions" class="text-2xl font-bold text-yellow-400">--</div>
                </div>
            </div>
        </div>

        <!-- Driver Performance Breakdown -->
        <div id="driver-performance" class="bg-neutral-700 p-6 rounded-lg mb-8 hidden">
            <h3 class="text-xl font-semibold mb-4 road-rage-font">Driver Performance Breakdown</h3>
            <div class="overflow-x-auto">
                <table class="w-full bg-neutral-800 rounded-lg">
                    <thead>
                        <tr class="bg-neutral-600 text-neutral-100">
                            <th class="px-4 py-3 text-left">Driver</th>
                            <th class="px-4 py-3 text-center">Sessions</th>
                            <th class="px-4 py-3 text-center">Avg Lap Time</th>
                            <th class="px-4 py-3 text-center">Best Lap</th>
                            <th class="px-4 py-3 text-center">Fuel per Lap</th>
                            <th class="px-4 py-3 text-center">Consistency</th>
                        </tr>
                    </thead>
                    <tbody id="driver-table-body">
                        <!-- Dynamic content will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Strategy Recommendations -->
        <div id="strategy-recommendations" class="bg-neutral-700 p-6 rounded-lg mb-8 hidden">
            <h3 class="text-xl font-semibold mb-4 road-rage-font">Strategy Recommendations</h3>
            <div class="space-y-4">
                <div class="bg-blue-600 bg-opacity-20 border-l-4 border-blue-600 p-4 rounded">
                    <div class="flex items-start">
                        <i class="fa-solid fa-lightbulb text-blue-400 mt-1 mr-3"></i>
                        <div>
                            <h4 class="font-semibold text-blue-400">Fuel Strategy</h4>
                            <p id="fuel-recommendation" class="text-sm text-neutral-300 mt-1">Based on team data, consider adjusting fuel consumption estimates.</p>
                        </div>
                    </div>
                </div>
                <div class="bg-green-600 bg-opacity-20 border-l-4 border-green-600 p-4 rounded">
                    <div class="flex items-start">
                        <i class="fa-solid fa-stopwatch text-green-400 mt-1 mr-3"></i>
                        <div>
                            <h4 class="font-semibold text-green-400">Lap Time Strategy</h4>
                            <p id="laptime-recommendation" class="text-sm text-neutral-300 mt-1">Optimize stint lengths based on actual team performance.</p>
                        </div>
                    </div>
                </div>
                <div class="bg-yellow-600 bg-opacity-20 border-l-4 border-yellow-600 p-4 rounded">
                    <div class="flex items-start">
                        <i class="fa-solid fa-users text-yellow-400 mt-1 mr-3"></i>
                        <div>
                            <h4 class="font-semibold text-yellow-400">Driver Rotation</h4>
                            <p id="driver-recommendation" class="text-sm text-neutral-300 mt-1">Consider driver strengths for optimal stint assignments.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Apply to Setup Button -->
        <div class="text-center">
            <button id="apply-recommendations" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-lg transition-all duration-200 transform hover:scale-105 hidden">
                <i class="fa-solid fa-magic-wand-sparkles mr-2"></i>Apply Recommendations to Setup
            </button>
        </div>
    </div>
</div>

<script>
let currentTrackData = null;

document.addEventListener('DOMContentLoaded', function() {
    testGarage61Connection();
    loadAvailableTracks();
    setupEventHandlers();
});

function setupEventHandlers() {
    document.getElementById('test-connection').addEventListener('click', testGarage61Connection);
    document.getElementById('load-track-data').addEventListener('click', loadTrackPerformanceData);
    document.getElementById('apply-recommendations').addEventListener('click', applyRecommendations);
}

async function testGarage61Connection() {
    const statusElement = document.getElementById('api-status');
    statusElement.textContent = 'Testing...';
    statusElement.className = 'text-lg font-semibold text-yellow-400';

    try {
        const response = await fetch('/api/garage61/test');
        const result = await response.json();
        
        if (response.ok && result.success) {
            statusElement.textContent = 'Connected ✓';
            statusElement.className = 'text-lg font-semibold text-green-400';
        } else {
            statusElement.textContent = 'Connection Failed ✗';
            statusElement.className = 'text-lg font-semibold text-red-400';
        }
    } catch (error) {
        console.error('Connection test failed:', error);
        statusElement.textContent = 'Connection Error ✗';
        statusElement.className = 'text-lg font-semibold text-red-400';
    }
}

async function loadAvailableTracks() {
    const selector = document.getElementById('track-selector');
    
    try {
        const response = await fetch('/api/garage61/tracks');
        const result = await response.json();
        
        if (response.ok && result.success) {
            selector.innerHTML = '<option value="">Select a track...</option>';
            result.tracks.forEach(track => {
                const option = document.createElement('option');
                option.value = track.id;
                option.textContent = track.name;
                selector.appendChild(option);
            });
        } else {
            selector.innerHTML = '<option value="">No tracks available</option>';
        }
    } catch (error) {
        console.error('Failed to load tracks:', error);
        selector.innerHTML = '<option value="">Error loading tracks</option>';
    }
}

async function loadTrackPerformanceData() {
    const trackId = document.getElementById('track-selector').value;
    if (!trackId) {
        alert('Please select a track first.');
        return;
    }

    const loadButton = document.getElementById('load-track-data');
    loadButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Loading...';
    loadButton.disabled = true;

    try {
        const response = await fetch(`/api/garage61/team-performance/${trackId}`);
        const result = await response.json();
        
        if (response.ok && result.success) {
            currentTrackData = result.data;
            displayTeamPerformance(result.data);
            generateRecommendations(result.data);
            
            // Show performance sections
            document.getElementById('team-performance').classList.remove('hidden');
            document.getElementById('driver-performance').classList.remove('hidden');
            document.getElementById('strategy-recommendations').classList.remove('hidden');
            document.getElementById('apply-recommendations').classList.remove('hidden');
        } else {
            alert('Failed to load track data: ' + (result.message || 'Unknown error'));
        }
    } catch (error) {
        console.error('Failed to load track performance data:', error);
        alert('Error loading track data. Please try again.');
    } finally {
        loadButton.innerHTML = '<i class="fa-solid fa-download mr-2"></i>Load Data';
        loadButton.disabled = false;
    }
}

function displayTeamPerformance(data) {
    // Format lap time
    const avgLapTime = formatLapTimeFromSeconds(data.avgLapTime);
    document.getElementById('avg-lap-time').textContent = avgLapTime;
    
    // Display fuel consumption
    document.getElementById('avg-fuel-per-lap').textContent = data.avgFuelPerLap.toFixed(2) + ' L';
    
    // Display total sessions
    document.getElementById('total-sessions').textContent = data.totalSessions || '--';
    
    // Populate driver table
    const tbody = document.getElementById('driver-table-body');
    tbody.innerHTML = '';
    
    if (data.driverAverages && data.driverAverages.length > 0) {
        data.driverAverages.forEach(driver => {
            const row = document.createElement('tr');
            row.className = 'border-b border-neutral-600';
            
            const consistency = calculateConsistency(driver.lapTimes);
            const bestLap = Math.min(...driver.lapTimes);
            
            row.innerHTML = `
                <td class="px-4 py-3 font-medium">${driver.driverName}</td>
                <td class="px-4 py-3 text-center">${driver.sessions}</td>
                <td class="px-4 py-3 text-center">${formatLapTimeFromSeconds(driver.avgLapTime)}</td>
                <td class="px-4 py-3 text-center">${formatLapTimeFromSeconds(bestLap)}</td>
                <td class="px-4 py-3 text-center">${driver.avgFuelPerLap.toFixed(2)} L</td>
                <td class="px-4 py-3 text-center">${consistency}</td>
            `;
            tbody.appendChild(row);
        });
    } else {
        tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-3 text-center text-neutral-500">No driver data available</td></tr>';
    }
}

function generateRecommendations(data) {
    // Fuel recommendation
    const currentConfig = JSON.parse(localStorage.getItem('radianPlannerConfig') || '{}');
    const currentFuel = parseFloat(currentConfig.fuelPerLap) || 0;
    const recommendedFuel = data.avgFuelPerLap;
    
    let fuelRecommendation = '';
    if (currentFuel === 0) {
        fuelRecommendation = `Set fuel consumption to ${recommendedFuel.toFixed(2)} L/lap based on team data.`;
    } else {
        const fuelDifference = recommendedFuel - currentFuel;
        if (Math.abs(fuelDifference) > 0.1) {
            const direction = fuelDifference > 0 ? 'increase' : 'decrease';
            fuelRecommendation = `Consider ${direction} fuel consumption by ${Math.abs(fuelDifference).toFixed(2)} L/lap (from ${currentFuel.toFixed(2)} to ${recommendedFuel.toFixed(2)}).`;
        } else {
            fuelRecommendation = 'Current fuel consumption setting aligns well with team data.';
        }
    }
    document.getElementById('fuel-recommendation').textContent = fuelRecommendation;
    
    // Lap time recommendation
    const currentLapMinutes = parseInt(currentConfig.lapTimeMinutes) || 0;
    const currentLapSeconds = parseFloat(currentConfig.lapTimeSeconds) || 0;
    const currentTotalSeconds = (currentLapMinutes * 60) + currentLapSeconds;
    
    let lapTimeRecommendation = '';
    if (currentTotalSeconds === 0) {
        lapTimeRecommendation = `Set lap time to ${formatLapTimeFromSeconds(data.avgLapTime)} based on team average.`;
    } else {
        const timeDifference = data.avgLapTime - currentTotalSeconds;
        if (Math.abs(timeDifference) > 1) {
            const direction = timeDifference > 0 ? 'increase' : 'decrease';
            lapTimeRecommendation = `Consider ${direction} lap time by ${Math.abs(timeDifference).toFixed(1)}s (from ${formatLapTimeFromSeconds(currentTotalSeconds)} to ${formatLapTimeFromSeconds(data.avgLapTime)}).`;
        } else {
            lapTimeRecommendation = 'Current lap time setting aligns well with team data.';
        }
    }
    document.getElementById('laptime-recommendation').textContent = lapTimeRecommendation;
    
    // Driver rotation recommendation
    let driverRecommendation = 'No specific driver data available for rotation planning.';
    if (data.driverAverages && data.driverAverages.length > 1) {
        const fastestDriver = data.driverAverages.reduce((prev, current) => 
            prev.avgLapTime < current.avgLapTime ? prev : current
        );
        const mostEfficientDriver = data.driverAverages.reduce((prev, current) => 
            prev.avgFuelPerLap < current.avgFuelPerLap ? prev : current
        );
        
        if (fastestDriver.driverName === mostEfficientDriver.driverName) {
            driverRecommendation = `${fastestDriver.driverName} shows both speed and fuel efficiency - consider longer stints.`;
        } else {
            driverRecommendation = `${fastestDriver.driverName} is fastest (${formatLapTimeFromSeconds(fastestDriver.avgLapTime)}), ${mostEfficientDriver.driverName} is most fuel-efficient (${mostEfficientDriver.avgFuelPerLap.toFixed(2)}L/lap).`;
        }
    }
    document.getElementById('driver-recommendation').textContent = driverRecommendation;
}

function calculateConsistency(lapTimes) {
    if (lapTimes.length < 2) return 'N/A';
    
    const mean = lapTimes.reduce((sum, time) => sum + time, 0) / lapTimes.length;
    const variance = lapTimes.reduce((sum, time) => sum + Math.pow(time - mean, 2), 0) / lapTimes.length;
    const stdDev = Math.sqrt(variance);
    
    // Convert to percentage consistency (lower is better)
    const consistency = ((stdDev / mean) * 100);
    
    if (consistency < 1) return 'Excellent';
    if (consistency < 2) return 'Good';
    if (consistency < 3) return 'Average';
    return 'Poor';
}

function formatLapTimeFromSeconds(totalSeconds) {
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = (totalSeconds % 60).toFixed(1);
    return `${minutes}:${seconds.padStart(4, '0')}`;
}

function applyRecommendations() {
    if (!currentTrackData) {
        alert('No track data available to apply.');
        return;
    }
    
    const currentConfig = JSON.parse(localStorage.getItem('radianPlannerConfig') || '{}');
    
    // Apply fuel recommendation
    currentConfig.fuelPerLap = currentTrackData.avgFuelPerLap.toFixed(2);
    
    // Apply lap time recommendation
    const minutes = Math.floor(currentTrackData.avgLapTime / 60);
    const seconds = (currentTrackData.avgLapTime % 60).toFixed(1);
    currentConfig.lapTimeMinutes = minutes.toString();
    currentConfig.lapTimeSeconds = seconds;
    
    // Save updated configuration
    localStorage.setItem('radianPlannerConfig', JSON.stringify(currentConfig));
    
    // Show confirmation
    const applyButton = document.getElementById('apply-recommendations');
    const originalText = applyButton.innerHTML;
    applyButton.innerHTML = '<i class="fa-solid fa-check mr-2"></i>Applied Successfully!';
    applyButton.classList.add('bg-green-700');
    applyButton.classList.remove('bg-purple-600', 'hover:bg-purple-700');
    
    setTimeout(() => {
        applyButton.innerHTML = originalText;
        applyButton.classList.remove('bg-green-700');
        applyButton.classList.add('bg-purple-600', 'hover:bg-purple-700');
    }, 3000);
    
    alert('Recommendations applied to race setup! Visit the Setup page to review changes.');
}
</script>

</body>
</html>