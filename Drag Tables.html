<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Drag Reference Tool</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
    
    @font-face {
      font-family: 'RoadRage';
      src: url('RoadRage.woff2') format('woff2'),
           url('RoadRage.woff') format('woff');
      font-weight: normal;
      font-style: normal;
    }
    
    .road-rage-font {
      font-family: 'RoadRage', 'Orbitron', monospace !important;
      font-weight: normal;
      letter-spacing: 2px;
      text-transform: uppercase;
    }
    
    /* Custom toggle switch */
    #disableFrhSuggestions:checked + div .dot {
      transform: translateX(24px); /* Reduced to prevent overflow */
      background-color: #ef4444;
    }
    
    #disableFrhSuggestions:checked + div {
      background-color: #dc2626;
    }
    
    /* Ensure toggle background stays rounded and contained */
    .toggle-bg {
      overflow: hidden;
      border-radius: 9999px;
    }
    
    .toggle-dot {
      transition: transform 0.3s ease, background-color 0.3s ease;
      border-radius: 9999px;
      width: 20px !important; /* Smaller dot */
      height: 20px !important; /* Smaller dot */
    }
    
    .text-shadow {
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    }
    
    .icon-shadow {
      filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.5));
    }
    
    .bg-gradient-custom {
      background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
    }
  </style>
</head>
<body class="bg-neutral-900 text-neutral-200 min-h-screen">
  <div class="max-w-6xl mx-auto bg-neutral-900 p-6 md:p-10 rounded-xl transition-colors duration-500">
    
    <!-- Header -->
    <div class="text-center mb-8">
      <h2 class="text-5xl road-rage-font text-center mb-4 text-shadow">DRAG REFERENCE TOOL</h2>
      <p class="text-neutral-400 text-lg">Optimize your aerodynamic settings for minimum drag</p>
    </div>

    <!-- Input Form -->
    <div class="p-6 bg-neutral-800 border-neutral-800 rounded-lg mb-6">
      <form id="refForm" class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          
          <!-- Wing Selection -->
          <div class="flex flex-col">
            <label class="text-sm font-medium text-neutral-500 mb-2">
              <i class="fas fa-plane text-blue-400 mr-2"></i>Wing Level
            </label>
            <select id="wing" class="p-3 border-neutral-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 bg-neutral-900 text-neutral-200">
              <option value="12">Wing 12</option>
              <option value="13">Wing 13</option>
              <option value="14">Wing 14</option>
              <option value="15">Wing 15</option>
              <option value="16">Wing 16</option>
              <option value="17">Wing 17</option>
            </select>
          </div>

          <!-- Front RH Input -->
          <div class="flex flex-col">
            <label class="text-sm font-medium text-neutral-500 mb-2">
              <i class="fas fa-arrow-up text-green-400 mr-2"></i>Front RH (mm)
            </label>
            <input type="number" id="frhInput" value="20" class="p-3 border-neutral-700 rounded-lg text-neutral-200 bg-neutral-900 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
          </div>

          <!-- Rear RH Input -->
          <div class="flex flex-col">
            <label class="text-sm font-medium text-neutral-500 mb-2">
              <i class="fas fa-arrow-up text-red-400 mr-2"></i>Rear RH (mm)
            </label>
            <input type="number" id="rrhInput" value="40" class="p-3 border-neutral-700 rounded-lg text-neutral-200 bg-neutral-900 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
          </div>
          
        </div>
        
        <!-- Toggle for FRH suggestions -->
        <div class="mb-4 p-3 bg-neutral-800 rounded-lg border border-neutral-600">
          <label class="flex items-center cursor-pointer">
            <input type="checkbox" id="disableFrhSuggestions" class="sr-only">
            <div class="relative toggle-bg">
              <div class="block bg-neutral-600 w-14 h-8 rounded-full overflow-hidden"></div>
              <div class="dot toggle-dot absolute left-2 top-2 bg-white w-5 h-5 rounded-full transition-all duration-300"></div>
            </div>
            <div class="ml-3 text-neutral-200">
              <span class="text-sm font-medium">Disable Front RH Suggestions</span>
              <p class="text-xs text-neutral-400 mt-1">Toggle when you're already at minimum front ride height</p>
            </div>
          </label>
        </div>
        
        <!-- Submit Button -->
        <div class="flex justify-center mt-6">
          <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white py-3 px-8 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105 road-rage-font">
            <i class="fas fa-calculator mr-2"></i>CALCULATE DRAG
          </button>
        </div>
      </form>
    </div>

    <!-- Results Section -->
    <div class="p-6 bg-neutral-800 border-neutral-800 rounded-lg mb-6">
      <h3 class="text-xl road-rage-font mb-4 text-center">
        <i class="fas fa-chart-line text-yellow-400 mr-2"></i>RESULTS
      </h3>
      <p id="result" class="text-center text-lg font-mono bg-neutral-900 p-4 rounded-lg border border-neutral-700"></p>
    </div>

    <!-- Optimization Recommendations -->
    <div id="recommendations" class="p-6 bg-gradient-to-r from-blue-900/20 to-green-900/20 border border-blue-500/30 rounded-lg mb-6" style="display: none;">
      <h3 class="text-xl road-rage-font mb-4 text-blue-300">
        <i class="fas fa-lightbulb text-yellow-400 mr-2 icon-shadow"></i>OPTIMIZATION SUGGESTIONS
      </h3>
      <div id="optimizationResults"></div>
    </div>

    <!-- Plot Container -->
    <div class="p-6 bg-neutral-800 border-neutral-800 rounded-lg">
      <h3 class="text-xl road-rage-font mb-4 text-center">
        <i class="fas fa-chart-area text-purple-400 mr-2"></i>DRAG MAP VISUALIZATION
      </h3>
      <div id="plot" style="width:100%;height:70vh;" class="rounded-lg overflow-hidden"></div>
    </div>

  </div>

  <script>
   const tables = {
  "12": {
    frh: [-10,0,10,20,30,40,50,60,70,80,90,100],
    rrh: [-25,-15,-5,5,15,25,35,45,55,65,75,85,95,105,115,125,135,145],
    ld: [
      [4.30,4.23,4.05,4.14,4.14,3.97,3.79,3.81,3.74,3.67,3.60,3.53],
      [4.25,4.17,3.99,4.08,4.06,3.88,3.70,3.71,3.63,3.55,3.48,3.40],
      [4.21,4.12,3.93,4.01,3.98,3.80,3.61,3.61,3.52,3.44,3.35,3.27],
      [4.16,4.07,3.87,3.95,3.90,3.71,3.51,3.51,3.41,3.32,3.23,3.13],
      [4.12,4.02,3.80,3.88,3.83,3.63,3.42,3.41,3.31,3.21,3.10,3.00],
      [3.96,3.85,3.64,3.72,3.65,3.46,3.25,3.23,3.13,3.03,2.92,2.82],
      [4.10,3.98,3.75,3.82,3.74,3.53,3.31,3.28,3.16,3.05,2.93,2.81],
      [4.08,3.95,3.71,3.77,3.67,3.45,3.22,3.17,3.04,2.91,2.78,2.65],
      [3.96,3.82,3.57,3.62,3.51,3.28,3.04,2.98,2.84,2.70,2.56,2.42],
      [3.88,3.73,3.47,3.53,3.41,3.17,2.93,2.87,2.73,2.58,2.44,2.30],
      [3.81,3.67,3.41,3.47,3.34,3.11,2.88,2.82,2.68,2.54,2.39,2.25],
      [3.81,3.65,3.38,3.43,3.28,3.03,2.79,2.71,2.55,2.40,2.24,2.08],
      [3.77,3.60,3.31,3.37,3.20,2.95,2.70,2.61,2.45,2.28,2.12,1.95],
      [3.72,3.55,3.25,3.30,3.13,2.86,2.61,2.51,2.34,2.16,1.99,1.82],
      [3.68,3.50,3.19,3.24,3.05,2.78,2.51,2.41,2.23,2.05,1.87,1.69],
      [3.63,3.45,3.13,3.17,2.97,2.69,2.42,2.31,2.12,1.93,1.74,1.56],
      [3.59,3.39,3.07,3.11,2.89,2.61,2.33,2.21,2.01,1.82,1.62,1.42],
      [3.55,3.34,3.01,3.04,2.82,2.52,2.24,2.11,1.91,1.70,1.50,1.29]
    ]
  },

  "13": {
    frh: [-10,0,10,20,30,40,50,60,70,80,90,100],
    rrh: [-25,-15,-5,5,15,25,35,45,55,65,75,85,95,105,115,125,135,145],
    ld: [
      [4.30,4.23,4.05,4.14,4.14,3.97,3.79,3.81,3.74,3.67,3.60,3.54],
      [4.25,4.17,3.99,4.08,4.06,3.89,3.70,3.71,3.64,3.56,3.48,3.40],
      [4.21,4.12,3.93,4.01,3.98,3.80,3.61,3.61,3.53,3.44,3.36,3.27],
      [4.16,4.07,3.87,3.95,3.91,3.72,3.52,3.51,3.42,3.33,3.24,3.14],
      [4.12,4.02,3.81,3.89,3.83,3.63,3.43,3.42,3.31,3.21,3.11,3.01],
      [3.96,3.86,3.64,3.72,3.66,3.46,3.26,3.24,3.14,3.03,2.93,2.83],
      [4.10,3.99,3.76,3.83,3.75,3.54,3.32,3.29,3.17,3.05,2.94,2.82],
      [4.08,3.96,3.71,3.77,3.68,3.45,3.23,3.18,3.05,2.92,2.79,2.66],
      [3.96,3.83,3.57,3.63,3.51,3.28,3.05,2.99,2.85,2.71,2.58,2.44],
      [3.88,3.74,3.48,3.54,3.41,3.18,2.94,2.88,2.74,2.60,2.45,2.31],
      [3.81,3.67,3.41,3.48,3.35,3.12,2.89,2.83,2.69,2.55,2.41,2.27],
      [3.81,3.66,3.38,3.44,3.29,3.04,2.80,2.72,2.57,2.41,2.25,2.10],
      [3.77,3.61,3.32,3.37,3.21,2.96,2.71,2.62,2.46,2.29,2.13,1.97],
      [3.73,3.55,3.26,3.31,3.13,2.87,2.62,2.52,2.35,2.18,2.01,1.84],
      [3.68,3.50,3.20,3.24,3.06,2.79,2.53,2.42,2.24,2.06,1.88,1.71],
      [3.64,3.45,3.14,3.18,2.98,2.70,2.44,2.32,2.14,1.95,1.76,1.57],
      [3.59,3.40,3.08,3.11,2.90,2.62,2.35,2.23,2.03,1.83,1.64,1.44],
      [3.55,3.35,3.02,3.05,2.83,2.53,2.26,2.13,1.92,1.72,1.52,1.31]
    ]
  },

    "14": {
    frh: [-10,0,10,20,30,40,50,60,70,80,90,100],
    rrh: [-25,-15,-5,5,15,25,35,45,55,65,75,85,95,105,115,125,135,145],
    ld: [
      [4.29,4.22,4.05,4.14,4.13,3.97,3.79,3.81,3.74,3.67,3.60,3.54],
      [4.25,4.17,3.99,4.08,4.06,3.89,3.70,3.71,3.64,3.56,3.48,3.41],
      [4.20,4.12,3.93,4.01,3.98,3.80,3.61,3.61,3.53,3.45,3.36,3.28],
      [4.16,4.07,3.87,3.95,3.90,3.72,3.52,3.52,3.42,3.33,3.24,3.15],
      [4.12,4.02,3.81,3.88,3.83,3.64,3.43,3.42,3.32,3.22,3.12,3.02],
      [3.96,3.86,3.65,3.72,3.66,3.46,3.26,3.24,3.14,3.04,2.94,2.84],
      [4.10,3.98,3.76,3.83,3.75,3.54,3.32,3.29,3.18,3.06,2.95,2.83],
      [4.08,3.95,3.71,3.77,3.68,3.46,3.23,3.19,3.06,2.93,2.80,2.68],
      [3.96,3.82,3.57,3.63,3.51,3.29,3.06,3.00,2.86,2.72,2.58,2.45],
      [3.88,3.74,3.48,3.54,3.42,3.18,2.95,2.89,2.75,2.61,2.47,2.32],
      [3.81,3.67,3.42,3.48,3.35,3.13,2.90,2.84,2.70,2.56,2.42,2.28],
      [3.81,3.66,3.38,3.44,3.29,3.05,2.81,2.73,2.58,2.42,2.27,2.11],
      [3.77,3.61,3.32,3.37,3.22,2.97,2.72,2.63,2.47,2.31,2.15,1.98],
      [3.73,3.56,3.26,3.31,3.14,2.88,2.63,2.53,2.36,2.19,2.02,1.85],
      [3.68,3.50,3.20,3.25,3.06,2.80,2.54,2.44,2.26,2.08,1.90,1.72],
      [3.64,3.45,3.14,3.18,2.99,2.71,2.45,2.34,2.15,1.97,1.78,1.59],
      [3.59,3.40,3.08,3.12,2.91,2.63,2.36,2.24,2.05,1.85,1.66,1.47],
      [3.55,3.35,3.02,3.06,2.83,2.55,2.27,2.14,1.94,1.74,1.54,1.34]
    ]
  },

  "15": {
    frh: [-10,0,10,20,30,40,50,60,70,80,90,100],
    rrh: [-25,-15,-5,5,15,25,35,45,55,65,75,85,95,105,115,125,135,145],
    ld: [
      [4.28,4.21,4.04,4.13,4.13,3.97,3.79,3.81,3.74,3.67,3.61,3.54],
      [4.24,4.16,3.98,4.07,4.05,3.88,3.70,3.71,3.64,3.56,3.49,3.41],
      [4.19,4.11,3.92,4.01,3.98,3.80,3.61,3.61,3.53,3.45,3.36,3.28],
      [4.15,4.06,3.86,3.94,3.90,3.72,3.52,3.52,3.43,3.33,3.24,3.15],
      [4.11,4.01,3.80,3.88,3.82,3.63,3.43,3.42,3.32,3.22,3.12,3.02],
      [3.95,3.85,3.64,3.72,3.66,3.46,3.27,3.25,3.15,3.05,2.95,2.84],
      [4.09,3.98,3.75,3.82,3.74,3.54,3.32,3.29,3.18,3.07,2.95,2.84],
      [4.07,3.95,3.71,3.77,3.67,3.46,3.23,3.19,3.06,2.94,2.81,2.68],
      [3.96,3.82,3.57,3.63,3.51,3.29,3.06,3.00,2.87,2.73,2.59,2.46],
      [3.87,3.73,3.48,3.54,3.42,3.19,2.96,2.89,2.75,2.61,2.47,2.33],
      [3.81,3.67,3.42,3.48,3.35,3.13,2.90,2.84,2.70,2.57,2.43,2.29],
      [3.81,3.66,3.39,3.44,3.29,3.05,2.81,2.74,2.58,2.43,2.28,2.12],
      [3.77,3.61,3.33,3.38,3.22,2.97,2.72,2.64,2.48,2.32,2.16,2.00],
      [3.72,3.55,3.27,3.31,3.14,2.89,2.64,2.54,2.37,2.20,2.04,1.87],
      [3.68,3.50,3.21,3.25,3.07,2.80,2.55,2.44,2.27,2.09,1.92,1.74],
      [3.64,3.45,3.15,3.19,2.99,2.72,2.46,2.35,2.16,1.98,1.79,1.61],
      [3.60,3.40,3.09,3.12,2.92,2.64,2.37,2.25,2.06,1.87,1.67,1.48],
      [3.55,3.35,3.03,3.06,2.84,2.55,2.28,2.15,1.95,1.75,1.55,1.35]
    ]
  },

    "16": {
    frh: [-10,0,10,20,30,40,50,60,70,80,90,100],
    rrh: [-25,-15,-5,5,15,25,35,45,55,65,75,85,95,105,115,125,135,145],
    ld: [
      [4.27,4.20,4.03,4.12,4.11,3.95,3.78,3.80,3.73,3.67,3.60,3.54],
      [4.22,4.15,3.97,4.06,4.04,3.87,3.69,3.70,3.63,3.56,3.48,3.41],
      [4.18,4.10,3.91,3.99,3.96,3.79,3.61,3.61,3.53,3.44,3.36,3.28],
      [4.14,4.05,3.85,3.93,3.89,3.71,3.52,3.51,3.42,3.33,3.24,3.15],
      [4.10,4.00,3.80,3.87,3.82,3.63,3.43,3.42,3.32,3.22,3.12,3.03],
      [3.94,3.84,3.64,3.71,3.65,3.46,3.27,3.25,3.15,3.05,2.95,2.85],
      [4.08,3.97,3.75,3.81,3.74,3.53,3.32,3.29,3.18,3.07,2.95,2.84],
      [4.06,3.94,3.70,3.76,3.67,3.45,3.23,3.19,3.06,2.94,2.81,2.69],
      [3.95,3.81,3.57,3.62,3.51,3.29,3.06,3.00,2.87,2.74,2.60,2.47],
      [3.87,3.73,3.48,3.53,3.41,3.19,2.96,2.90,2.76,2.62,2.48,2.34],
      [3.80,3.66,3.41,3.47,3.35,3.13,2.90,2.85,2.71,2.57,2.44,2.30],
      [3.80,3.65,3.38,3.44,3.29,3.05,2.82,2.74,2.59,2.44,2.29,2.14],
      [3.76,3.60,3.32,3.37,3.22,2.97,2.73,2.65,2.49,2.33,2.17,2.01],
      [3.72,3.55,3.26,3.31,3.14,2.89,2.64,2.55,2.38,2.22,2.05,1.88],
      [3.68,3.50,3.21,3.25,3.07,2.81,2.55,2.45,2.28,2.10,1.93,1.76],
      [3.63,3.45,3.15,3.19,2.99,2.73,2.47,2.36,2.18,1.99,1.81,1.63],
      [3.59,3.40,3.09,3.13,2.92,2.65,2.38,2.26,2.07,1.88,1.69,1.50],
      [3.55,3.35,3.03,3.06,2.85,2.56,2.29,2.16,1.97,1.77,1.57,1.37]
    ]
  },

  "17": {
    frh: [-10,0,10,20,30,40,50,60,70,80,90,100],
    rrh: [-25,-15,-5,5,15,25,35,45,55,65,75,85,95,105,115,125,135,145],
    ld: [
      [4.25,4.18,4.01,4.10,4.10,3.94,3.77,3.79,3.72,3.66,3.59,3.53],
      [4.20,4.13,3.96,4.04,4.02,3.86,3.68,3.69,3.62,3.55,3.48,3.40],
      [4.16,4.08,3.90,3.98,3.95,3.78,3.60,3.60,3.52,3.44,3.36,3.28],
      [4.12,4.03,3.84,3.92,3.88,3.70,3.51,3.50,3.42,3.33,3.24,3.15],
      [4.08,3.98,3.78,3.86,3.80,3.62,3.42,3.41,3.31,3.22,3.12,3.03],
      [3.93,3.83,3.63,3.70,3.64,3.45,3.26,3.24,3.15,3.05,2.95,2.85],
      [4.06,3.95,3.73,3.80,3.72,3.53,3.32,3.29,3.18,3.07,2.95,2.84],
      [4.05,3.92,3.69,3.75,3.66,3.45,3.23,3.18,3.06,2.94,2.81,2.69],
      [3.93,3.80,3.56,3.61,3.50,3.28,3.06,3.00,2.87,2.74,2.61,2.47],
      [3.85,3.72,3.47,3.53,3.41,3.18,2.96,2.90,2.76,2.63,2.49,2.35],
      [3.79,3.65,3.41,3.47,3.35,3.13,2.91,2.85,2.71,2.58,2.44,2.31],
      [3.79,3.64,3.38,3.43,3.29,3.05,2.82,2.75,2.60,2.45,2.30,2.15],
      [3.75,3.59,3.32,3.37,3.22,2.97,2.73,2.65,2.49,2.34,2.18,2.02],
      [3.71,3.54,3.26,3.31,3.14,2.89,2.65,2.56,2.39,2.23,2.06,1.90],
      [3.67,3.50,3.20,3.25,3.07,2.81,2.56,2.46,2.29,2.12,1.94,1.77],
      [3.63,3.45,3.15,3.18,3.00,2.73,2.47,2.37,2.19,2.01,1.83,1.65],
      [3.59,3.40,3.09,3.12,2.92,2.65,2.39,2.27,2.08,1.90,1.71,1.52],
      [3.54,3.35,3.03,3.06,2.85,2.57,2.30,2.18,1.98,1.79,1.59,1.39]
    ]
  }
};



    function bracketIndices(arr, val) {
      if (val <= arr[0]) return { i0: 0, i1: 0 };
      if (val >= arr[arr.length-1]) return { i0: arr.length-1, i1: arr.length-1 };
      for (let i=0; i<arr.length-1; i++) {
        if (val >= arr[i] && val <= arr[i+1]) return { i0: i, i1: i+1 };
      }
    }

    function bilinearInterp(x, y, table) {
      const {frh, rrh, ld} = table;
      const {i0: ix0, i1: ix1} = bracketIndices(frh, x);
      const {i0: iy0, i1: iy1} = bracketIndices(rrh, y);
      if (ix0===ix1 && iy0===iy1) return ld[iy0][ix0];
      const x0=frh[ix0], x1=frh[ix1];
      const y0=rrh[iy0], y1=rrh[iy1];
      const Q11=ld[iy0][ix0], Q21=ld[iy0][ix1];
      const Q12=ld[iy1][ix0], Q22=ld[iy1][ix1];
      const tx=(x-x0)/(x1-x0), ty=(y-y0)/(y1-y0);
      return (Q11*(1-tx)*(1-ty) + Q21*tx*(1-ty) + Q12*(1-tx)*ty + Q22*tx*ty);
    }

    function findOptimizations(currentFrh, currentRrh, currentDrag, table, maxChange = 5) {
      const recommendations = [];
      const {frh, rrh} = table;
      const disableFrhSuggestions = document.getElementById('disableFrhSuggestions').checked;
      
      // Find valid FRH and RRH ranges within maxChange (realistic 5mm max)
      // If FRH suggestions are disabled, only test current FRH value
      const frhMin = disableFrhSuggestions ? currentFrh : Math.max(frh[0], currentFrh - maxChange);
      const frhMax = disableFrhSuggestions ? currentFrh : Math.min(frh[frh.length-1], currentFrh + maxChange);
      const rrhMin = Math.max(rrh[0], currentRrh - maxChange);
      const rrhMax = Math.min(rrh[rrh.length-1], currentRrh + maxChange);
      
      // Test different combinations with 1mm precision for realistic adjustments
      const testPoints = [];
      for (let testFrh = frhMin; testFrh <= frhMax; testFrh += 1) {
        for (let testRrh = rrhMin; testRrh <= rrhMax; testRrh += 1) {
          if (testFrh === currentFrh && testRrh === currentRrh) continue;
          const testDrag = bilinearInterp(testFrh, testRrh, table);
          if (testDrag > currentDrag) { // Higher L/D is better (less drag)
            testPoints.push({
              frh: testFrh,
              rrh: testRrh,
              drag: testDrag,
              improvement: testDrag - currentDrag,
              frhChange: testFrh - currentFrh,
              rrhChange: testRrh - currentRrh
            });
          }
        }
      }
      
      // Sort by improvement (best first)
      testPoints.sort((a, b) => b.improvement - a.improvement);
      
      // Return top 5 recommendations
      return testPoints.slice(0, 5);
    }

    function formatRecommendation(rec, current) {
      const disableFrhSuggestions = document.getElementById('disableFrhSuggestions').checked;
      
      const frhAction = (!disableFrhSuggestions && rec.frhChange > 0) ? `Raise front by ${rec.frhChange}mm` : 
                       (!disableFrhSuggestions && rec.frhChange < 0) ? `Lower front by ${Math.abs(rec.frhChange)}mm` : '';
      const rrhAction = rec.rrhChange > 0 ? `Raise rear by ${rec.rrhChange}mm` : 
                       rec.rrhChange < 0 ? `Lower rear by ${Math.abs(rec.rrhChange)}mm` : '';
      
      let actionText = '';
      if (frhAction && rrhAction) {
        actionText = `${frhAction} and ${rrhAction}`;
      } else if (frhAction || rrhAction) {
        actionText = frhAction || rrhAction;
      } else if (disableFrhSuggestions) {
        actionText = 'Rear-only optimization (Front RH locked)';
      }
      
      const improvementPercent = ((rec.improvement / current) * 100).toFixed(1);
      
      return {
        action: actionText,
        newSettings: `FRH: ${rec.frh}mm, RRH: ${rec.rrh}mm`,
        newDrag: rec.drag.toFixed(3),
        improvement: `+${improvementPercent}% improvement`
      };
    }

    document.getElementById("refForm").addEventListener("submit", function(e){
      e.preventDefault();
      const wing = document.getElementById("wing").value;
      const frh = parseFloat(document.getElementById("frhInput").value);
      const rrh = parseFloat(document.getElementById("rrhInput").value);
      
      // Error handling
      if (!tables[wing]) {
        document.getElementById("result").textContent = `Error: No data available for Wing ${wing}`;
        document.getElementById("result").className = "text-center text-lg font-mono bg-neutral-900 p-4 rounded-lg border border-red-500 text-red-400";
        document.getElementById("recommendations").style.display = "none";
        return;
      }
      
      if (isNaN(frh) || isNaN(rrh)) {
        document.getElementById("result").textContent = "Error: Please enter valid numbers for FRH and RRH";
        document.getElementById("result").className = "text-center text-lg font-mono bg-neutral-900 p-4 rounded-lg border border-red-500 text-red-400";
        document.getElementById("recommendations").style.display = "none";
        return;
      }
      
      const val = bilinearInterp(frh, rrh, tables[wing]);
      document.getElementById("result").textContent = 
        `Wing ${wing} → FRH ${frh} mm, RRH ${rrh} mm → Drag (L/D): ${val.toFixed(3)}`;
      document.getElementById("result").className = "text-center text-lg font-mono bg-neutral-900 p-4 rounded-lg border border-neutral-700 text-green-400";
      
      // Find optimization recommendations
      const optimizations = findOptimizations(frh, rrh, val, tables[wing]);
      const recommendationsDiv = document.getElementById("recommendations");
      const resultsDiv = document.getElementById("optimizationResults");
      
      if (optimizations.length > 0) {
        let html = '<p class="text-blue-200 mb-4"><strong>To reduce drag (increase L/D ratio), try these adjustments:</strong></p>';
        
        optimizations.forEach((opt, index) => {
          const rec = formatRecommendation(opt, val);
          html += `
            <div class="mb-4 p-4 bg-neutral-800 border border-green-500/30 rounded-lg hover:bg-neutral-700 transition-colors duration-200">
              <div class="flex items-center mb-2">
                <span class="bg-green-500 text-white text-sm px-2 py-1 rounded-full mr-3">${index + 1}</span>
                <strong class="text-green-300">${rec.action}</strong>
              </div>
              <div class="text-neutral-400 text-sm mb-1">
                <i class="fas fa-cogs mr-2"></i>New settings: ${rec.newSettings}
              </div>
              <div class="text-green-400 font-bold">
                <i class="fas fa-arrow-up mr-2"></i>New L/D: ${rec.newDrag} (${rec.improvement})
              </div>
            </div>
          `;
        });
        
        resultsDiv.innerHTML = html;
        recommendationsDiv.style.display = "block";
      } else {
        resultsDiv.innerHTML = '<div class="text-center p-4 bg-neutral-800 rounded-lg border border-green-500/30"><i class="fas fa-check-circle text-green-400 text-2xl mb-2"></i><p class="text-green-300">Your current settings appear to be optimal within ±5mm range!</p></div>';
        recommendationsDiv.style.display = "block";
      }
      
      // Create drag visualization map
      createDragMap(wing, frh, rrh, val);
    });
    
    function createDragMap(selectedWing, currentFrh, currentRrh, currentDrag) {
      const table = tables[selectedWing];
      const {frh, rrh, ld} = table;
      
      // Create plotly surface plot
      const trace = {
        x: frh,
        y: rrh,
        z: ld,
        type: 'surface',
        colorscale: [
          [0, '#1a1a2e'],
          [0.25, '#16213e'],
          [0.5, '#0f3460'],
          [0.75, '#e94560'],
          [1, '#f39c12']
        ],
        showscale: true,
        colorbar: {
          title: 'L/D Ratio',
          titlefont: { color: '#e5e7eb' },
          tickfont: { color: '#e5e7eb' }
        }
      };
      
      // Add current position marker
      const currentPoint = {
        x: [currentFrh],
        y: [currentRrh],
        z: [currentDrag + 0.1], // Slightly above surface
        mode: 'markers',
        type: 'scatter3d',
        marker: {
          size: 10,
          color: 'red',
          symbol: 'circle'
        },
        name: 'Current Setting'
      };
      
      const layout = {
        title: {
          text: `Wing ${selectedWing} - Drag Map (L/D Ratio)`,
          font: { color: '#e5e7eb', size: 16 }
        },
        scene: {
          xaxis: {
            title: 'Front RH (mm)',
            titlefont: { color: '#e5e7eb' },
            tickfont: { color: '#e5e7eb' },
            gridcolor: '#374151'
          },
          yaxis: {
            title: 'Rear RH (mm)',
            titlefont: { color: '#e5e7eb' },
            tickfont: { color: '#e5e7eb' },
            gridcolor: '#374151'
          },
          zaxis: {
            title: 'L/D Ratio',
            titlefont: { color: '#e5e7eb' },
            tickfont: { color: '#e5e7eb' },
            gridcolor: '#374151'
          },
          bgcolor: '#1f2937'
        },
        paper_bgcolor: '#1f2937',
        plot_bgcolor: '#1f2937',
        font: { color: '#e5e7eb' }
      };
      
      const config = {
        displayModeBar: true,
        displaylogo: false,
        modeBarButtonsToRemove: ['pan2d', 'lasso2d']
      };
      
      Plotly.newPlot('plot', [trace, currentPoint], layout, config);
    }
  </script>
</body>
</html>
