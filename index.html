async function loadState() {
    const urlParams = new URLSearchParams(window.location.search);
    const strategyId = urlParams.get('id');

    if (strategyId) {
        try {
            const response = await fetch(`/api/strategies/${strategyId}`);
            
            if (!response.ok) {
                throw new Error('Failed to load strategy.');
            }

            // Check if the response has a body to parse
            const contentType = response.headers.get("content-type");
            let state;

            // Only parse as JSON if the content type is correct and it's not a 304
            if (response.status !== 304 && contentType && contentType.indexOf("application/json") !== -1) {
                state = await response.json();
            } else {
                // For a 304, the browser will use the cached data. 
                // We'll proceed without a new JSON body.
                console.log('Using cached strategy data.');
                // You may need to retrieve the cached state here if your app logic requires it.
                // For this scenario, we can assume the data from the initial page load is sufficient.
                // If not, you might need a different caching strategy on the server side.
                return;
            }

            // Restore selections
            selectedDrivers = [];
            state.drivers.forEach(driverName => {
                const driver = drivers.find(d => d.name === driverName);
                if (driver) selectedDrivers.push(driver);
            });
            renderDriverList();
            
            document.getElementById('car-select').value = state.car;
            document.getElementById('track-select').value = state.track;

            // Restore inputs on page 2
            document.getElementById('race-duration-hours').value = state.raceDurationHours;
            document.getElementById('race-duration-minutes').value = state.raceDurationMinutes;
            document.getElementById('avg-lap-time-minutes').value = state.avgLapTimeMinutes;
            document.getElementById('avg-lap-time-seconds').value = state.avg-lap-time-seconds;
            document.getElementById('pit-stop-time').value = state.pitStopTime;
            document.getElementById('fuel-per-lap-display-input').value = state.fuelPerLapInput;
            document.getElementById('tank-capacity-display-input').value = state.tankCapacityInput;
            
            document.getElementById('fuel-slider').value = state.fuelSlider;
            document.getElementById('lap-time-slider').value = state.lapTimeSlider;
            document.getElementById('race-start-time-page2').value = state.raceStartTime;
            document.getElementById('qualifying-minutes-page2').value = state.qualifyingMinutes;
            
            document.getElementById('fuel-slider-value').textContent = parseFloat(state.fuelSlider).toFixed(1);
            document.getElementById('lap-time-slider-value').textContent = state.lapTimeSlider;
            
            // Restore the timezone from the shared link
            document.getElementById('timezone-select').value = state.timezone || 'UTC';

            // Navigate to page 2 and calculate
            showPage2();
            calculateAndShowPage2();

        } catch (error) {
            console.error('Error loading strategy:', error);
            alert('Could not load strategy from the provided link.');
        }
    } else {
        // If no ID is in the URL, initialize the page as normal
        showPlannerPage();
    }
}
