<script>
    // Global state
    let drivers = [];
    let cars = [];
    let tracks = [];
    let selectedDrivers = [];
    let totalStints = 0;
    let raceDurationSeconds = 0;
    let lapsPerStint = 0;
    let lapsInLastStint = 0;
    
    // --- Dark Mode Switch Functions ---
    function toggleDarkMode() {
        const isDark = document.getElementById('darkModeSwitch').checked;
        if (isDark) {
            document.documentElement.classList.add('dark');
            localStorage.setItem('theme', 'dark');
        } else {
            document.documentElement.classList.remove('dark');
            localStorage.setItem('theme', 'light');
        }
    }

    function loadTheme() {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.documentElement.classList.add('dark');
            document.getElementById('darkModeSwitch').checked = true;
        }
    }

    // --- Timezone Helper Functions ---
    function populateTimezones() {
        const timezoneSelect = document.getElementById('timezone-select');
        const timezones = [
            'Europe/London', 'America/New_York', 'America/Los_Angeles', 'Australia/Sydney',
            'Asia/Tokyo', 'Asia/Dubai', 'Europe/Berlin', 'Europe/Paris', 'Etc/GMT+12',
            'Etc/GMT-12',
        ];
        timezones.forEach(tz => {
            const option = document.createElement('option');
            option.value = tz;
            option.textContent = tz.replace('_', ' ');
            timezoneSelect.appendChild(option);
        });
        timezoneSelect.value = Intl.DateTimeFormat().resolvedOptions().timeZone || 'Europe/London';
    }

    function convertTimezone(date, fromTz, toTz) {
        return new Date(date.toLocaleString('en-US', { timeZone: fromTz }));
    }

    // --- Stint Table and Calculation Functions ---
    function formatDuration(seconds) {
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = Math.floor(seconds % 60);
        return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    }

    function formatTime(date) {
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        return `${hours}:${minutes}`;
    }

    function populateStintTable(avgLapTimeInSeconds) {
        const tbody = document.getElementById('stint-table-body');
        tbody.innerHTML = '';
        
        const raceStartTimeInput = document.getElementById('race-start-time-page2').value;
        const qualifyingMinutesInput = parseInt(document.getElementById('qualifying-minutes-page2').value) || 0;
        const pitStopTime = parseInt(document.getElementById('pit-stop-time').value) || 0;
        const selectedTimezone = document.getElementById('timezone-select').value;
        const [hours, minutes] = raceStartTimeInput.split(':').map(Number);
        
        let raceDate = new Date();
        raceDate.setHours(hours, minutes, 0, 0);

        let currentTime = convertTimezone(raceDate, selectedTimezone, Intl.DateTimeFormat().resolvedOptions().timeZone);
        currentTime.setMinutes(currentTime.getMinutes() + qualifyingMinutesInput);

        let currentLap = 1;
        let driverIndex = 0;
        
        for (let i = 0; i < totalStints; i++) {
            const stintLaps = (i === totalStints - 1) && (lapsInLastStint !== 0) ? lapsInLastStint : lapsPerStint;
            if (stintLaps <= 0) break;

            const startTimeString = formatTime(currentTime);
            
            const stintDurationSeconds = stintLaps * avgLapTimeInSeconds;
            currentTime.setSeconds(currentTime.getSeconds() + stintDurationSeconds);

            const endTimeString = formatTime(currentTime);

            const startLap = currentLap;
            const endLap = startLap + stintLaps - 1;
            
            const driver = selectedDrivers[driverIndex];
            const nextDriver = selectedDrivers[(driverIndex + 1) % selectedDrivers.length];
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 border-r border-gray-300 dark:text-gray-100">${startTimeString}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 border-r border-gray-300 dark:text-gray-300">${endTimeString}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 border-r border-gray-300 dark:text-gray-300">${startLap}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 border-r border-gray-300 dark:text-gray-300">${endLap}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 border-r border-gray-300 dark:text-gray-300">${stintLaps}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 border-r border-gray-300 dark:text-gray-300">${driver.name}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${nextDriver.name}</td>
            `;
            tbody.appendChild(tr);

            currentLap = endLap + 1;
            driverIndex = (driverIndex + 1) % selectedDrivers.length;
            
            if (i < totalStints - 1) {
                currentTime.setSeconds(currentTime.getSeconds() + pitStopTime);
            }
        }
    }

    function calculateAndShowPage2() {
        const raceDurationHours = parseInt(document.getElementById('race-duration-hours').value) || 0;
        const raceDurationMinutes = parseInt(document.getElementById('race-duration-minutes').value) || 0;
        const avgLapTimeMinutes = parseInt(document.getElementById('avg-lap-time-minutes').value) || 0;
        const avgLapTimeSeconds = parseInt(document.getElementById('avg-lap-time-seconds').value) || 0;
        const pitStopTime = parseInt(document.getElementById('pit-stop-time').value) || 0;
        const fuelPerLap = parseFloat(document.getElementById('fuel-per-lap-display-input').value) || 0;
        const tankCapacity = parseFloat(document.getElementById('tank-capacity-display-input').value) || 0;
        const raceStartTime = document.getElementById('race-start-time-page2').value;
        const qualifyingMinutes = document.getElementById('qualifying-minutes-page2').value;

        if (raceDurationHours === 0 && raceDurationMinutes === 0 || avgLapTimeMinutes === 0 && avgLapTimeSeconds === 0 || fuelPerLap <= 0 || tankCapacity <= 0 || !raceStartTime || !qualifyingMinutes) {
            alert("Please ensure all race inputs are filled and valid before calculating.");
            return;
        }

        const raceDurationSeconds = (raceDurationHours * 3600) + (raceDurationMinutes * 60);
        let avgLapTimeInSeconds = (avgLapTimeMinutes * 60) + avgLapTimeSeconds;

        const fuelSliderAdjustment = parseFloat(document.getElementById('fuel-slider').value) || 0;
        const lapTimeSliderAdjustment = parseInt(document.getElementById('lap-time-slider').value) || 0;
        
        let currentFuelPerLap = fuelPerLap + fuelSliderAdjustment;
        avgLapTimeInSeconds += lapTimeSliderAdjustment;

        const lapsPerTank = Math.floor(tankCapacity / currentFuelPerLap);
        const totalLaps = Math.floor(raceDurationSeconds / avgLapTimeInSeconds);
        const stintDuration = lapsPerTank * avgLapTimeInSeconds;
        
        totalStints = Math.floor(totalLaps / lapsPerTank) + (totalLaps % lapsPerTank > 0 ? 1 : 0);
        lapsPerStint = lapsPerTank;
        lapsInLastStint = totalLaps % lapsPerStint;
        
        document.getElementById('est-laps-display').textContent = totalLaps;
        document.getElementById('stint-duration-display').textContent = formatDuration(stintDuration);
        document.getElementById('laps-per-stint-display').textContent = lapsPerStint;
        document.getElementById('total-stints-display').textContent = totalStints;
        
        populateStintTable(avgLapTimeInSeconds);
    }
    
    // --- Page Navigation Functions ---
    function showPlannerPage() {
        document.getElementById('page1').classList.remove('hidden');
        document.getElementById('page2').classList.add('hidden');
    }

    function showPage2() {
        document.getElementById('page1').classList.add('hidden');
        document.getElementById('page2').classList.remove('hidden');
    }
    
    // --- Driver Selection Functions ---
    function toggleDriver(driverId) {
        const driver = drivers.find(d => d.id === driverId);
        if (!driver) return;
        const index = selectedDrivers.findIndex(d => d.id === driverId);
        if (index > -1) {
            selectedDrivers.splice(index, 1);
        } else {
            selectedDrivers.push(driver);
        }
        renderDriverList();
    }
    
    function renderDriverList() {
        const driverListDiv = document.getElementById('driver-list');
        driverListDiv.innerHTML = '';
        drivers.forEach(driver => {
            const isSelected = selectedDrivers.some(d => d.id === driver.id);
            const driverButton = document.createElement('button');
            driverButton.textContent = driver.name;
            driverButton.className = `px-4 py-2 rounded-full text-sm font-medium transition-colors ${isSelected ? 'bg-indigo-600 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200'}`;
            driverButton.onclick = () => toggleDriver(driver.id);
            driverListDiv.appendChild(driverButton);
        });
    }

    // --- Dropdown Population Functions ---
    function populateDrivers() {
        renderDriverList();
    }

    function populateCars() {
        const carSelect = document.getElementById('car-select');
        carSelect.innerHTML = '';
        cars.forEach(car => {
            const option = document.createElement('option');
            option.value = car.name;
            option.textContent = car.name;
            carSelect.appendChild(option);
        });
    }

    function populateTracks() {
        const trackSelect = document.getElementById('track-select');
        trackSelect.innerHTML = '';
        tracks.forEach(track => {
            const option = document.createElement('option');
            option.value = track.name;
            option.textContent = track.name;
            trackSelect.appendChild(option);
        });
    }

    // --- Shared Link Functions ---
    async function generateShareLink() {
        const state = {
            drivers: selectedDrivers.map(d => d.name),
            car: document.getElementById('car-select').value,
            track: document.getElementById('track-select').value,
            timezone: document.getElementById('timezone-select').value,
            raceDurationHours: document.getElementById('race-duration-hours').value,
            raceDurationMinutes: document.getElementById('race-duration-minutes').value,
            avgLapTimeMinutes: document.getElementById('avg-lap-time-minutes').value,
            avgLapTimeSeconds: document.getElementById('avg-lap-time-seconds').value,
            pitStopTime: document.getElementById('pit-stop-time').value,
            fuelPerLapInput: document.getElementById('fuel-per-lap-display-input').value,
            tankCapacityInput: document.getElementById('tank-capacity-display-input').value,
            fuelSlider: document.getElementById('fuel-slider').value,
            lapTimeSlider: document.getElementById('lap-time-slider').value,
            raceStartTime: document.getElementById('race-start-time-page2').value,
            qualifyingMinutes: document.getElementById('qualifying-minutes-page2').value,
        };

        try {
            const response = await fetch('/api/strategies', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(state),
            });

            if (!response.ok) {
                throw new Error('Failed to save strategy.');
            }

            const data = await response.json();
            const shareLink = `${window.location.origin}${window.location.pathname}?id=${data.id}`;
            document.getElementById('share-link-output').value = shareLink;

        } catch (error) {
            console.error('Error saving strategy:', error);
            alert('Could not save strategy. Please try again.');
        }
    }

    function loadState(state) {
        selectedDrivers = [];
        state.drivers.forEach(driverName => {
            const driver = drivers.find(d => d.name === driverName);
            if (driver) selectedDrivers.push(driver);
        });
        renderDriverList();
        
        document.getElementById('car-select').value = state.car;
        document.getElementById('track-select').value = state.track;
        document.getElementById('timezone-select').value = state.timezone;

        document.getElementById('race-duration-hours').value = state.raceDurationHours;
        document.getElementById('race-duration-minutes').value = state.raceDurationMinutes;
        document.getElementById('avg-lap-time-minutes').value = state.avgLapTimeMinutes;
        document.getElementById('avg-lap-time-seconds').value = state.avgLapTimeSeconds;
        document.getElementById('pit-stop-time').value = state.pitStopTime;
        document.getElementById('fuel-per-lap-display-input').value = state.fuelPerLapInput;
        document.getElementById('tank-capacity-display-input').value = state.tankCapacityInput;
        
        document.getElementById('fuel-slider').value = state.fuelSlider;
        document.getElementById('lap-time-slider').value = state.lapTimeSlider;
        document.getElementById('race-start-time-page2').value = state.raceStartTime;
        document.getElementById('qualifying-minutes-page2').value = state.qualifyingMinutes;
        
        document.getElementById('fuel-slider-value').textContent = parseFloat(state.fuelSlider).toFixed(1);
        document.getElementById('lap-time-slider-value').textContent = state.lapTimeSlider;

        showPage2();
        calculateAndShowPage2();
    }
    
    // --- Page Load Logic ---
    async function fetchDataAndPopulate() {
        try {
            const response = await fetch('/api/data');
            const data = await response.json();
            drivers = data.drivers;
            cars = data.cars;
            tracks = data.tracks;
            
            populateDrivers();
            populateCars();
            populateTracks();
            populateTimezones();

            const urlParams = new URLSearchParams(window.location.search);
            const strategyId = urlParams.get('id');

            if (strategyId) {
                const strategyResponse = await fetch(`/api/strategies/${strategyId}`);
                if (!strategyResponse.ok) {
                    throw new Error('Failed to load shared strategy.');
                }
                const state = await strategyResponse.json();
                loadState(state);
            } else {
                showPlannerPage();
            }

        } catch (error) {
            console.error('Failed to fetch data or load strategy:', error);
            alert('Could not load data from the server. Please check the server status.');
        }
    }

    document.addEventListener('DOMContentLoaded', (event) => {
        loadTheme();
        document.getElementById('darkModeSwitch').addEventListener('change', toggleDarkMode);
        
        document.getElementById('calculate-btn').addEventListener('click', calculateAndShowPage2);

        fetchDataAndPopulate();

        const fuelSlider = document.getElementById('fuel-slider');
        const fuelSliderValue = document.getElementById('fuel-slider-value');
        const lapTimeSlider = document.getElementById('lap-time-slider');
        const lapTimeSliderValue = document.getElementById('lap-time-slider-value');

        if (fuelSlider) {
            fuelSlider.addEventListener('input', () => {
                fuelSliderValue.textContent = parseFloat(fuelSlider.value).toFixed(1);
                calculateAndShowPage2();
            });
        }
        if (lapTimeSlider) {
            lapTimeSlider.addEventListener('input', () => {
                lapTimeSliderValue.textContent = lapTimeSlider.value;
                calculateAndShowPage2();
            });
        }
    });
</script>
