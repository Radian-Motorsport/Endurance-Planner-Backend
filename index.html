<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Road+Rage&display=swap" rel="stylesheet">
    <script>
  		tailwind.config = {
    		darkMode: 'class'
 		}
	</script>
	<script src="https://cdn.tailwindcss.com"></script>
	<style>
        body {
   			 font-family: 'Inter', sans-serif;
  			  transition: background-color 0.5s, color 0.5s;
		}
		body {
   			 background-color: #808080;
		}
        h1 {
            font-family: 'RoadRage', sans-serif;
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }

        /* Dark Mode Switch CSS */
        .toggle-switch-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 100;
        }
        .toggle-label {
            width: 50px;
            height: 26px;
            background-color: #ccc;
            display: block;
            border-radius: 9999px;
            position: relative;
            cursor: pointer;
            transition: background-color 0.4s;
        }
        .toggle-label:after {
            content: '';
            width: 20px;
            height: 20px;
            background-color: white;
            border-radius: 9999px;
            position: absolute;
            top: 3px;
            left: 3px;
            transition: all 0.4s;
        }
        input:checked + .toggle-label {
            background-color: #2196F3;
        }
        input:checked + .toggle-label:after {
            left: calc(100% - 3px);
            transform: translateX(-100%);
        }
		select, option, input, number, li {
    		color: #000000; /* Black text */
			background-color: #FFFFFF;
		}
        #darkModeSwitch {
            display: none;
        }

        /* --- Dark Mode Color Overrides --- */
    
        .dark .max-w-4xl {
            background-color: #1e1e1e;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.25);
        }
        .dark h1, .dark h2, .dark h3, .dark .text-gray-800 {
            color: #ffffff;
        }
        .dark p, .dark label, .dark .text-gray-600, .dark .text-gray-700 {
            color: #a0a0a0;
        }
        .dark .bg-white {
            background-color: #1e1e1e;
        }
        .dark .bg-gray-50, .dark .bg-gray-200 {
            background-color: #2a2a2a;
            border-color: #333333;
        }
        .dark .bg-gray-300 {
            background-color: #a0a0a0;
            color: #1e1e1e;
        }
        .dark .bg-blue-600 { background-color: #2b6cb0; }
        .dark .bg-purple-600 { background-color: #6b46c1; }
        .dark .bg-green-600 { background-color: #2f855a; }
        .dark .bg-blue-50, .dark .bg-blue-100 { background-color: #2a4365; border-color: #2c5282; }
        .dark .text-blue-800 { color: #90cdf4; }
        .dark .bg-purple-100 { background-color: #44337a; border-color: #553c9a; }
        .dark .text-purple-800 { color: #d6bcfa; }
        .dark .border-gray-200, .dark .border-gray-300 { border-color: #4a4a4a; }
		.dark .text-gray-900 { color: #ffffff; }
        
        .dark select, .dark input, .dark textarea, .dark li {
		    background-color: #2a2a2a;
		    font-weight: bold;
		    border-color: #4a4a4a;
		}
		.dark option, .dark number {
		 	background-color: #2a2a2a;
			color: #ffffff;
		}
		.dark li {
		    background-color: #2a2a2a;
		    color: #ffffff;
		}


             @font-face {
    font-family: 'RoadRage';
    src: url('https://radian-motorsport.github.io/Endurance-Planner-Backend/RoadRage.woff') format('woff');
    font-weight: normal;
    font-style: normal;
}
        .road-rage-font {
            font-family: 'RoadRage', sans-serif;
        }
        select {
            max-width: 100%;
            box-sizing: border-box;
        }
        /* Custom Styles for Live Planner */
        .live-planner-controls {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .live-planner-controls label {
            display: block;
            font-size: 0.9em;
            text-align: left;
            margin-bottom: 2px;
        }
        .live-planner-controls div {
            min-width: 150px;
        }
        .live-planner-info p { margin: 5px 0; }
        #countdown-timer { font-size: 1.5em; font-weight: bold; color: green; }
        .dark #countdown-timer { color: #48bb78; }
        .dark #live-stint-table th { background-color: #333333; color: #a0a0a0; }
        .dark #live-stint-table td { background-color: #1e1e1e; border-color: #4a4a4a; }
    </style>
</head>
<body class="p-4 md:p-8 bg-white text-black dark:bg-[#121212] dark:text-white">
    <div class="toggle-switch-container">
        <input type="checkbox" id="darkModeSwitch">
        <label for="darkModeSwitch" class="toggle-label"></label>
    </div>

    <div class="max-w-4xl mx-auto bg-white p-6 md:p-10 rounded-xl shadow-lg transition-colors duration-500">
        <div class="text-center mb-6">
            <img src="https://github.com/Radian-Motorsport/Endurance-Planner-Backend/blob/main/g457912.png?raw=true" alt="?" class="mx-auto w-100  h-auto">
        </div>
        <p class="text-center text-gray-600 mb-8"></p>

        <div id="app-container">
            <div class="flex justify-center space-x-4 mb-8">
                <button id="race-details-btn" onclick="showPlannerPage()" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105 flex items-center space-x-2">
                    <i class="fas fa-car-side"></i> <span>Race Details</span>
                </button>
                <button id="admin-btn" onclick="showAdminPage()" class="bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105 flex items-center space-x-2">
                    <i class="fas fa-user-shield"></i> <span>Admin</span>
                </button>
            </div>
            
            <div id="planner-page" class="">
                    <div class="p-6 bg-gray-50 border border-gray-200 rounded-lg">
                    <h3 class="text-xl font- mb-4 text-gray-800 road-rage-font">Drivers <span class="text-sm text-gray-500"></span></h3>
                    <div class="flex items-center space-x-2 mb-4">
                        <select id="driver-select" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 w-full text-black">
                            <option value="">Select a Driver...</option>
                        </select>
                        <button onclick="addDriver()" class="bg-purple-600 hover:bg-purple-700 font- mb-4 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                    <ul id="driver-list" class="space-y-2"></ul>
                </div>

                                <div class="p-6 bg-gray-50 border border-gray-200 rounded-lg mt-6">
                    <h3 class="text-xl font- mb-4 text-gray-800 road-rage-font">Track & Car</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full">
                        <div class="flex flex-col w-full">
                            <select id="track-select" class="mt-1 p-3 border border-gray-300 rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 text-black">
                                <option value="">Select a Track...</option>
                            </select>
                        </div>
                        <div class="flex flex-col w-full">
                            <select id="car-select" class="mt-1 p-3 border border-gray-300 rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 text-black">
                                <option value="">Select a Car...</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="mt-8">
                    <button onclick="showPage2()" id="continue-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105">
                        Calculate <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <div id="page-2" class="space-y-6 hidden">
                <div class="flex items-center space-x-4 mb-6">
                    <button onclick="showPlannerPage()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105">
                        <i class="fas fa-arrow-left mr-2"></i> Back
                    </button>
                </div>

                <div class="p-6 bg-blue-50 border border-blue-200 rounded-lg">
                    <div class="grid md:grid-cols-3 gap-4">
                        <div>
                            <span class="text-blue-800 road-rage-font">TRACK:</span>
                            <span id="page2-track" class="text-black"></span>
                        </div>
                        <div>
                            <span class="text-blue-800 road-rage-font">CAR:</span>
                            <span id="page2-car" class="text-black"></span>
                        </div>
                        <div>
                            <span class="text-blue-800 road-rage-font">DRIVERS:</span>
                            <span id="page2-drivers" class="text-black"></span>
                        </div>
                    </div>
                </div>

                <div id="race-inputs-container" class="p-6 bg-gray-50 border border-gray-200 rounded-lg">
                    <h3 class="text-xl font- mb-4 text-gray-800 road-rage-font">Race Inputs</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="flex flex-col">
                            <label class="text-sm font-medium text-gray-700">Race Duration</label>
                            <div class="flex items-center mt-1 space-x-2">
                                <input type="number" id="race-duration-hours" placeholder="Hours" class="p-2 border border-gray-300 rounded-lg text-gray-800 bg-white w-20 text-center focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                                <span class="text-gray-600">h</span>
                                <input type="number" id="race-duration-minutes" placeholder="Minutes" class="p-2 border border-gray-300 rounded-lg text-gray-800 bg-white w-20 text-center focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                                <span class="text-gray-600">m</span>
                            </div>
                        </div>
                        <div class="flex flex-col">
                            <label class="text-sm font-medium text-gray-700">Avg. Lap Time</label>
                            <div class="flex items-center mt-1 space-x-2">
                                <input type="number" id="avg-lap-time-minutes" placeholder="Minutes" class="p-2 border border-gray-300 rounded-lg text-gray-800 bg-white w-20 text-center focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                                <span class="text-gray-600">min</span>
                                <input type="number" id="avg-lap-time-seconds" placeholder="Seconds" class="p-3 border border-gray-300 rounded-lg text-gray-800 bg-white w-20 text-center focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                                <span class="text-gray-600">sec</span>
                            </div>
                        </div>
                        <div class="flex flex-col">
                            <label for="pit-stop-time" class="text-sm font-medium text-gray-700">Avg. Pit Stop Time (sec)</label>
                            <input type="number" id="pit-stop-time" value="30" class="mt-1 p-2 border border-gray-300 rounded-lg text-gray-800 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                        </div>
                        <div class="flex flex-col">
                            <label for="fuel-per-lap-display-input" class="text-sm font-medium text-gray-700">Fuel Use per Lap (L)</label>
                            <input type="number" id="fuel-per-lap-display-input" class="mt-1 p-2 border border-gray-300 rounded-lg text-gray-800 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                        </div>
                        <div class="flex flex-col">
                            <label for="tank-capacity-display-input" class="text-sm font-medium text-gray-700">Fuel Tank Size (L)</label>
                            <input type="number" id="tank-capacity-display-input" class="mt-1 p-2 border border-gray-300 rounded-lg text-gray-800 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                        </div>
                    </div>
                    <div class="mt-4 flex justify-end">
                        <button id="calculate-page2-button" onclick="calculateAndShowPage2()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200 transform hover:scale-105">
                            Calculate
                        </button>
                    </div>
                </div>

                <div id="overall-summary" class="p-6 bg-blue-100 border border-blue-200 rounded-lg hidden">
                    <h3 class="text-xl font- mb-4 text-blue-800 road-rage-font">Overall Strategy Summary</h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 text-blue-800">
                        <div><span class="font-semibold">Est. Laps:</span> <span id="est-laps-display"></span></div>
                        <div><span class="font-semibold">Stint Duration:</span> <span id="stint-duration-display"></span></div>
                        <div><span class="font-semibold">Laps per Stint:</span> <span id="laps-per-stint-display"></span></div>
                        <div><span class="font-semibold">Pit Stops:</span> <span id="pit-stops-display"></span></div>
                        <div><span class="font-semibold">Total Fuel:</span> <span id="total-fuel-display"></span></div>
                        <div><span class="font-semibold">Fuel per Lap:</span> <span id="fuel-per-lap-display"></span></div>
                        <div><span class="font-semibold">Lap Time:</span> <span id="lap-time-display"></span></div>
                        <div><span class="font-semibold">Pit Stop Duration:</span> <span id="pit-stop-duration-display"></span></div>
                    </div>
                </div>

                <div id="sliders-container" class="p-6 bg-gray-50 border border-gray-200 rounded-lg hidden">
                    <h3 class="text-xl font- mb-4 text-gray-800 road-rage-font">Dynamic Adjustments</h3>
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-4 sm:space-y-0 sm:space-x-4">
                        <div class="flex-grow w-full">
                            <label for="fuel-slider" class="text-sm font-medium text-gray-700">Adjust Fuel per Lap</label>
                            <div class="flex items-center mt-1 space-x-2">
                                <input type="range" id="fuel-slider" min="-1.0" max="1.0" value="0" step="0.1" class="w-full">
                                <span id="fuel-slider-value" class="text-gray-900 font-mono text-sm w-12 text-right">0.0</span>
                            </div>
                        </div>
                        <div class="flex-grow w-full">
                            <label for="lap-time-slider" class="text-sm font-medium text-gray-700">Adjust Lap Time</label>
                            <div class="flex items-center mt-1 space-x-2">
                                <input type="range" id="lap-time-slider" min="-3" max="3" value="0" step="0.1" class="w-full">
                                <span id="lap-time-slider-value" class="text-gray-900 font-mono text-sm w-12 text-right">0</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                  
                <div id="stint-breakdown-display" class="p-6 bg-gray-50 border border-gray-200 rounded-lg overflow-x-auto hidden">
                    
                            <div class="flex flex-col mb-4">
                            <label class="text-sm font-medium text-gray-700">Race Start (UTC) & Qualifying</label>
                            <div class="flex items-center space-x-2">
                                <input type="time" id="race-start-time-page2" value="13:00" class="mt-1 p-3 border border-gray-300 rounded-lg text-gray-800 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                                <span class="text-gray-700 font-bold">+</span>
                                <input type="number" id="qualifying-minutes-page2" min="0" max="59" value="0" class="mt-1 p-3 border border-gray-300 rounded-lg text-gray-800 bg-white w-20 text-center focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                                <span class="text-sm font-medium text-gray-700">min (Qualifying)</span>
                            </div>
                            <div class="mt-4">
                                <label for="timezone-select" class="text-sm font-medium text-gray-700">Display Time Zone</label>
                                <select id="timezone-select" class="mt-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 w-full text-black">
                                    <option value="UTC">UTC</option>
                                    <option value="US/Samoa">SST (GMT-11)</option>
                                    <option value="America/Adak">HAST (GMT-10)</option>
                                    <option value="America/Los_Angeles">PST (GMT-8)</option>
                                    <option value="America/Denver">MST (GMT-7)</option>
                                    <option value="America/Chicago">CST (GMT-6)</option>
                                    <option value="America/New_York">EST (GMT-5)</option>
                                    <option value="America/Halifax">AST (GMT-4)</option>
                                    <option value="America/Sao_Paulo">BRT (GMT-3)</option>
                                    <option value="Atlantic/Azores">AZOT (GMT-1)</option>
                                    <option value="Europe/London" selected>GMT</option>
                                    <option value="Europe/Paris">CET (GMT+1)</option>
                                    <option value="Europe/Athens">EET (GMT+2)</option>
                                    <option value="Asia/Riyadh">AST (GMT+3)</option>
                                    <option value="Asia/Dubai">GST (GMT+4)</option>
                                    <option value="Asia/Karachi">PKT (GMT+5)</option>
                                    <option value="Asia/Kolkata">IST (GMT+5:30)</option>
                                    <option value="Asia/Bangkok">ICT (GMT+7)</option>
                                    <option value="Asia/Shanghai">CST (GMT+8)</option>
                                    <option value="Asia/Tokyo">JST (GMT+9)</option>
                                    <option value="Australia/Sydney">AEST (GMT+10)</option>
                                    <option value="Pacific/Auckland">NZST (GMT+12)</option>
                                </select>
                            </div>
                                    <button id="recalculate-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200 transform hover:scale-105 mt-4" onclick="calculateAndShowPage2()">Update</button>
                        </div>
                    
                    <table class= "min-w-full divide-y divide-gray-200 border border-gray-300 rounded-lg">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="w-20 px-1 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider border-r border-gray-300">Start Time</th>
                                <th class="w-20 px-1 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider border-r border-gray-300">End Time</th>
                                <th class="w-20 px-1 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider border-r border-gray-300">Start Lap</th>
                                <th class="w-20 px-1 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider border-r border-gray-300">End Lap</th>
                                <th class="w-20 px-1 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider border-r border-gray-300">Laps per Stint</th>
								<th class="w-20 px-1 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider border-r border-gray-300">Driver</th>
								<th class="w-20 px-1 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider border-r border-gray-300">Backup</th>
                            </tr>
                        </thead>
                        <tbody id="stint-table-body" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>

                <div id="share-link-container" class="p-6 bg-purple-100 border border-purple-200 rounded-lg hidden">
                    <h3 class="text-xl font- mb-4 text-purple-800 road-rage-font">Share/Save This Strategy</h3>
                    <div class="flex items-center space-x-2">
                        <button onclick="generateShareLink()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105">
                            <i class="fas fa-share-alt mr-2"></i> Generate Link
                        </button>
                        <input type="text" id="share-link-output" readonly class="flex-grow w-full p-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-700 cursor-copy" placeholder="Click 'Generate Link' to create a shareable URL">
                        <button onclick="copyShareLink()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105">
                            <i class="fas fa-copy"></i>
                        </button>
                         </div>
                        </div>
                    </div>
                <div class="mt-8 hidden" id="page3-button-container">
                    <button onclick="showPage3()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105">
                        Go to Live Stint Planner <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
                <div id="page-3" class="hidden space-y-6">
                    <div class="flex items-center space-x-4 mb-6">
                        <button onclick="showPage2()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105">
                            <i class="fas fa-arrow-left mr-2"></i> Back
                        </button>
                    </div>
                    <div class="p-6 bg-green-100 border border-green-200 rounded-lg">
                        <h3 class="text-xl font- mb-4 text-green-800 road-rage-font">Live Stint Planner</h3>
                        <div class="live-planner-controls">
                            <div>
                                <label for="live-race-duration">Total Race Duration (min):</label>
                                <input type="number" id="live-race-duration" value="180" class="mt-1 p-2 border border-gray-300 rounded-lg text-gray-800 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                            </div>
                            <div>
                                <label for="live-time-remaining">Manual Start Time (min):</label>
                                <input type="number" id="live-time-remaining" placeholder="e.g. 120" value="180" class="mt-1 p-2 border border-gray-300 rounded-lg text-gray-800 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                            </div>
                            <div>
                                <label for="live-lap-time-slider">Avg Lap Time (sec): <span id="live-lap-time-value">90</span></label>
                                <input type="range" id="live-lap-time-slider" min="60" max="150" value="90" oninput="updateLiveLapTime(this.value)">
                            </div>
                            <div>
                                <label for="live-fuel-tank-size">Fuel Tank Size (L):</label>
                                <input type="number" id="live-fuel-tank-size" value="90" class="mt-1 p-2 border border-gray-300 rounded-lg text-gray-800 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                            </div>
                            <div>
                                <label for="live-fuel-use-per-lap-slider">Fuel Use (L/lap): <span id="live-fuel-use-per-lap-value">2.5</span></label>
                                <input type="range" id="live-fuel-use-per-lap-slider" min="1" max="5" step="0.1" value="2.5" oninput="updateLiveFuelUse(this.value)">
                            </div>
                            <div>
                                <label for="live-time-deduction">Deduct Time (min):</label>
                                <input type="number" id="live-time-deduction" value="20" class="mt-1 p-2 border border-gray-300 rounded-lg text-gray-800 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                            </div>
                            <button id="live-start-stop-button" onclick="toggleRace()" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105">Start Race</button>
                            <button id="live-deduct-time-button" onclick="deductTime()" class="bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105" disabled>Deduct Time</button>
                            <button id="live-pit-exit-button" onclick="simulatePitExit()" class="bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105" disabled>Simulate Pit Exit</button>
                        </div>
                        <p class="text-green-800">Time Remaining: <span id="countdown-timer">00:00:00</span></p>
                        <p class="text-green-800">Approx. Time to Next Pitstop: <span id="next-pitstop-time">00:00:00</span></p>

                        <table id="live-stint-table" class="min-w-full divide-y divide-gray-200 border border-gray-300 rounded-lg mt-6">
                            <thead class="bg-gray-200">
                                <tr>
                                    <th class="px-1 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider border-r border-gray-300">Stint</th>
                                    <th class="px-1 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider border-r border-gray-300">Start Time</th>
                                    <th class="px-1 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider border-r border-gray-300">End Time</th>
                                    <th class="px-1 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider border-r border-gray-300">Stint Duration</th>
                                    <th class="px-1 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider border-r border-gray-300">Stint Laps</th>
                                    <th class="px-1 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider border-r border-gray-300">Fuel Per Stint (L)</th>
                                    <th class="px-1 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider border-r border-gray-300">Driver</th>
                                </tr>
                            </thead>
                            <tbody id="live-stint-table-body" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="admin-page" class="hidden">
                    <button onclick="saveDataToServer()" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105">
                        Save All Changes
                    </button>
                    <div class="p-6 bg-gray-50 border border-gray-200 rounded-lg mt-6">
                        <h3 class="text-xl font- mb-4 text-gray-800 road-rage-font">Manage Drivers</h3>
                        <div class="space-y-4">
                            <div class="flex flex-col md:flex-row md:items-end md:space-x-4 space-y-4 md:space-y-0">
                                <div class="flex-grow">
                                    <input type="text" id="new-driver-name" class="mt-1 p-3 border border-gray-300 rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="new-driver-number" class="text-sm font-medium text-gray-700">Driver Number</label>
                                    <input type="number" id="new-driver-number" class="mt-1 p-3 border border-gray-300 rounded-lg w-28 text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <button id="add-driver-btn" onclick="addDriverAdmin()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105">
                                    Add Driver
                                </button>
                            </div>
                            <ul id="admin-driver-list" class="space-y-2 mt-4"></ul>
                        </div>
                    </div>
                    <div class="p-6 bg-gray-50 border border-gray-200 rounded-lg mt-6">
                        <h3 class="text-xl font- mb-4 text-gray-800 road-rage-font">Manage Cars</h3>
                        <div class="space-y-4">
                            <div class="flex flex-col md:flex-row md:items-end md:space-x-4 space-y-4 md:space-y-0">
                                <div class="flex-grow">
                                    <input type="text" id="new-car-name" class="mt-1 p-3 border border-gray-300 rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <button id="add-car-btn" onclick="addCarAdmin()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105">
                                    Add Car
                                </button>
                            </div>
                            <ul id="admin-car-list" class="space-y-2 mt-4"></ul>
                        </div>
                    </div>
                    <div class="p-6 bg-gray-50 border border-gray-200 rounded-lg mt-6">
                        <h3 class="text-xl font- mb-4 text-gray-800 road-rage-font">Manage Tracks</h3>
                        <div class="space-y-4">
                            <div class="flex flex-col md:flex-row md:items-end md:space-x-4 space-y-4 md:space-y-0">
                                <div class="flex-grow">
                                    <input type="text" id="new-track-name" class="mt-1 p-3 border border-gray-300 rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div class="flex-grow">
                                    <input type="text" id="new-track-lap-time" placeholder="Avg. Lap Time (s)" class="mt-1 p-3 border border-gray-300 rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <button id="add-track-btn" onclick="addTrackAdmin()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105">
                                    Add Track
                                </button>
                            </div>
                            <ul id="admin-track-list" class="space-y-2 mt-4"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const drivers = JSON.parse(localStorage.getItem('drivers')) || [];
            const tracks = JSON.parse(localStorage.getItem('tracks')) || [];
            const cars = JSON.parse(localStorage.getItem('cars')) || [];
            const selectedDrivers = JSON.parse(localStorage.getItem('selectedDrivers')) || [];
            let currentStintIndex = 0;
            let raceDurationSeconds;
            let stintDurationSeconds;
            let lapsPerStint;
            let lapsInLastStint;

            const updateDarkMode = (isDark) => {
                if (isDark) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            };
            
            // Check for saved dark mode preference
            const savedDarkMode = localStorage.getItem('darkMode') === 'true';
            document.getElementById('darkModeSwitch').checked = savedDarkMode;
            updateDarkMode(savedDarkMode);

            document.getElementById('darkModeSwitch').addEventListener('change', (event) => {
                updateDarkMode(event.target.checked);
                localStorage.setItem('darkMode', event.target.checked);
            });

            // Function to show Page 1 (Planner Page)
            function showPlannerPage() {
                document.getElementById('planner-page').classList.remove('hidden');
                document.getElementById('page-2').classList.add('hidden');
                document.getElementById('page-3').classList.add('hidden');
                document.getElementById('admin-page').classList.add('hidden');
                 // Update button styles
                document.getElementById('race-details-btn').classList.remove('bg-gray-300', 'text-gray-800');
                document.getElementById('race-details-btn').classList.add('bg-blue-600', 'text-white');
                document.getElementById('admin-btn').classList.remove('bg-blue-600', 'text-white');
                document.getElementById('admin-btn').classList.add('bg-gray-300', 'text-gray-800');
            }
            window.showPlannerPage = showPlannerPage;
            // Function to show Admin Page
            function showAdminPage() {
                document.getElementById('planner-page').classList.add('hidden');
                document.getElementById('page-2').classList.add('hidden');
                document.getElementById('page-3').classList.add('hidden');
                document.getElementById('admin-page').classList.remove('hidden');
                // Update button styles
                document.getElementById('race-details-btn').classList.remove('bg-blue-600', 'text-white');
                document.getElementById('race-details-btn').classList.add('bg-gray-300', 'text-gray-800');
                document.getElementById('admin-btn').classList.remove('bg-gray-300', 'text-gray-800');
                document.getElementById('admin-btn').classList.add('bg-blue-600', 'text-white');
                renderAdminDrivers();
                renderAdminCars();
                renderAdminTracks();
            }
            window.showAdminPage = showAdminPage;
            // Function to show Page 2 (Calculations Page)
            function showPage2() {
                // Check if a track, car, and at least one driver are selected
                if (!document.getElementById('track-select').value || !document.getElementById('car-select').value || selectedDrivers.length === 0) {
                    alert('Please select a track, a car, and at least one driver first.');
                    return;
                }
                document.getElementById('planner-page').classList.add('hidden');
                document.getElementById('page-2').classList.remove('hidden');
                document.getElementById('page-3').classList.add('hidden');
                document.getElementById('admin-page').classList.add('hidden');
                // Populate summary info
                document.getElementById('page2-track').textContent = tracks.find(t => t.id === document.getElementById('track-select').value)?.name;
                document.getElementById('page2-car').textContent = cars.find(c => c.id === document.getElementById('car-select').value)?.name;
                document.getElementById('page2-drivers').textContent = selectedDrivers.map(id => drivers.find(d => d.id === id)?.name).join(', ');
            }
            window.showPage2 = showPage2;
            function showPage3() {
                // Check if a track, car, and at least one driver are selected
                if (!document.getElementById('track-select').value || !document.getElementById('car-select').value || selectedDrivers.length === 0) {
                    alert('Please select a track, a car, and at least one driver first.');
                    return;
                }
                // Check if the race duration inputs are filled
                const raceHours = parseInt(document.getElementById('race-duration-hours').value) || 0;
                const raceMinutes = parseInt(document.getElementById('race-duration-minutes').value) || 0;
                if (raceHours === 0 && raceMinutes === 0) {
                    alert('Please enter a race duration on the previous page.');
                    return;
                }
                document.getElementById('planner-page').classList.add('hidden');
                document.getElementById('page-2').classList.add('hidden');
                document.getElementById('page-3').classList.remove('hidden');
                document.getElementById('admin-page').classList.add('hidden');

                // Populate the live planner with the calculated values from page 2
                document.getElementById('live-fuel-tank-size').value = document.getElementById('tank-capacity-display-input').value;
                document.getElementById('live-fuel-use-per-lap-slider').value = document.getElementById('fuel-per-lap-display-input').value;
                document.getElementById('live-fuel-use-per-lap-value').textContent = document.getElementById('fuel-per-lap-display-input').value;

                const avgLapTimeInSeconds = (parseInt(document.getElementById('avg-lap-time-minutes').value) * 60) + parseInt(document.getElementById('avg-lap-time-seconds').value);
                document.getElementById('live-lap-time-slider').value = avgLapTimeInSeconds;
                document.getElementById('live-lap-time-value').textContent = avgLapTimeInSeconds;

                // Reset and populate the live stint table
                document.getElementById('live-stint-table-body').innerHTML = '';
                liveStint = 0;
                liveStints = createStints(lapsPerStint, lapsInLastStint, selectedDrivers);
                liveStints.forEach(stint => {
                    addLiveStintToTable(stint);
                });
            }
            window.showPage3 = showPage3;

            function addDriver() {
                const select = document.getElementById('driver-select');
                const driverId = select.value;
                if (driverId && !selectedDrivers.includes(driverId)) {
                    selectedDrivers.push(driverId);
                    localStorage.setItem('selectedDrivers', JSON.stringify(selectedDrivers));
                    renderSelectedDrivers();
                }
            }
            window.addDriver = addDriver;
            function removeDriver(driverId) {
                const index = selectedDrivers.indexOf(driverId);
                if (index > -1) {
                    selectedDrivers.splice(index, 1);
                    localStorage.setItem('selectedDrivers', JSON.stringify(selectedDrivers));
                    renderSelectedDrivers();
                }
            }
            window.removeDriver = removeDriver;
            function renderSelectedDrivers() {
                const list = document.getElementById('driver-list');
                list.innerHTML = '';
                selectedDrivers.forEach(id => {
                    const driver = drivers.find(d => d.id === id);
                    if (driver) {
                        const li = document.createElement('li');
                        li.className = 'flex items-center justify-between p-3 bg-gray-100 rounded-lg shadow';
                        li.innerHTML = `
                            <span class="text-lg font-medium text-gray-800">${driver.name}</span>
                            <button onclick="removeDriver('${driver.id}')" class="text-red-500 hover:text-red-700 transition duration-200">
                                <i class="fas fa-trash"></i>
                            </button>
                        `;
                        list.appendChild(li);
                    }
                });
            }

            function addDriverAdmin() {
                const nameInput = document.getElementById('new-driver-name');
                const numberInput = document.getElementById('new-driver-number');
                const name = nameInput.value.trim();
                const number = numberInput.value.trim();
                if (name) {
                    drivers.push({ id: `driver-${Date.now()}`, name: name, number: number });
                    localStorage.setItem('drivers', JSON.stringify(drivers));
                    nameInput.value = '';
                    numberInput.value = '';
                    renderDriverSelect();
                    renderAdminDrivers();
                }
            }
            window.addDriverAdmin = addDriverAdmin;
            function removeDriverAdmin(driverId) {
                const index = drivers.findIndex(d => d.id === driverId);
                if (index > -1) {
                    drivers.splice(index, 1);
                    localStorage.setItem('drivers', JSON.stringify(drivers));
                    // Also remove from selected drivers if present
                    const selectedIndex = selectedDrivers.indexOf(driverId);
                    if (selectedIndex > -1) {
                        selectedDrivers.splice(selectedIndex, 1);
                        localStorage.setItem('selectedDrivers', JSON.stringify(selectedDrivers));
                        renderSelectedDrivers();
                    }
                    renderDriverSelect();
                    renderAdminDrivers();
                }
            }
            window.removeDriverAdmin = removeDriverAdmin;
            function renderAdminDrivers() {
                const list = document.getElementById('admin-driver-list');
                list.innerHTML = '';
                drivers.forEach(driver => {
                    const li = document.createElement('li');
                    li.className = 'flex items-center justify-between p-3 bg-gray-100 rounded-lg shadow';
                    li.innerHTML = `
                        <span class="text-lg font-medium text-gray-800">${driver.name} (#${driver.number})</span>
                        <button onclick="removeDriverAdmin('${driver.id}')" class="text-red-500 hover:text-red-700 transition duration-200">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    list.appendChild(li);
                });
            }

            function addCarAdmin() {
                const nameInput = document.getElementById('new-car-name');
                const name = nameInput.value.trim();
                if (name) {
                    cars.push({ id: `car-${Date.now()}`, name: name });
                    localStorage.setItem('cars', JSON.stringify(cars));
                    nameInput.value = '';
                    renderCarSelect();
                    renderAdminCars();
                }
            }
            window.addCarAdmin = addCarAdmin;
            function removeCarAdmin(carId) {
                const index = cars.findIndex(c => c.id === carId);
                if (index > -1) {
                    cars.splice(index, 1);
                    localStorage.setItem('cars', JSON.stringify(cars));
                    renderCarSelect();
                    renderAdminCars();
                }
            }
            window.removeCarAdmin = removeCarAdmin;
            function renderAdminCars() {
                const list = document.getElementById('admin-car-list');
                list.innerHTML = '';
                cars.forEach(car => {
                    const li = document.createElement('li');
                    li.className = 'flex items-center justify-between p-3 bg-gray-100 rounded-lg shadow';
                    li.innerHTML = `
                        <span class="text-lg font-medium text-gray-800">${car.name}</span>
                        <button onclick="removeCarAdmin('${car.id}')" class="text-red-500 hover:text-red-700 transition duration-200">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    list.appendChild(li);
                });
            }

            function addTrackAdmin() {
                const nameInput = document.getElementById('new-track-name');
                const lapTimeInput = document.getElementById('new-track-lap-time');
                const name = nameInput.value.trim();
                const lapTime = parseFloat(lapTimeInput.value);
                if (name && !isNaN(lapTime)) {
                    tracks.push({ id: `track-${Date.now()}`, name: name, lapTime: lapTime });
                    localStorage.setItem('tracks', JSON.stringify(tracks));
                    nameInput.value = '';
                    lapTimeInput.value = '';
                    renderTrackSelect();
                    renderAdminTracks();
                }
            }
            window.addTrackAdmin = addTrackAdmin;
            function removeTrackAdmin(trackId) {
                const index = tracks.findIndex(t => t.id === trackId);
                if (index > -1) {
                    tracks.splice(index, 1);
                    localStorage.setItem('tracks', JSON.stringify(tracks));
                    renderTrackSelect();
                    renderAdminTracks();
                }
            }
            window.removeTrackAdmin = removeTrackAdmin;
            function renderAdminTracks() {
                const list = document.getElementById('admin-track-list');
                list.innerHTML = '';
                tracks.forEach(track => {
                    const li = document.createElement('li');
                    li.className = 'flex items-center justify-between p-3 bg-gray-100 rounded-lg shadow';
                    li.innerHTML = `
                        <span class="text-lg font-medium text-gray-800">${track.name} (${track.lapTime}s)</span>
                        <button onclick="removeTrackAdmin('${track.id}')" class="text-red-500 hover:text-red-700 transition duration-200">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    list.appendChild(li);
                });
            }

            function renderDriverSelect() {
                const select = document.getElementById('driver-select');
                select.innerHTML = '<option value="">Select a Driver...</option>';
                drivers.forEach(driver => {
                    const option = document.createElement('option');
                    option.value = driver.id;
                    option.textContent = driver.name;
                    select.appendChild(option);
                });
            }
            function renderTrackSelect() {
                const select = document.getElementById('track-select');
                select.innerHTML = '<option value="">Select a Track...</option>';
                tracks.forEach(track => {
                    const option = document.createElement('option');
                    option.value = track.id;
                    option.textContent = track.name;
                    select.appendChild(option);
                });
            }
            function renderCarSelect() {
                const select = document.getElementById('car-select');
                select.innerHTML = '<option value="">Select a Car...</option>';
                cars.forEach(car => {
                    const option = document.createElement('option');
                    option.value = car.id;
                    option.textContent = car.name;
                    select.appendChild(option);
                });
            }
            
            function saveDataToServer() {
                const allData = {
                    drivers: drivers,
                    tracks: tracks,
                    cars: cars,
                };
                
                // For demonstration, we'll just log it.
                // In a real application, you would send this to a backend.
                console.log("Saving data:", allData);
                alert("Data saved (to console for now).");
            }
            window.saveDataToServer = saveDataToServer;


            function calculateAndShowPage2() {
                const raceHours = parseInt(document.getElementById('race-duration-hours').value) || 0;
                const raceMinutes = parseInt(document.getElementById('race-duration-minutes').value) || 0;
                const avgLapTimeMinutes = parseInt(document.getElementById('avg-lap-time-minutes').value) || 0;
                const avgLapTimeSeconds = parseInt(document.getElementById('avg-lap-time-seconds').value) || 0;
                const pitStopTime = parseInt(document.getElementById('pit-stop-time').value) || 0;
                const fuelPerLap = parseFloat(document.getElementById('fuel-per-lap-display-input').value) || 0;
                const tankCapacity = parseInt(document.getElementById('tank-capacity-display-input').value) || 0;
                
                if (raceHours === 0 && raceMinutes === 0 || avgLapTimeMinutes === 0 && avgLapTimeSeconds === 0 || fuelPerLap === 0 || tankCapacity === 0) {
                    alert('Please fill out all race inputs to calculate the strategy.');
                    return;
                }

                // Calculations
                raceDurationSeconds = (raceHours * 3600) + (raceMinutes * 60);
                const avgLapTimeInSeconds = (avgLapTimeMinutes * 60) + avgLapTimeSeconds;
                
                const lapsPerTank = Math.floor(tankCapacity / fuelPerLap);
                stintDurationSeconds = lapsPerTank * avgLapTimeInSeconds;
                stintDurationMinutes = Math.floor(stintDurationSeconds / 60);
                lapsPerStint = lapsPerTank;
                
                const totalLaps = Math.floor(raceDurationSeconds / avgLapTimeInSeconds);
                const totalPitStops = Math.floor(totalLaps / lapsPerTank);
                
                // Adjust for the last stint
                lapsInLastStint = totalLaps % lapsPerTank;
                const lastStintDuration = lapsInLastStint * avgLapTimeInSeconds;
                
                document.getElementById('est-laps-display').textContent = totalLaps;
                document.getElementById('stint-duration-display').textContent = `${stintDurationMinutes} min`;
                document.getElementById('laps-per-stint-display').textContent = lapsPerStint;
                document.getElementById('pit-stops-display').textContent = totalPitStops;
                document.getElementById('total-fuel-display').textContent = `${(totalLaps * fuelPerLap).toFixed(2)} L`;
                document.getElementById('fuel-per-lap-display').textContent = `${fuelPerLap} L`;
                document.getElementById('lap-time-display').textContent = `${avgLapTimeInSeconds} s`;
                document.getElementById('pit-stop-duration-display').textContent = `${pitStopTime} s`;
                
                // Show relevant sections
                document.getElementById('overall-summary').classList.remove('hidden');
                document.getElementById('sliders-container').classList.remove('hidden');
                document.getElementById('stint-breakdown-display').classList.remove('hidden');
                document.getElementById('share-link-container').classList.remove('hidden');
                document.getElementById('page3-button-container').classList.remove('hidden');

                // Populate the table
                renderStintTable(lapsPerStint, lapsInLastStint, selectedDrivers, raceDurationSeconds, avgLapTimeInSeconds, pitStopTime);
            }
            window.calculateAndShowPage2 = calculateAndShowPage2;

            function renderStintTable(lapsPerStint, lapsInLastStint, drivers, totalRaceSeconds, avgLapTimeInSeconds, pitStopTime) {
                const tableBody = document.getElementById('stint-table-body');
                tableBody.innerHTML = '';
                const totalStints = Math.ceil(totalRaceSeconds / (lapsPerStint * avgLapTimeInSeconds));
                
                let currentTimeSeconds = 0;
                let currentLap = 0;
                let driverIndex = 0;

                for (let i = 1; i <= totalStints; i++) {
                    const stintLaps = (i === totalStints && lapsInLastStint > 0) ? lapsInLastStint : lapsPerStint;
                    if (stintLaps === 0) continue; // Skip if last stint has no laps
                    const stintDuration = stintLaps * avgLapTimeInSeconds;
                    
                    const stintStartTime = currentTimeSeconds;
                    const stintEndTime = currentTimeSeconds + stintDuration;

                    const driver = drivers[driverIndex % drivers.length];
                    const backupDriver = drivers[(driverIndex + 1) % drivers.length];

                    const row = tableBody.insertRow();
                    row.className = 'text-center';
                    
                    row.innerHTML = `
                        <td class="px-1 py-2 whitespace-nowrap text-sm text-gray-800 border-r border-gray-300">${formatTime(stintStartTime)}</td>
                        <td class="px-1 py-2 whitespace-nowrap text-sm text-gray-800 border-r border-gray-300">${formatTime(stintEndTime)}</td>
                        <td class="px-1 py-2 whitespace-nowrap text-sm text-gray-800 border-r border-gray-300">${currentLap}</td>
                        <td class="px-1 py-2 whitespace-nowrap text-sm text-gray-800 border-r border-gray-300">${currentLap + stintLaps}</td>
                        <td class="px-1 py-2 whitespace-nowrap text-sm text-gray-800 border-r border-gray-300">${stintLaps}</td>
                        <td class="px-1 py-2 whitespace-nowrap text-sm text-gray-800 border-r border-gray-300">${drivers.find(d => d.id === driver)?.name}</td>
                        <td class="px-1 py-2 whitespace-nowrap text-sm text-gray-800">${drivers.find(d => d.id === backupDriver)?.name}</td>
                    `;
                    
                    currentTimeSeconds = stintEndTime + pitStopTime;
                    currentLap += stintLaps;
                    driverIndex++;
                }
            }

            function formatTime(seconds) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;
                return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            }

            function createStints(lapsPerStint, lapsInLastStint, drivers) {
                // This function is for the live planner. It needs to be fleshed out.
                return []; // Placeholder
            }
            function addLiveStintToTable(stint) {
                // This function is for the live planner. It needs to be fleshed out.
            }

            // Live planner functions
            let liveRaceDurationSeconds = 0;
            let liveStartTime = null;
            let liveTimerInterval = null;
            let liveStints = [];
            let liveStint = 0;
            let liveStintDuration = 0;

            function toggleRace() {
                const button = document.getElementById('live-start-stop-button');
                if (button.textContent === "Start Race") {
                    startRace();
                    button.textContent = "Stop Race";
                    button.classList.remove('bg-blue-600');
                    button.classList.add('bg-red-600');
                } else {
                    stopRace();
                    button.textContent = "Start Race";
                    button.classList.remove('bg-red-600');
                    button.classList.add('bg-blue-600');
                }
            }
            window.toggleRace = toggleRace;

            function startRace() {
                // Check for valid time remaining
                const timeRemainingInput = document.getElementById('live-time-remaining');
                liveRaceDurationSeconds = parseInt(timeRemainingInput.value) * 60;
                if (isNaN(liveRaceDurationSeconds) || liveRaceDurationSeconds <= 0) {
                    alert("Please enter a valid race time in minutes.");
                    return;
                }

                liveStartTime = new Date();
                liveTimerInterval = setInterval(updateLiveTimer, 1000);
                // Enable/disable buttons
                document.getElementById('live-deduct-time-button').disabled = false;
                document.getElementById('live-pit-exit-button').disabled = false;
            }
            window.startRace = startRace;

            function stopRace() {
                clearInterval(liveTimerInterval);
                // Enable/disable buttons
                document.getElementById('live-deduct-time-button').disabled = true;
                document.getElementById('live-pit-exit-button').disabled = true;
            }
            window.stopRace = stopRace;

            function updateLiveTimer() {
                const now = new Date();
                const elapsedSeconds = Math.floor((now - liveStartTime) / 1000);
                let remainingSeconds = liveRaceDurationSeconds - elapsedSeconds;

                if (remainingSeconds <= 0) {
                    remainingSeconds = 0;
                    stopRace();
                }

                const hours = Math.floor(remainingSeconds / 3600);
                const minutes = Math.floor((remainingSeconds % 3600) / 60);
                const seconds = remainingSeconds % 60;

                document.getElementById('countdown-timer').textContent = 
                    `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

                // Update time to next pitstop
                // This logic is a placeholder and should be more robust
                const currentStintDuration = liveStintDurationSeconds || (stintDurationSeconds || 0);
                const timeInCurrentStint = elapsedSeconds % currentStintDuration;
                const timeToNextPitstop = currentStintDuration - timeInCurrentStint;
                const nextPitstopHours = Math.floor(timeToNextPitstop / 3600);
                const nextPitstopMinutes = Math.floor((timeToNextPitstop % 3600) / 60);
                const nextPitstopSeconds = timeToNextPitstop % 60;
                document.getElementById('next-pitstop-time').textContent =
                    `${String(nextPitstopHours).padStart(2, '0')}:${String(nextPitstopMinutes).padStart(2, '0')}:${String(nextPitstopSeconds).padStart(2, '0')}`;
            }
            window.updateLiveTimer = updateLiveTimer;

            function updateLiveLapTime(value) {
                document.getElementById('live-lap-time-value').textContent = value;
            }
            window.updateLiveLapTime = updateLiveLapTime;

            function updateLiveFuelUse(value) {
                document.getElementById('live-fuel-use-per-lap-value').textContent = parseFloat(value).toFixed(1);
            }
            window.updateLiveFuelUse = updateLiveFuelUse;

            function deductTime() {
                const timeToDeduct = parseInt(document.getElementById('live-time-deduction').value) * 60;
                if (isNaN(timeToDeduct) || timeToDeduct <= 0) {
                    alert("Please enter a valid time in minutes to deduct.");
                    return;
                }
                liveRaceDurationSeconds -= timeToDeduct;
                if (liveRaceDurationSeconds < 0) liveRaceDurationSeconds = 0;
                liveStartTime = new Date(liveStartTime.getTime() - timeToDeduct * 1000);
            }
            window.deductTime = deductTime;

            function simulatePitExit() {
                // Logic to be implemented to update the live stint table
                // For now, it's just a placeholder
                alert("Simulating a pit exit - functionality to be added.");
            }
            window.simulatePitExit = simulatePitExit;

            // Share link functionality
            function generateShareLink() {
                // For demonstration, just create a dummy link
                const link = window.location.origin + window.location.pathname + "?strategy=123";
                document.getElementById('share-link-output').value = link;
            }
            window.generateShareLink = generateShareLink;
            function copyShareLink() {
                const linkInput = document.getElementById('share-link-output');
                linkInput.select();
                document.execCommand('copy');
                alert('Link copied to clipboard!');
            }
            window.copyShareLink = copyShareLink;
            function initialize() {
                renderDriverSelect();
                renderTrackSelect();
                renderCarSelect();
                renderSelectedDrivers();
                renderAdminDrivers();
                renderAdminCars();
                renderAdminTracks();
            }
            initialize();
        });
    </script>
</body>
</html>

