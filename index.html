<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Road+Rage&display=swap" rel="stylesheet">
    <script>
  		tailwind.config = {
    		darkMode: 'class'
 		}
	</script>
	<script src="https://cdn.tailwindcss.com"></script>
	<style>
        body {
   			 font-family: 'Inter', sans-serif;
  			  transition: background-color 0.5s, color 0.5s;
		}
		body {
   			 background-color: #808080;
		}
        h1 {
            font-family: 'RoadRage', sans-serif;
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }

        /* Style date and time picker icons to be more visible */
        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(1) brightness(0.7);
            cursor: pointer;
            padding: 3px;
            border-radius: 3px;
        }
        
        input[type="date"]::-webkit-calendar-picker-indicator:hover,
        input[type="time"]::-webkit-calendar-picker-indicator:hover {
            filter: invert(1) brightness(1);
            background-color: rgba(59, 130, 246, 0.2);
        }

        .icon-shadow {
            filter: drop-shadow(3px 3px 0px rgba(0, 0, 0, 0.5));
        }
        .text-shadow {
            filter: drop-shadow(3px 3px 0px rgba(0, 0, 0, 0.5));
        }

        h1 {
            color: #ffffff; /* A dark color for the text */
            text-shadow: 3px 3px 0px #000000; /* The text-shadow property */

        }
        h3 {
            color: #ffffff; /* A dark color for the text */
            text-shadow: 3px 3px 0px #000000; /* The text-shadow property *//* Gradient text for h3 */

        }
        h4 {
            color: #ffffff; /* A dark color for the text */
            text-shadow: 3px 3px 0px #000000; /* The text-shadow property *//* Gradient text for h2 *//* Gradient text for h4 */
        }
        
        h2 {
            font-size: 4em;
            font-weight: SEMIbold;
            
            /* Apply the gradient to the background */
            background-image: linear-gradient(to right, #00ffff, #d400ff);
            
            /* Clip the background to the text */
            -webkit-background-clip: text;
            
            /* Make the text color transparent */
            -webkit-text-fill-color: transparent;
            
            /* This is a fallback for browsers that don't support the above */
            color: #4a90e2; 
        
            /*text-shadow: 3px 3px 0px #ffffff; /* The shadow property */
            
        }
        

             @font-face {
            font-family: 'RoadRage';
            src: url('assets/RoadRage.woff2') format('woff2'),
                 url('assets/RoadRage.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }
        .road-rage-font {
            font-family: 'RoadRage', sans-serif;
        }
        select {
            max-width: 100%;
            box-sizing: border-box;
        }
        
        /* Desktop 2-column layout */
        .desktop-mode {
            display: grid !important;
            grid-template-columns: 1280px 1280px !important;
            gap: 2rem !important;
            max-width: 2560px !important;
            width: 2560px !important;
            margin: 0 auto !important;
            background: transparent !important;
            padding: 1rem !important;
            border-radius: 0 !important;
            box-shadow: none !important;
        }
        
        .desktop-left {
            display: flex !important;
            flex-direction: column !important;
            gap: 1.5rem !important;
            background: rgb(23 23 23) !important;
            padding: 1.5rem !important;
            border-radius: 0.75rem !important;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1) !important;
        }
        
        .desktop-right {
            display: flex !important;
            flex-direction: column !important;
            gap: 1.5rem !important;
            background: rgb(23 23 23) !important;
            padding: 1.5rem !important;
            border-radius: 0.75rem !important;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1) !important;
        }
        
        /* Show all containers in desktop mode */
        .desktop-mode .hidden {
            display: block !important;
        }

        /* Driver Color Classes for Stint Rows */
        .driver-color-7 { background-color: rgba(59, 130, 246, 0.2) !important; } /* Blue */

        .driver-color-6 { background-color: rgba(16, 185, 129, 0.2) !important; } /* Green */

        .driver-color-5 { background-color: rgba(245, 101, 101, 0.2) !important; } /* Red */

        .driver-color-4 { background-color: rgba(251, 191, 36, 0.2) !important; } /* Yellow */

        .driver-color-1 { background-color: rgba(168, 85, 247, 0.2) !important; } /* Purple */

        .driver-color-2 { background-color: rgba(236, 72, 153, 0.2) !important; } /* Pink */

        .driver-color-0 { background-color: rgba(6, 182, 212, 0.2) !important; } /* Cyan */

        .driver-color-3 { background-color: rgba(34, 197, 94, 0.2) !important; } /* Lime */
        
        .driver-color-default { background-color: rgba(115, 115, 115, 0.2) !important; } /* Default Gray */
        .pit-stop-row { background-color: rgb(42, 42, 42) !important; ; } /* Red for pit stops */
        
        /* Daylight Gradient Classes for Daylight Column */
        .daylight-night { 
            background: #141450 !important; 
            color: #9ca3af !important;
            opacity: 0.9;
        }
        .daylight-pre-dawn { 
            background: #3f0d8a !important; 
            color: #e5e7eb !important;
            opacity: 0.9;
        }
        .daylight-dawn { 
            background: #7300a0 !important; 
            color: #f9fafb !important;
            opacity: 0.95;
        }
        .daylight-post-dawn { 
            background: #ffaa00 !important; 
            color: #1f2937 !important;
            opacity: 0.95;
        }
        .daylight-day { 
            background: #ffea29 !important; 
            color: #1f2937 !important;
            opacity: 0.95;
        }
        .daylight-midday { 
            background: #fffcc4 !important; 
            color: #1f2937 !important;
            opacity: 0.95;
        }
        .daylight-pre-dusk { 
            background: #ffaa00 !important; 
            color: #1f2937 !important;
            opacity: 0.92;
        }
        .daylight-dusk { 
            background: #7300a0 !important; 
            color: #f9fafb !important;
            opacity: 0.92;
        }
        .daylight-post-dusk { 
            background: #3f0d8a !important; 
            color: #f3f4f6 !important;
            opacity: 0.9;
        }
        
        /* Toggle Switch Styles */
        .toggle-active {
            background-color: #3b82f6 !important;
        }
        .toggle-active .toggle-slider {
            transform: translateX(1.25rem) !important;
        }
        .time-mode-active {
            color: #3b82f6 !important;
            font-weight: 600 !important;
        }
        
        /* Time Mode Toggle Styles */
        .toggle-switch {
            background-color: #4b5563;
        }
        .toggle-switch.active {
            background-color: #3b82f6;
        }
        .toggle-switch.active #time-toggle-slider {
            transform: translateX(16px);
        }
    </style>
</head>
<body class="bg-neutral-900 text-neutral-200 p-4">
    
    <!-- Layout Toggle Switch - HIDDEN -->
    <div class="fixed top-4 right-4 z-50 hidden">
        <button id="layout-toggle" onclick="toggleLayout()" class="flex items-center space-x-2 px-3 py-2 rounded-md bg-neutral-600 hover:bg-neutral-500 text-neutral-200">
            <i id="layout-icon" class="fas fa-mobile-alt text-sm"></i>
            <span id="layout-text" class="text-sm font-medium">Mobile</span>
        </button>
    </div>
    
    <div class="max-w-4xl mx-auto bg-neutral-900 p-6 md:p-10 rounded-xl transition-colors duration-500">
        <div class="text-center mb-6">
            <img src="assets/g457912.png" alt="?" class="mx-auto w-100  h-auto">
        </div>
        <button id="admin-btn" onclick="showAdminPage()" class="bg-neutral-900 hover:bg-green-600 text-black font-bold py-1 px-1 rounded-lg  transition-all duration-200 transform hover:scale-105 space-x-2">
        </button>  
        <h2 class="text-5xl road-rage-font text-center  mb-10">RACE PLANNER</h2>

        <div id="app-container">
            <div class="flex justify-center space-x-4 mb-8">
                <button id="race-details-btn" onclick="showPlannerPage()" class="bg-neutral-800 hover:bg-blue-700 text-black font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105 flex items-center space-x-2">
                     <span>DETAILS</span>
                </button>
                
            <a href="livev2.html">
            <button class="bg-neutral-800 hover:bg-red-500 text-black font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105 flex items-center space-x-2">LIVE</button>
            </a>
            </div>

            
            <div id="planner-page" class="">
                    <div class="p-6 bg-neutral-800 border-neutral-900 rounded-lg">
                    <h1 class="text-xl mb-4 road-rage-font">Drivers <span class="text-sm text-neutral-500"></span></h1>
                    <div class="flex items-center space-x-2 mb-4">
                        <select id="driver-select" class="p-3 border-neutral-800 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 w-full bg-neutral-900 text-neutral-400">
                            <option value="">Select a Driver...</option>
                        </select>
                        <button onclick="addDriver()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3     px-4 rounded-lg transition-all duration-200 transform hover:scale-105">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <ul id="driver-list" class="space-y-2"></ul>
                </div>

                                <div class="p-6 bg-neutral-800 border-neutral-900 rounded-lg mt-6">
                    <h1 class="text-xl mb-4 road-rage-font">Track & Car</h1>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full">
                        <div class="flex flex-col w-full">
                            <select id="track-select" class="mt-1 p-3 border-neutral-800 rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 bg-neutral-900 text-neutral-400">
                                <option value="">Select a Track...</option>
                            </select>
                        </div>
                        <div class="flex flex-col w-full">
                            <select id="car-select" class="mt-1 p-3 border-neutral-800 rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 bg-neutral-900 text-neutral-400">
                                <option value="">Select a Car...</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="p-6 bg-neutral-800 border-neutral-900 rounded-lg mt-6">
                    <h1 class="text-xl mb-4 road-rage-font">Race Date & Time</h1>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full">
                        <div class="flex flex-col w-full">
                            <label for="race-date" class="text-sm font-medium text-neutral-500 mb-2">Race Date</label>
                            <input type="date" id="race-date" class="mt-1 p-3 border-neutral-800 rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 bg-neutral-900 text-neutral-400">
                        </div>
                        <div class="flex flex-col w-full">
                            <label for="race-time" class="text-sm font-medium text-neutral-500 mb-2">Race Start Time <span class="text-xs text-neutral-400">(Simulator Time)</span></label>
                            <input type="time" id="race-time" class="mt-1 p-3 border-neutral-800 rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 bg-neutral-900 text-neutral-400">
                        </div>
                        <div class="flex flex-col w-full">
                            <label for="event-start-date" class="text-sm font-medium text-neutral-500 mb-2">Event Start Date <span class="text-xs text-neutral-400">(Europe/London Date)</span></label>
                            <input type="date" id="event-start-date" class="mt-1 p-3 border-neutral-800 rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 bg-neutral-900 text-neutral-400">
                        </div>
                        <div class="flex flex-col w-full">
                            <label for="event-start-time" class="text-sm font-medium text-neutral-500 mb-2">Event Start Time <span class="text-xs text-neutral-400">(Europe/London Time)</span></label>
                            <input type="time" id="event-start-time" class="mt-1 p-3 border-neutral-800 rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 bg-neutral-900 text-neutral-400">
                        </div>
                    </div>
                </div>

                <div class="p-6 bg-neutral-800 border-neutral-900 rounded-lg mt-6">
                    <h1 class="text-xl mb-4 road-rage-font">Weather Forecast (Optional)</h1>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full">
                        <div class="flex flex-col w-full">
                            <label for="weather-temp-url" class="text-sm font-medium text-neutral-500 mb-2">Temperature Chart URL</label>
                            <input type="url" id="weather-temp-url" placeholder="https://raw.githubusercontent.com/..." class="mt-1 p-3 border-neutral-800 rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 bg-neutral-900 text-neutral-400">
                        </div>
                        <div class="flex flex-col w-full">
                            <label for="weather-clouds-url" class="text-sm font-medium text-neutral-500 mb-2">Clouds & Precipitation URL</label>
                            <input type="url" id="weather-clouds-url" placeholder="https://raw.githubusercontent.com/..." class="mt-1 p-3 border-neutral-800 rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 bg-neutral-900 text-neutral-400">
                        </div>
                    </div>
                </div>

                <div class="mt-8">
                    <button onclick="showPage2()" id="continue-button" class="w-full bg-blue-700 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105">
                        Calculate <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <div id="page-2" class="space-y-6 hidden">
                <div class="flex items-center space-x-4 mb-6">
                    <button onclick="showPlannerPage()" class="bg-neutral-800 hover:bg-red-500 text-black font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105">
                        <i class="fas fa-arrow-left mr-2"></i> Back
                    </button>
                </div>

                <div class="p-6 bg-neutral-800 border-neutral-800 rounded-lg">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="flex flex-col items-center text-center justify-between h-full">
                         
                            <img id="track-logo" src="" alt="Track Logo" class="w-40 h-40 mb-2 object-contain hidden">
                            <span id="page2-track" class="text-neutral-400 mt-auto"></span>
                        </div>
                        <div class="flex flex-col items-center text-center">
                            <img id="car-logo" src="" alt="Car Logo" class="w-40 h-40 mb-2 object-contain hidden">
                            <span id="page2-car" class="text-neutral-400 mt-auto"></span>
                        </div>
                        <div class="flex flex-col items-center text-center">
                        
                            <div id="page2-drivers" class="text-neutral-400 mt-1">
                                <!-- Drivers will be populated here as rows -->
                            </div>
                        </div>
                    </div>
                    <!-- Race Date & Time Display -->
                    <div class="mt-6 pt-4 border-t border-neutral-700">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            <div class="flex flex-col items-center">
                                <i class="fas fa-calendar-alt text-blue-400 text-2xl mb-2"></i>
                                <span class="text-sm text-neutral-500">Race Date</span>
                                <span id="page2-race-date" class="text-neutral-400 font-medium">Not selected</span>
                            </div>
                            <div class="flex flex-col items-center">
                                <i class="fas fa-clock text-green-400 text-2xl mb-2"></i>
                                <span class="text-sm text-neutral-500">Start Time</span>
                                <span id="page2-race-time" class="text-neutral-400 font-medium">Not selected</span>
                            </div>
                            <div class="flex flex-col items-center">
                                <i class="fas fa-sun text-orange-400 text-2xl mb-2"></i>
                                <span class="text-sm text-neutral-500">Sunrise</span>
                                <span id="page2-sunrise" class="text-neutral-400 font-medium">Calculating...</span>
                            </div>
                            <div class="flex flex-col items-center">
                                <i class="fas fa-moon text-purple-400 text-2xl mb-2"></i>
                                <span class="text-sm text-neutral-500">Sunset</span>
                                <span id="page2-sunset" class="text-neutral-400 font-medium">Calculating...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Weather Forecast Display Section -->
                <div id="weather-display" class="p-6 bg-neutral-800 border-neutral-800 rounded-lg mb-6 hidden">
                    <h1 class="text-xl mb-4 road-rage-font">üå¶Ô∏è WEATHER FORECAST</h1>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <div id="temp-chart-container" class="hidden">
                            <h4 class="text-lg font-bold text-white mb-2">Temperature</h4>
                            <img id="temp-chart" src="" alt="Temperature Chart" class="w-full rounded-lg border border-neutral-700">
                        </div>
                        <div id="clouds-chart-container" class="hidden">
                            <h4 class="text-lg font-bold text-white mb-2">Clouds & Precipitation</h4>
                            <img id="clouds-chart" src="" alt="Clouds & Precipitation Chart" class="w-full rounded-lg border border-neutral-700">
                        </div>
                    </div>
                </div>

                <!-- Garage61 Lap Times Section - MOVED ABOVE RACE INPUTS -->
                <div id="garage61-lap-times" class="p-6 bg-neutral-800 border-neutral-800 rounded-lg mb-6 hidden">
                    <h1 class="text-xl mb-4 road-rage-font">GARAGE61 LAP TIMES</h1>
                    <div id="lap-times-loading" class="text-center py-4 hidden">
                        <i class="fas fa-spinner fa-spin text-2xl text-blue-400 mb-2"></i>
                        <p class="text-neutral-400">Fetching lap data from Garage61...</p>
                    </div>
                    <div id="lap-times-error" class="text-center py-4 text-red-400 hidden">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <p id="lap-times-error-message">Error loading lap data</p>
                    </div>
                    <div id="lap-times-content" class="hidden">
                        <div class="bg-neutral-800 rounded-lg border-neutral-700 overflow-hidden shadow-lg">
                            <table class="w-full text-neutral-200 text-xs">
                                <thead class="bg-gradient-to-r from-neutral-700 to-neutral-600  border-neutral-500">
                                    <tr>
                                        <th class="py-2 px-3 text-left text-xs font-bold text-neutral-200 uppercase tracking-wider border-r border-neutral-500">Driver</th>
                                        <th class="py-2 px-3 text-left text-xs font-bold text-neutral-200 uppercase tracking-wider border-r border-neutral-500">Best Lap</th>
                                        <th class="py-2 px-3 text-left text-xs font-bold text-neutral-200 uppercase tracking-wider border-r border-neutral-500">Fuel Used</th>
                                        <th class="py-2 px-3 text-left text-xs font-bold text-neutral-200 uppercase tracking-wider">Conditions</th>
                                    </tr>
                                </thead>
                                <tbody id="lap-times-tbody" class="divide-y divide-neutral-600">
                                    <!-- Lap data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="race-inputs-container" class="p-6 bg-neutral-800 border-neutral-800 rounded-lg">
                    <h1 class="text-xl mb-4  road-rage-font">Race Inputs</h1>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="flex flex-col">
                            <label class="text-sm font-medium text-neutral-500">Race Duration</label>
                            <div class="flex items-center mt-1 space-x-2">
                                <input type="number" id="race-duration-hours" placeholder="" class="p-2 border-neutral-800 rounded-lg text-neutral-200 bg-neutral-900 w-1/2 text-center focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                                <span class="text-neutral-500">hr</span>
                                <input type="number" id="race-duration-minutes" placeholder="" class="p-2 border-neutral-800 rounded-lg text-neutral-200 bg-neutral-900 w-1/2 text-center focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                                <span class="text-neutral-500">min</span>
                            </div>
                        </div>
                        <div class="flex flex-col">
                            <label class="text-sm font-medium text-neutral-500">Avg. Lap Time</label>
                            <div class="flex items-center mt-1 space-x-2">
                                <input type="number" id="avg-lap-time-minutes" placeholder="" class="p-2 border-neutral-800 rounded-lg text-neutral-200 bg-neutral-900 w-1/2 text-center focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                                <span class="text-neutral-500">min</span>
                                <input type="number" id="avg-lap-time-seconds" placeholder="" class="p-2 border-neutral-800 rounded-lg text-neutral-200 bg-neutral-900 w-1/2 text-center focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                                <span class="text-neutral-500">sec</span>
                            </div>
                        </div>
                        <div class="flex flex-col">
                            <label for="pit-stop-time" class="text-sm font-medium text-neutral-500">Avg. Pit Stop Time (sec)</label>
                            <input type="number" id="pit-stop-time" value="" class="mt-1 p-2 border-neutral-800 rounded-lg text-neutral-200 bg-neutral-900 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                        </div>
                        <div class="flex flex-col">
                            <label for="fuel-per-lap-display-input" class="text-sm font-medium text-neutral-500">Fuel Use per Lap (L)</label>
                            <input type="number" id="fuel-per-lap-display-input" class="mt-1 p-2 border-neutral-800 rounded-lg text-neutral-200 bg-neutral-900 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                        </div>
                        <div class="flex flex-col">
                            <label for="tank-capacity-display-input" class="text-sm font-medium text-neutral-500">Fuel Tank Size (L)</label>
                            <input type="number" id="tank-capacity-display-input" class="mt-1 p-2 border-neutral-800 rounded-lg text-neutral-200 bg-neutral-900 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                        </div>
                        <div class="mt-4 flex justify-end">
                            <button id="calculate-page2-button" onclick="calculateAndShowPage2()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200 transform hover:scale-105">
                                Calculate
                            </button>
                        </div>
                    </div>
                </div>

                
                <div id="overall-summary" class="p-6 bg-neutral-800 border-neutral-800 rounded-lg mb-6">
                            <h3 class="text-xl road-rage-font mb-8">Strategy Summary</h3>
                            <div class="grid grid-cols-4 md:grid-cols-4 lg:grid-cols-4 gap-4 text-neutral-200">
                        <div>
                            <div class="flex flex-col items-center">
                                <i class="fa-solid fa-flag-checkered fa-2xl text-neutral-200 mb-4 icon-shadow"></i>
                                <span id="est-laps-display" class="font-semibold text-lg text-neutral-200 text-shadow"></span>
                                <span class="text-sm mb-4 text-neutral-500">Est. Laps</span>
                            </div>
                        </div>
                        <div>
                            <div class="flex flex-col items-center">
                                <i class="fa-solid fa-hourglass-half fa-2xl text-neutral-200 mb-4 icon-shadow"></i>
                                <span id="stint-duration-display" class="font-semibold text-lg text-neutral-200 text-shadow"></span>
                                <span class="text-sm mb-4 text-neutral-500">Stint Duration</span>
                            </div>
                        </div>
                        <div>
                            <div class="flex flex-col items-center">
                                <i class="fa-solid fa-flag fa-2xl text-neutral-200 mb-4 icon-shadow"></i>
                                <span id="laps-per-stint-display" class="font-semibold text-lg text-neutral-200 text-shadow"></span>
                                <span class="text-sm mb-4 text-neutral-500">Laps per Stint</span>
                            </div>
                        </div>
                        <div>
                            <div class="flex flex-col items-center">
                                <i class="fa-solid fa-hand fa-2xl text-neutral-200 mb-4 icon-shadow"></i>
                                <span id="pit-stops-display" class="font-semibold text-lg text-neutral-200 text-shadow"></span>
                                <span class="text-sm mb-4 text-neutral-500">Pit Stops</span>
                            </div>
                        </div>
                        <div>
                            <div class="flex flex-col items-center">
                                <i class="fa-solid fa-gas-pump fa-2xl text-neutral-200 mb-4 icon-shadow"></i>
                                <span id="total-fuel-display" class="font-semibold text-lg text-neutral-200 text-shadow"></span>
                                <span class="text-sm mb-4 text-neutral-500">Total Fuel</span>
                            </div>
                        </div>
                        <div>
                            <div class="flex flex-col items-center">
                                <i class="fa-solid fa-droplet fa-2xl text-neutral-200 mb-4 icon-shadow"></i>
                                <span id="fuel-per-lap-display" class="font-semibold text-lg text-neutral-200 text-shadow"></span>
                                <span class="text-sm mb-4 text-neutral-500">Fuel per Lap</span>
                            </div>
                        </div>
                        <div>
                            <div class="flex flex-col items-center">
                                <i class="fa-solid fa-stopwatch fa-2xl text-neutral-200 mb-4 icon-shadow"></i>
                                <span id="lap-time-display" class="font-semibold text-lg text-neutral-200 text-shadow"></span>
                                <span class="text-sm mt-1 text-neutral-500">Lap Time</span>
                            </div>
                        </div>
                        <div>
                            <div class="flex flex-col items-center">
                                <i class="fa-solid fa-stopwatch fa-2xl text-neutral-200 mb-4 icon-shadow"></i>
                                <span id="pit-stop-duration-display" class="font-semibold text-lg text-neutral-200 text-shadow"></span>
                                <span class="text-sm mb-4 text-neutral-500">Pit Stop Duration</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="sliders-container" class="p-6 bg-neutral-800 border-neutral-800 rounded-lg !mb-6 hidden">
                    <h1 class="text-xl mb-4 road-rage-font">Dynamic Adjustments</h1>
                        <div class="flex-grow w-full">
                            <label for="fuel-slider" class="text-sm font-medium text-neutral-500">Adjust Fuel per Lap</label>
                            <div class="flex items-center mt-1 space-x-2">
                                <button onclick="adjustSlider('fuel', -0.05)" class="p-1 rounded-full text-white bg-neutral-800 hover:bg-neutral-500 transition-colors duration-200">-</button>
                                <input type="range" id="fuel-slider" min="-2.0" max="2.0" value="0" step="0.05" class="w-full">
                                <button onclick="adjustSlider('fuel', 0.05)" class="p-1 rounded-full text-white bg-neutral-800 hover:bg-neutral-500 transition-colors duration-200">+</button>
                                <span id="fuel-slider-value" class="text-neutral-200 font-mono text-sm w-12 text-right">0.00</span>
                            </div>
                        </div>
                        <div class="flex-grow w-full">
                            <label for="lap-time-slider" class="text-sm font-medium text-neutral-500">Adjust Lap Time</label>
                            <div class="flex items-center mt-1 space-x-2">
                                <button onclick="adjustSlider('lapTime', -0.05)" class="p-1 rounded-full text-white bg-neutral-800 hover:bg-neutral-500 transition-colors duration-200">-</button>
                                <input type="range" id="lap-time-slider" min="-3" max="3" value="0" step="0.05" class="w-full">
                                <button onclick="adjustSlider('lapTime', 0.05)" class="p-1 rounded-full text-white bg-neutral-800 hover:bg-neutral-500 transition-colors duration-200">+</button>
                                <span id="lap-time-slider-value" class="text-neutral-200 font-mono text-sm w-12 text-right">0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                  
                <div id="stint-breakdown-display" class="p-6 bg-neutral-800 border-neutral-800 rounded-lg overflow-x-auto hidden">
                    <h1 class="text-xl font- mb-4  road-rage-font">Stints</h1>
                    
                    <div class="flex flex-col mb-4">
                        <!-- Hidden race start time input for internal use -->
                        <input type="hidden" id="race-start-time-page2" value="13:00">
                        
                        <!-- Time Mode Toggle -->
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center space-x-4">
                                <span class="text-sm font-medium text-neutral-300">Time Display:</span>
                                <div class="flex items-center space-x-2">
                                    <span id="race-time-label" class="text-sm text-neutral-400">Race Time</span>
                                    <div class="relative inline-block w-10 h-6 transition duration-200 ease-in-out bg-neutral-600 rounded-full cursor-pointer toggle-switch" onclick="toggleTimeMode()">
                                        <div id="time-toggle-slider" class="absolute left-0 top-0 w-6 h-6 transition duration-200 ease-in-out transform bg-white rounded-full shadow"></div>
                                    </div>
                                    <span id="local-time-label" class="text-sm text-neutral-400">Local Time</span>
                                </div>
                            </div>
                            
                            <!-- Driver Timezone Selector (hidden by default) -->
                            <div id="driver-timezone-selector" class="hidden flex items-center space-x-2">
                                <span class="text-sm text-neutral-400">Driver:</span>
                                <select id="driver-timezone-dropdown" class="bg-neutral-800 text-neutral-300 border border-neutral-600 rounded px-2 py-1 text-sm" onchange="updateStintTableTimes()">
                                    <option value="">Select Driver</option>
                                </select>
                            </div>
                        </div>
                        
                        <button id="recalculate-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200 transform hover:scale-105 mt-4" onclick="updateTimesOnly()">Update</button>
                    </div>
                    
                    <table class= "min-w-full divide-y divide-neutral-600 border-neutral-900 rounded-lg">
                        <thead class="bg-neutral-900">
                            <tr>
                                <th class="w-16 px-1 py-3 text-center text-xs font-medium text-neutral-200 uppercase tracking-wider border-r border-neutral-900">Start Time</th>
                                <th class="w-16 px-1 py-3 text-center text-xs font-medium text-neutral-200 uppercase tracking-wider border-r border-neutral-900">End Time</th>
                                <th class="w-12 px-1 py-3 text-center text-xs font-medium text-neutral-200 uppercase tracking-wider border-r border-neutral-900">Start Lap</th>
                                <th class="w-12 px-1 py-3 text-center text-xs font-medium text-neutral-200 uppercase tracking-wider border-r border-neutral-900">End Lap</th>
                                <th class="w-12 px-1 py-3 text-center text-xs font-medium text-neutral-200 uppercase tracking-wider border-r border-neutral-900">Laps</th>
                                <th class="w-2 px-1 py-3 text-center text-xs font-medium text-neutral-200 uppercase tracking-wider border-r border-neutral-900"></th>
								<th class="w-20 px-1 py-3 text-center text-xs font-medium text-neutral-200 uppercase tracking-wider border-r border-neutral-900">Driver</th>
								<th class="w-20 px-1 py-3 text-center text-xs font-medium text-neutral-200 uppercase tracking-wider border-r border-neutral-900">Backup</th>
                            </tr>
                        </thead>
                        <tbody id="stint-table-body" class="bg-neutral-700 divide-y divide-neutral-700">
                        </tbody>
                    </table>
                </div>

                <div id="share-link-container" class="p-6 bg-neutral-800 border-neutral-800 rounded-lg hidden">
                    <h1 class="text-xl font- mb-4  road-rage-font">Share/Save This Strategy</h1>
                    <div class="flex items-center space-x-2 mb-4">
                        <button onclick="generateShareLink()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-3 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105">
                            <i class="fas fa-share-alt mr-2"></i> Generate Link
                        </button>
                        <button id="save-update-btn" onclick="updateShareLink()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105 hidden">
                            <i class="fas fa-save mr-2"></i> Save Update
                        </button>
                        <button onclick="copyShareLink()" class="bg-neutral-800 hover:bg-cyan-400 text-neutral-500 hover:text-black font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    <input type="text" id="share-link-output" readonly class="w-full p-2 border border-neutral-700 rounded-lg bg-neutral-800 text-neutral-200 cursor-copy" placeholder="Click 'Generate Link' to create a shareable URL">
                </div>
                
            <div id="admin-page" class="hidden">
                <button onclick="saveDataToServer()" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105">
                    Save All Changes
                </button>

                <div class="p-6 bg-neutral-800 border-neutral-800 rounded-lg mt-6">
                    <h1 class="text-xl font- mb-4  road-rage-font">Manage Drivers</h1>
                    <div class="space-y-4">
                        <div class="flex flex-col space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="new-driver-name" class="text-sm font-medium text-neutral-500">Full Name</label>
                                    <input type="text" id="new-driver-name" placeholder="Adam Economu" class="mt-1 p-3 border border-neutral-700 bg-neutral-800 rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="new-driver-first-name" class="text-sm font-medium text-neutral-500">First Name</label>
                                    <input type="text" id="new-driver-first-name" placeholder="Adam" class="mt-1 p-3 border border-neutral-700 bg-neutral-800 rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="new-driver-last-name" class="text-sm font-medium text-neutral-500">Last Name</label>
                                    <input type="text" id="new-driver-last-name" placeholder="Economu" class="mt-1 p-3 border border-neutral-700 bg-neutral-800 rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                            <div>
                                <label for="new-driver-garage61-slug" class="text-sm font-medium text-neutral-500">Garage 61 Slug</label>
                                <input type="text" id="new-driver-garage61-slug" placeholder="adam-economu" class="mt-1 p-3 border border-neutral-700 bg-neutral-800 rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="new-driver-timezone" class="text-sm font-medium text-neutral-500">Timezone <span class="text-xs text-neutral-400">(Searchable - type to filter)</span></label>
                                <div class="relative">
                                    <input type="text" id="timezone-search" placeholder="Type to search timezones..." class="mt-1 p-3 border border-neutral-700 bg-neutral-800 rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <select id="new-driver-timezone" size="10" class="hidden mt-1 p-2 border border-neutral-700 bg-neutral-800 rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-blue-500 absolute z-10 h-64 overflow-y-auto">
                                        <!-- Populated dynamically from assets/timezones.json -->
                                    </select>
                                </div>
                            </div>
                            <div class="flex justify-center">
                                <button id="add-driver-btn" onclick="addDriverAdmin()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105">
                                    Add Driver
                                </button>
                            </div>
                        </div>
                        <ul id="admin-driver-list" class="space-y-2 mt-4"></ul>
                    </div>
                </div>

                <div class="p-6 bg-neutral-800 border-neutral-800 rounded-lg mt-6">
                    <h1 class="text-xl font- mb-4  road-rage-font">Manage Cars</h1>
                    <div class="space-y-4">
                        <div class="flex flex-col space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="new-car-name" class="text-sm font-medium text-neutral-500">Car Name</label>
                                    <input type="text" id="new-car-name" placeholder="Acura ARX-06 GTP" class="mt-1 p-3 border border-neutral-700 bg-neutral-800 rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="new-car-garage61-id" class="text-sm font-medium text-neutral-500">Garage 61 ID</label>
                                    <input type="number" id="new-car-garage61-id" placeholder="153" class="mt-1 p-3 border border-neutral-700 bg-neutral-800 rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                            <div class="flex justify-center">
                                <button id="add-car-btn" onclick="addCarAdmin()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105">
                                    Add Car
                                </button>
                            </div>
                        </div>
                        <ul id="admin-car-list" class="space-y-2 mt-4"></ul>
                    </div>
                </div>
                
                <div class="p-6 bg-neutral-800 border-neutral-800 rounded-lg mt-6">
                    <h1 class="text-xl font- mb-4  road-rage-font">Manage Tracks</h1>
                    <div class="space-y-4">
                        <div class="flex flex-col space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                                <div>
                                    <label for="new-track-name" class="text-sm font-medium text-neutral-500">Track Name</label>
                                    <input type="text" id="new-track-name" placeholder="Autodromo Nazionale Monza Combined" class="mt-1 p-3 border border-neutral-700 bg-neutral-800 rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="new-track-garage61-id" class="text-sm font-medium text-neutral-500">Garage 61 ID</label>
                                    <input type="number" id="new-track-garage61-id" placeholder="232" class="mt-1 p-3 border border-neutral-700 bg-neutral-800 rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="new-track-length" class="text-sm font-medium text-neutral-500">Track Length (km)</label>
                                    <input type="number" step="0.001" id="new-track-length" placeholder="5.793" class="mt-1 p-3 border border-neutral-700 bg-neutral-800 rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="new-track-latitude" class="text-sm font-medium text-neutral-500">Latitude</label>
                                    <input type="number" step="0.0001" id="new-track-latitude" placeholder="45.6156" class="mt-1 p-3 border border-neutral-700 bg-neutral-800 rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="new-track-longitude" class="text-sm font-medium text-neutral-500">Longitude</label>
                                    <input type="number" step="0.0001" id="new-track-longitude" placeholder="9.2811" class="mt-1 p-3 border border-neutral-700 bg-neutral-800 rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                            <div class="flex justify-center">
                                <button id="add-track-btn" onclick="addTrackAdmin()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105">
                                    Add Track
                                </button>
                            </div>
                        </div>
                        <ul id="admin-track-list" class="space-y-2 mt-4"></ul>
                    </div>
                </div>
            </div>
        </div>
    
                    
                </button>
    <script>
        // Global state
        let drivers = [];
        let cars = [];
        let tracks = [];
        let selectedDrivers = [];
        let totalStints = 0;
        let raceDurationSeconds = 0;
        let lapsPerStint = 0;
        let lapsInLastStint = 0;

        // On initial page load
        window.onload = function() {
            console.log('üöÄ Page loaded, initializing data...');
            fetchDataAndPopulate();
            
            // Fallback: If dropdowns are still empty after 2 seconds, try again
            setTimeout(() => {
                if (drivers.length === 0 || cars.length === 0 || tracks.length === 0) {
                    console.log('‚ö†Ô∏è Dropdowns still empty, retrying data fetch...');
                    fetchDataAndPopulate();
                }
            }, 2000);
            
            // Event listeners for dynamic sliders
            const fuelSlider = document.getElementById('fuel-slider');
            const fuelSliderValue = document.getElementById('fuel-slider-value');
            const lapTimeSlider = document.getElementById('lap-time-slider');
            const lapTimeSliderValue = document.getElementById('lap-time-slider-value');
            
            if (fuelSlider) {
                fuelSlider.addEventListener('input', () => {
                    fuelSliderValue.textContent = parseFloat(fuelSlider.value).toFixed(1);
                    // üîß Use new function to preserve driver assignments
                    updateTimesOnly();
                });
            }
            if (lapTimeSlider) {
                lapTimeSlider.addEventListener('input', () => {
                    lapTimeSliderValue.textContent = lapTimeSlider.value;
                    // üîß Use new function to preserve driver assignments
                    updateTimesOnly();
                });
            }
            
            // üîß Add listeners for time-related inputs to preserve assignments
            const raceStartTimeInput = document.getElementById('race-start-time-page2');
            
            if (raceStartTimeInput) {
                raceStartTimeInput.addEventListener('change', () => {
                    console.log('üïí Race start time changed, updating times...');
                    updateTimesOnly();
                });
            }
        };

        // Function to fetch data from the server
        async function fetchDataAndPopulate() {
            try {
                console.log('üîÑ Starting to fetch data from API...');
                
                // Fetch data from individual endpoints
                const [driversResponse, carsResponse, tracksResponse] = await Promise.all([
                    fetch('/api/drivers'),
                    fetch('/api/cars'),
                    fetch('/api/tracks')
                ]);

                if (!driversResponse.ok || !carsResponse.ok || !tracksResponse.ok) {
                    throw new Error('One or more API endpoints failed');
                }

                drivers = await driversResponse.json();
                cars = await carsResponse.json();
                tracks = await tracksResponse.json();
                
                console.log(`‚úÖ Data loaded: ${drivers.length} drivers, ${cars.length} cars, ${tracks.length} tracks`);
                
                // Populate the dropdowns
                populateDrivers();
                populateCars();
                populateTracks();
                
                console.log('‚úÖ Dropdowns populated successfully');

                // Now, check for a shared strategy link with an ID
                const urlParams = new URLSearchParams(window.location.search);
                const strategyId = urlParams.get('id');

                if (strategyId) {
                    console.log(`üîó Loading shared strategy: ${strategyId}`);
                    // If an ID exists, fetch the specific strategy from the server
                    const strategyResponse = await fetch(`/api/strategies/${strategyId}`);
                    if (!strategyResponse.ok) {
                        throw new Error('Failed to load shared strategy.');
                    }
                    const state = await strategyResponse.json();
                    loadState(state);
                } else {
                    // If no ID is in the URL, show the first page as normal
                    showPlannerPage();
                }

            } catch (error) {
                console.error('‚ùå Failed to fetch data:', error);
                alert('Could not load dropdown data from the server. Please refresh the page or check the server status.');
                
                // Set empty arrays to prevent further errors
                drivers = [];
                cars = [];
                tracks = [];
            }
        }

        // Helper function to show pages
        function showPlannerPage() {
            document.getElementById('planner-page').classList.remove('hidden');
            document.getElementById('page-2').classList.add('hidden');
            document.getElementById('admin-page').classList.add('hidden');
            document.getElementById('stint-breakdown-display').classList.add('hidden');
            document.getElementById('share-link-container').classList.add('hidden');    
            //document.getElementById('race-details-btn').classList.add('bg-blue-600');
            //document.getElementById('race-details-btn').classList.remove('bg-neutral-300', 'text-neutral-500');
            //document.getElementById('admin-btn').classList.add('bg-neutral-300', 'text-neutral-500');
            //document.getElementById('admin-btn').classList.remove('bg-blue-600', 'text-white');
        }
        function showAdminPage() {
            document.getElementById('planner-page').classList.add('hidden');
            document.getElementById('page-2').classList.add('hidden');
            document.getElementById('admin-page').classList.remove('hidden');
            document.getElementById('stint-breakdown-display').classList.add('hidden');
            document.getElementById('share-link-container').classList.add('hidden');

            //document.getElementById('admin-btn').classList.add('bg-blue-600', 'text-white');
            //document.getElementById('admin-btn').classList.remove('bg-neutral-300', 'text-neutral-500');
            //document.getElementById('race-details-btn').classList.add('bg-neutral-300', 'text-neutral-500');
            //document.getElementById('race-details-btn').classList.remove('bg-blue-600', 'text-white');
            renderAdminLists();
            resetDriverAdminForm();
            resetCarAdminForm();
            resetTrackAdminForm();
        }
        
        // Helper function to format lap time
        function formatLapTime(lapTimeMs) {
            if (!lapTimeMs) return 'N/A';
            const totalSeconds = lapTimeMs / 1000;
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = (totalSeconds % 60).toFixed(3);
            return `${minutes}:${seconds.padStart(6, '0')}`;
        }
        
        // Helper function to convert wind direction from radians to compass
        function getWindDirection(radians) {
            if (radians === null || radians === undefined) return 'N';
            
            // Convert radians to degrees
            let degrees = (radians * 180 / Math.PI) % 360;
            if (degrees < 0) degrees += 360;
            
            // Convert to compass directions
            const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
            const index = Math.round(degrees / 45) % 8;
            return directions[index];
        }
        
        function showPage2() {
            console.log('üî•üî•üî• FIRST CALCULATE BUTTON PRESSED - showPage2() üî•üî•üî•');
            
            // Get selected values for Garage61 API call
            const carSelect = document.getElementById('car-select');
            const trackSelect = document.getElementById('track-select');
            
            // Find selected car and track data to get Garage61 IDs
            const selectedCar = cars.find(car => car.name === carSelect.value);
            const selectedTrack = tracks.find(track => track.name === trackSelect.value);
            
            console.log('Selected car garage61_id:', selectedCar?.garage61_id);
            console.log('Selected track garage61_id:', selectedTrack?.garage61_id);
            
            // PROXY API CALL - USE DATABASE IDs
            if (selectedCar?.garage61_id && selectedTrack?.garage61_id) {
                const proxyUrl = `/api/garage61/laps?cars=${selectedCar.garage61_id}&tracks=${selectedTrack.garage61_id}&teams=radian-motorsport`;
                console.log('üåê Calling PROXY URL:', proxyUrl);
                
                fetch(proxyUrl)
                    .then(response => {
                        console.log('‚úÖ PROXY Response Status:', response.status, response.statusText);
                        console.log('‚úÖ PROXY Response URL:', response.url);
                        return response.json();
                    })
                    .then(data => {
                        console.log('‚úÖ PROXY Response Data:', data);
                        
                        // Show the lap times section
                        document.getElementById('garage61-lap-times').classList.remove('hidden');
                        document.getElementById('lap-times-loading').classList.add('hidden');
                        document.getElementById('lap-times-content').classList.remove('hidden');
                        
                        // Display the actual lap data in the table
                        const tbody = document.getElementById('lap-times-tbody');
                        tbody.innerHTML = ''; // Clear existing data
                        
                        if (data.items && data.items.length > 0) {
                            console.log(`üìä Got ${data.items.length} total lap records from API`);
                            
                            // FILTER THE LAPS BY SELECTED DRIVERS
                            const filteredLaps = filterLapsByDrivers(data.items);
                            console.log(`ÔøΩ After filtering: ${filteredLaps.length} laps for selected drivers`);
                            
                            if (filteredLaps.length > 0) {
                                filteredLaps.forEach(lap => {
                                console.log('üîç Processing lap:', {
                                    driver: lap.driver,
                                    lapTime: lap.lapTime,
                                    fuelUsed: lap.fuelUsed,
                                    season: lap.season,
                                    temperature: lap.temperature
                                });
                                
                                const row = document.createElement('tr');
                                row.className = 'hover:bg-neutral-600 transition-colors duration-200';
                                
                                // Use CORRECT variables from README-G61.md  
                                const driverName = lap.driver ? `${lap.driver.firstName || ''} ${lap.driver.lastName || ''}`.trim() : 'Unknown Driver';
                                
                                // Format lap time and add sector times below
                                const lapTime = lap.lapTime ? formatLapTime(lap.lapTime) : 'N/A';
                                const sectorTimes = lap.sectors && lap.sectors.length > 0 ? 
                                    lap.sectors.map((sector, i) => `S${i+1}: ${sector.sectorTime.toFixed(3)}`).join(' | ') : 
                                    '';
                                
                                const fuelUsed = lap.fuelUsed ? parseFloat(lap.fuelUsed).toFixed(2) : 'N/A';
                                
                                // Weather conditions from README
                                const cloudMap = {1: 'Clear', 2: 'Partly Cloudy', 3: 'Mostly Cloudy', 4: 'Overcast'};
                                const weather = cloudMap[lap.clouds] || 'Unknown';
                                const airTemp = lap.airTemp ? `${lap.airTemp.toFixed(1)}¬∞C` : '?¬∞C';
                                const trackTemp = lap.trackTemp ? `${lap.trackTemp.toFixed(1)}¬∞C` : '?¬∞C';
                                
                                // WIND DATA - Convert radians to compass direction and m/s to mph
                                const windSpeedMph = lap.windVel ? (lap.windVel * 2.237).toFixed(1) : '0';
                                const windDir = lap.windDir ? getWindDirection(lap.windDir) : 'N';
                                const humidity = lap.relativeHumidity ? `${(lap.relativeHumidity * 100).toFixed(0)}%` : '0%';
                                
                                // TRACK CONDITIONS
                                const trackUsage = lap.trackUsage ? `${lap.trackUsage}%` : '0%';
                                const trackWetness = lap.trackWetness ? `${lap.trackWetness}%` : '0%';
                                
                                row.innerHTML = `
                                    <td class="py-2 px-3 border-r border-neutral-700 text-xs">${driverName}</td>
                                    <td class="py-2 px-3 border-r border-neutral-700 font-mono text-blue-400 text-xs">
                                        <div>${lapTime}</div>
                                        <div class="text-neutral-400 text-xs">${sectorTimes}</div>
                                    </td>
                                    <td class="py-2 px-3 border-r border-neutral-700 text-xs">${fuelUsed}L</td>
                                    <td class="py-2 px-3 text-xs">
                                        <div class="leading-tight">
                                            <div>${weather} / ${humidity}</div>
                                            <div class="text-neutral-400">Air: ${airTemp} / Track: ${trackTemp}</div>
                                            <div class="text-neutral-300">Wind: ${windSpeedMph}mph ${windDir}</div>
                                            <div class="text-neutral-300">Usage: ${trackUsage} / Wet: ${trackWetness}</div>
                                        </div>
                                    </td>
                                `;
                                
                                tbody.appendChild(row);
                            });
                            } else {
                                tbody.innerHTML = '<tr><td colspan="4" class="py-4 px-3 text-center text-neutral-400 text-xs">No lap data found for selected drivers</td></tr>';
                            }
                        } else {
                            tbody.innerHTML = '<tr><td colspan="4" class="py-4 px-3 text-center text-neutral-400 text-xs">No lap data found</td></tr>';
                        }
                    })
                    .catch(error => {
                        console.error('‚ùå PROXY Error:', error);
                    });
            } else {
                console.log('‚ö†Ô∏è Missing garage61_id - Car:', selectedCar?.garage61_id, 'Track:', selectedTrack?.garage61_id);
            }
                     
                     //Comment out this block for testing:
             if (selectedDrivers.length === 0 || !carSelect.value || !trackSelect.value) {
                 alert("Please select at least one driver, a car, and a track before continuing.");
                 return;
             }
             
            // Debug: Check what data we have
            console.log(`üéØ Moving to Page 2 with:`);
            console.log(`   - Selected Car: "${carSelect.value}"`);
            console.log(`   - Selected Track: "${trackSelect.value}"`);
            console.log(`   - Drivers: ${selectedDrivers.length} selected`);
            console.log(`   - Global Arrays: ${drivers.length} drivers, ${cars.length} cars, ${tracks.length} tracks`);
            
            // Use the selectedCar and selectedTrack from above
            console.log(`   - Selected Car Data:`, selectedCar);
            console.log(`   - Selected Track Data:`, selectedTrack);
            
            if (!selectedCar) {
                console.error(`‚ùå Car "${carSelect.value}" not found in cars array`);
                alert(`Car data not found: "${carSelect.value}". Please try refreshing the page.`);
                return;
            }
            
            if (!selectedTrack) {
                console.error(`‚ùå Track "${trackSelect.value}" not found in tracks array`);
                alert(`Track data not found: "${trackSelect.value}". Please try refreshing the page.`);
                return;
            }
            document.getElementById('planner-page').classList.add('hidden');
            document.getElementById('page-2').classList.remove('hidden');
            document.getElementById('admin-page').classList.add('hidden');
            
            // Re-hide results sections until calculation is run on page 2
            document.getElementById('overall-summary').classList.add('hidden');
            document.getElementById('stint-breakdown-display').classList.add('hidden');
            document.getElementById('sliders-container').classList.add('hidden');
            document.getElementById('share-link-container').classList.add('hidden');

            // Populate the new display elements with the selected data
            document.getElementById('page2-track').textContent = trackSelect.value;
            document.getElementById('page2-car').textContent = carSelect.value;
            
            // Populate date and time
            const raceDate = document.getElementById('race-date').value;
            const raceTime = document.getElementById('race-time').value;
            
            document.getElementById('page2-race-date').textContent = raceDate ? new Date(raceDate).toLocaleDateString() : 'Not selected';
            document.getElementById('page2-race-time').textContent = raceTime || 'Not selected';
            
            // Calculate and display sunrise/sunset if we have track and date
            if (selectedTrack?.garage61_id && raceDate) {
                calculateDaylightForPage2(selectedTrack.garage61_id, raceDate);
            } else {
                document.getElementById('page2-sunrise').textContent = 'N/A';
                document.getElementById('page2-sunset').textContent = 'N/A';
            }
            
            // Handle weather images
            const tempUrl = document.getElementById('weather-temp-url').value;
            const cloudsUrl = document.getElementById('weather-clouds-url').value;
            displayWeatherImages(tempUrl, cloudsUrl);
            
            // Load car and track logos based on garage61 IDs
            const carLogo = document.getElementById('car-logo');
            const trackLogo = document.getElementById('track-logo');
            
            if (selectedCar && selectedCar.garage61_id) {
                carLogo.src = `assets/Cars/car-${selectedCar.garage61_id}.png`;
                carLogo.onerror = function() { this.style.display = 'none'; }; // Hide if image doesn't exist
                carLogo.onload = function() { this.classList.remove('hidden'); }; // Show if image loads
            }
            
            if (selectedTrack && selectedTrack.garage61_id) {
                trackLogo.src = `assets/Tracks/track-${selectedTrack.garage61_id}.png`;
                trackLogo.onerror = function() { this.style.display = 'none'; }; // Hide if image doesn't exist
                trackLogo.onload = function() { this.classList.remove('hidden'); }; // Show if image loads
            }
            
            // Display drivers as rows
            const driversContainer = document.getElementById('page2-drivers');
            driversContainer.innerHTML = '';
            selectedDrivers.forEach(driver => {
                const driverRow = document.createElement('div');
                driverRow.className = 'py-1';
                driverRow.textContent = driver.name;
                driversContainer.appendChild(driverRow);
            });
        }
        function showPage3() {
            document.getElementById('planner-page').classList.add('hidden');
            document.getElementById('page-2').classList.add('hidden');
            document.getElementById('page-3').classList.remove('hidden');
            document.getElementById('admin-page').classList.add('hidden');
        }

        // Global variables for daylight data
        // Track daylight data (calculated from track's lat/lng + race date)
        let trackSunriseTime = null;
        let trackSunsetTime = null;
        let trackTimezone = null;
        
        // London daylight data (calculated from London coordinates + event date)
        let londonSunriseTime = null;
        let londonSunsetTime = null;

        // Calculate London daylight times for event time display
        async function calculateLondonDaylight(date) {
            try {
                // London coordinates: 51.5074, -0.1278
                const response = await fetch('/api/daylight', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        latitude: 51.5074,
                        longitude: -0.1278,
                        date: date
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    londonSunriseTime = new Date(data.sunrise);
                    londonSunsetTime = new Date(data.sunset);
                    console.log('üá¨üáß London daylight calculated:', { sunrise: londonSunriseTime, sunset: londonSunsetTime });
                } else {
                    console.error('Failed to calculate London daylight');
                }
            } catch (error) {
                console.error('Error calculating London daylight:', error);
            }
        }

        // Calculate daylight times for page 2 display
        async function calculateDaylightForPage2(trackId, date) {
            try {
                const response = await fetch(`/api/daylight/${trackId}/${date}`);
                const data = await response.json();
                
                if (response.ok) {
                    // Store track-specific daylight data for race time calculations
                    trackSunriseTime = new Date(data.times.sunrise);
                    trackSunsetTime = new Date(data.times.sunset);
                    trackTimezone = null; // We don't need timezone, times are already correct for the location
                    
                    // Format times as HH:MM (times are already in track's local time)
                    const sunrise = trackSunriseTime.toLocaleTimeString('en-US', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: false
                    });
                    const sunset = trackSunsetTime.toLocaleTimeString('en-US', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: false
                    });
                    
                    document.getElementById('page2-sunrise').textContent = sunrise;
                    document.getElementById('page2-sunset').textContent = sunset;
                } else {
                    throw new Error(data.error || 'Failed to calculate daylight');
                }
            } catch (error) {
                console.error('Error calculating daylight for page 2:', error);
                document.getElementById('page2-sunrise').textContent = 'Error';
                document.getElementById('page2-sunset').textContent = 'Error';
                // Reset track daylight variables on error
                trackSunriseTime = null;
                trackSunsetTime = null;
                trackTimezone = null;
            }
        }

        // Function to determine daylight status for a given time
        function getDaylightStatus(stintTime, timeZone = 'UTC', mode = 'track', driverName = null) {
            if (mode === 'local' && driverName) {
                // LOCAL MODE: Use driver-specific daylight times based on their timezone/location
                const driverData = driverDaylightData[driverName];
                
                if (driverData && driverData.sunrise && driverData.sunset) {
                    // Convert stint time to driver's timezone for comparison
                    let stintTimeInDriverZone;
                    try {
                        // Create a proper date in the driver's timezone
                        const formatter = new Intl.DateTimeFormat('en-CA', {
                            timeZone: timeZone,
                            year: 'numeric', month: '2-digit', day: '2-digit',
                            hour: '2-digit', minute: '2-digit', second: '2-digit',
                            hour12: false
                        });
                        const parts = formatter.formatToParts(stintTime);
                        const year = parseInt(parts.find(p => p.type === 'year').value);
                        const month = parseInt(parts.find(p => p.type === 'month').value) - 1;
                        const day = parseInt(parts.find(p => p.type === 'day').value);
                        const hour = parseInt(parts.find(p => p.type === 'hour').value);
                        const minute = parseInt(parts.find(p => p.type === 'minute').value);
                        
                        stintTimeInDriverZone = new Date(year, month, day, hour, minute);
                    } catch (error) {
                        stintTimeInDriverZone = stintTime; // Fallback
                    }
                    
                    const stintTimeOfDay = stintTimeInDriverZone.getHours() * 60 + stintTimeInDriverZone.getMinutes();
                    const sunriseTimeOfDay = driverData.sunrise.getUTCHours() * 60 + driverData.sunrise.getUTCMinutes();
                    const sunsetTimeOfDay = driverData.sunset.getUTCHours() * 60 + driverData.sunset.getUTCMinutes();
                    
                    const dawnDuskWindow = 60; // 1 hour windows for dawn/dusk periods
                    const middayWindow = 60; // 1 hour window around solar noon for peak midday
                    
                    // Calculate solar noon (midpoint between sunrise and sunset)
                    const solarNoon = (sunriseTimeOfDay + sunsetTimeOfDay) / 2;
                    
                    // Driver-specific daylight calculation using their location's sunrise/sunset
                    if (stintTimeOfDay < (sunriseTimeOfDay - dawnDuskWindow)) {
                        return 'daylight-night';
                    } else if (stintTimeOfDay < sunriseTimeOfDay) {
                        return 'daylight-dawn'; // Red hour before sunrise
                    } else if (stintTimeOfDay < (sunriseTimeOfDay + dawnDuskWindow)) {
                        return 'daylight-post-dawn'; // Orange hour after sunrise
                    } else if (stintTimeOfDay >= (solarNoon - middayWindow/2) && stintTimeOfDay <= (solarNoon + middayWindow/2)) {
                        return 'daylight-midday'; // Peak daylight around solar noon
                    } else if (stintTimeOfDay < (sunsetTimeOfDay - (dawnDuskWindow * 2))) {
                        return 'daylight-day'; // Regular day
                    } else if (stintTimeOfDay < (sunsetTimeOfDay - dawnDuskWindow)) {
                        return 'daylight-pre-dusk'; // Orange hour 2-1 hours before sunset
                    } else if (stintTimeOfDay < sunsetTimeOfDay) {
                        return 'daylight-dusk'; // Red hour before sunset
                    } else if (stintTimeOfDay < (sunsetTimeOfDay + dawnDuskWindow)) {
                        return 'daylight-post-dusk'; // Purple hour after sunset
                    } else {
                        return 'daylight-night';
                    }
                } else {
                    // Fallback to simplified hour-based logic if no driver daylight data
                    const localHour = stintTime.getHours();
                    if (localHour >= 6 && localHour < 8) {
                        return 'daylight-dawn';
                    } else if (localHour >= 8 && localHour < 11) {
                        return 'daylight-post-dawn';
                    } else if (localHour >= 11 && localHour < 13) {
                        return 'daylight-midday';
                    } else if (localHour >= 13 && localHour < 17) {
                        return 'daylight-day';
                    } else if (localHour >= 17 && localHour < 19) {
                        return 'daylight-pre-dusk';
                    } else if (localHour >= 19 && localHour < 21) {
                        return 'daylight-dusk';
                    } else if (localHour >= 21 && localHour < 23) {
                        return 'daylight-post-dusk';
                    } else {
                        return 'daylight-night';
                    }
                }
            } else {
                // TRACK MODE: Use track location + simulator time
                if (!trackSunriseTime || !trackSunsetTime) {
                    return 'daylight-night'; // Default to night if no track daylight data
                }
                
                // Use the stint time directly (simulator time)
                const stintHours = stintTime.getUTCHours();
                const stintMinutes = stintTime.getUTCMinutes();
                const stintTimeOfDay = stintHours * 60 + stintMinutes; // Convert to minutes since midnight
                
                // Use track's sunrise/sunset times (calculated for track's lat/lng + race date)
                const sunriseHours = trackSunriseTime.getUTCHours();
                const sunriseMinutes = trackSunriseTime.getUTCMinutes();
                const sunriseTimeOfDay = sunriseHours * 60 + sunriseMinutes;
                
                const sunsetHours = trackSunsetTime.getUTCHours();
                const sunsetMinutes = trackSunsetTime.getUTCMinutes();
                const sunsetTimeOfDay = sunsetHours * 60 + sunsetMinutes;
                
                const dawnDuskWindow = 60; // 1 hour windows for dawn/dusk periods
                const middayWindow = 60; // 1 hour window around solar noon for peak midday
                
                // Calculate solar noon (midpoint between sunrise and sunset)
                const solarNoon = (sunriseTimeOfDay + sunsetTimeOfDay) / 2;
                
                // Track mode daylight calculation logic
                if (stintTimeOfDay < (sunriseTimeOfDay - dawnDuskWindow)) {
                    return 'daylight-night';
                } else if (stintTimeOfDay < sunriseTimeOfDay) {
                    return 'daylight-dawn'; // Red hour before sunrise
                } else if (stintTimeOfDay < (sunriseTimeOfDay + dawnDuskWindow)) {
                    return 'daylight-post-dawn'; // Orange hour after sunrise
                } else if (stintTimeOfDay >= (solarNoon - middayWindow/2) && stintTimeOfDay <= (solarNoon + middayWindow/2)) {
                    return 'daylight-midday'; // Peak daylight around solar noon
                } else if (stintTimeOfDay < (sunsetTimeOfDay - (dawnDuskWindow * 2))) {
                    return 'daylight-day'; // Regular day
                } else if (stintTimeOfDay < (sunsetTimeOfDay - dawnDuskWindow)) {
                    return 'daylight-pre-dusk'; // Orange hour 2-1 hours before sunset
                } else if (stintTimeOfDay < sunsetTimeOfDay) {
                    return 'daylight-dusk'; // Red hour before sunset
                } else if (stintTimeOfDay < (sunsetTimeOfDay + dawnDuskWindow)) {
                    return 'daylight-post-dusk'; // Purple hour after sunset
                } else {
                    return 'daylight-night';
                }
            }
        }

        // --- Core Logic ---

        async function calculateAndShowPage2() {
            console.log('üî•üî•üî• CALCULATE BUTTON PRESSED üî•üî•üî•');
            
            // SERVER PROXY API CALL - this is server-to-server on Render
            try {
                console.log('Making server proxy API call...');
                const response = await fetch('/api/garage61/laps?cars=1&tracks=1&teams=radian-motorsport', {
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                console.log('Proxy Response:', response.status, response.statusText);
                const data = await response.json();
                console.log('Proxy Data:', data);
            } catch (error) {
                console.log('Proxy Error:', error);
            }
            
            // Get selected values for Garage61 API call
            const carSelect = document.getElementById('car-select');
            const trackSelect = document.getElementById('track-select');
            
            if (selectedDrivers.length === 0 || !carSelect.value || !trackSelect.value) {
                alert("Please select at least one driver, a car, and a track before calculating.");
                return;
            }

            // Find selected car and track data to get Garage61 IDs
            const selectedCar = cars.find(car => car.name === carSelect.value);
            const selectedTrack = tracks.find(track => track.name === trackSelect.value);
            
            console.log('üîç DEBUG: Selected car:', selectedCar);
            console.log('üîç DEBUG: Selected track:', selectedTrack);
            console.log('üîç DEBUG: Selected drivers:', selectedDrivers);
            
            if (!selectedCar || !selectedTrack) {
                alert("Selected car or track data not found. Please refresh and try again.");
                return;
            }

            // Call Garage61 API if we have the required IDs
            console.log('üèÅ GARAGE61 IDs BEING USED:');
            console.log('   üöó Car ID:', selectedCar.garage61_id, '(for car:', selectedCar.name + ')');
            console.log('   üèüÔ∏è  Track ID:', selectedTrack.garage61_id, '(for track:', selectedTrack.name + ')');
            console.log('   üë• Driver Slugs:');
            selectedDrivers.forEach(driverName => {
                const driver = drivers.find(d => d.name === driverName);
                console.log('      -', driverName, '‚Üí', driver ? driver.garage61_slug : 'NOT FOUND');
            });
            
            console.log('ÔøΩ FORCING Garage61 API call with IDs:', selectedCar.garage61_id || 'MISSING', 'and', selectedTrack.garage61_id || 'MISSING');
            
            // DIRECT API CALL - COPY FROM WORKING garage61-api.js
            const carId = selectedCar.garage61_id || 1;
            const trackId = selectedTrack.garage61_id || 1;
            
            console.log('Making DIRECT API call to Garage61 with car:', carId, 'track:', trackId);
            
            try {
                const params = new URLSearchParams();
                params.append('cars', carId);
                params.append('tracks', trackId);
                params.append('teams', 'radian-motorsport');
                
                const url = `https://garage61.net/api/v1/laps?${params.toString()}`;
                console.log('Direct API URL:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Authorization': 'Bearer MWVKZTRMOGETNDCZOS0ZMJUZLTK2ODITNJBJZMQ5NMU4M2I5',
                        'User-Agent': 'RadianPlanner/1.0'
                    }
                });
                
                console.log('Direct API response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`Direct API Error: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ DIRECT API SUCCESS - GOT DATA:', data);
                
                // Show the lap times section (with null checks)
                const garage61Section = document.getElementById('garage61-lap-times');
                const lapTimesLoading = document.getElementById('lap-times-loading');
                const lapTimesContent = document.getElementById('lap-times-content');
                
                if (garage61Section) garage61Section.classList.remove('hidden');
                if (lapTimesLoading) lapTimesLoading.classList.add('hidden');
                if (lapTimesContent) lapTimesContent.classList.remove('hidden');
                
            } catch (error) {
                console.error('‚ùå DIRECT API FAILED:', error);
            }

            const raceDurationHours = parseInt(document.getElementById('race-duration-hours').value) || 0;
            const raceDurationMinutes = parseInt(document.getElementById('race-duration-minutes').value) || 0;
            raceDurationSeconds = (raceDurationHours * 3600) + (raceDurationMinutes * 60);

            const avgLapTimeMinutes = parseInt(document.getElementById('avg-lap-time-minutes').value) || 0;
            const avgLapTimeSeconds = parseInt(document.getElementById('avg-lap-time-seconds').value) || 0;
            let avgLapTimeInSeconds = (avgLapTimeMinutes * 60) + avgLapTimeSeconds;

            let fuelPerLap = parseFloat(document.getElementById('fuel-per-lap-display-input').value) || 0;
            const tankCapacity = parseInt(document.getElementById('tank-capacity-display-input').value) || 0;
            const pitStopTime = parseInt(document.getElementById('pit-stop-time').value) || 0;
            
            // Check if essential fields are filled
            if (raceDurationSeconds === 0 || avgLapTimeInSeconds === 0 || fuelPerLap <= 0 || tankCapacity <= 0) {
                 alert("Please ensure all race inputs are filled and valid before calculating.");
                 return;
            }

            // Apply slider adjustments
            const fuelSliderAdjustment = parseFloat(document.getElementById('fuel-slider').value) || 0;
            fuelPerLap += fuelSliderAdjustment;
            
            const lapTimeSliderAdjustment = parseInt(document.getElementById('lap-time-slider').value) || 0;
            avgLapTimeInSeconds += lapTimeSliderAdjustment;

            const lapsPerTank = Math.floor(tankCapacity / fuelPerLap);
            const totalLaps = Math.floor(raceDurationSeconds / avgLapTimeInSeconds);
            const stintDuration = lapsPerTank * avgLapTimeInSeconds;
            
            totalStints = Math.floor(totalLaps / lapsPerTank) + (totalLaps % lapsPerTank > 0 ? 1 : 0);
            lapsPerStint = lapsPerTank;
            lapsInLastStint = totalLaps % lapsPerStint;

            document.getElementById('est-laps-display').textContent = totalLaps;
            document.getElementById('stint-duration-display').textContent = formatDuration(stintDuration);
            document.getElementById('laps-per-stint-display').textContent = lapsPerStint;
            document.getElementById('pit-stops-display').textContent = totalStints - 1;
            document.getElementById('total-fuel-display').textContent = (totalLaps * fuelPerLap).toFixed(1) + ' L';
            document.getElementById('fuel-per-lap-display').textContent = fuelPerLap.toFixed(1) + ' L';
            document.getElementById('lap-time-display').textContent = `${Math.floor(avgLapTimeInSeconds / 60)}:${(avgLapTimeInSeconds % 60).toFixed(0).padStart(2, '0')}`;
            document.getElementById('pit-stop-duration-display').textContent = `${pitStopTime} sec`;

            populateStintTable(avgLapTimeInSeconds);
            
            // Show results sections after successful calculation
            document.getElementById('overall-summary').classList.remove('hidden');
            document.getElementById('stint-breakdown-display').classList.remove('hidden');
            document.getElementById('sliders-container').classList.remove('hidden');
            document.getElementById('share-link-container').classList.remove('hidden');
       
            // Show the button to go to the third page after calculation (if it exists)
            const page3Button = document.getElementById('page3-button-container');
            if (page3Button) {
                page3Button.classList.remove('hidden');
            }
        }

        // Weather Display Functions
        function displayWeatherImages(tempUrl, cloudsUrl) {
            console.log('üå¶Ô∏è Displaying weather images:', { tempUrl, cloudsUrl });
            
            const weatherDisplay = document.getElementById('weather-display');
            const tempContainer = document.getElementById('temp-chart-container');
            const cloudsContainer = document.getElementById('clouds-chart-container');
            const tempChart = document.getElementById('temp-chart');
            const cloudsChart = document.getElementById('clouds-chart');
            
            // Hide weather section by default
            weatherDisplay.classList.add('hidden');
            tempContainer.classList.add('hidden');
            cloudsContainer.classList.add('hidden');
            
            // Check if we have any weather URLs
            if (!tempUrl && !cloudsUrl) {
                console.log('No weather URLs provided, hiding weather section');
                return;
            }
            
            // Show weather section if we have at least one URL
            weatherDisplay.classList.remove('hidden');
            
            // Handle temperature chart
            if (tempUrl && tempUrl.trim()) {
                const convertedTempUrl = convertToRawGitHubUrl(tempUrl.trim());
                tempChart.src = convertedTempUrl;
                tempContainer.classList.remove('hidden');
                tempChart.onerror = function() { 
                    console.warn('Failed to load temperature chart:', convertedTempUrl);
                    console.warn('Original URL was:', tempUrl.trim());
                    tempContainer.classList.add('hidden');
                };
                console.log('üå°Ô∏è Loading temperature chart:', convertedTempUrl);
            }
            
            // Handle clouds/precipitation chart
            if (cloudsUrl && cloudsUrl.trim()) {
                const convertedCloudsUrl = convertToRawGitHubUrl(cloudsUrl.trim());
                cloudsChart.src = convertedCloudsUrl;
                cloudsContainer.classList.remove('hidden');
                cloudsChart.onerror = function() { 
                    console.warn('Failed to load clouds chart:', convertedCloudsUrl);
                    console.warn('Original URL was:', cloudsUrl.trim());
                    cloudsContainer.classList.add('hidden');
                };
                console.log('‚òÅÔ∏è Loading clouds chart:', convertedCloudsUrl);
            }
        }

        // Function to convert regular GitHub URLs to raw URLs
        function convertToRawGitHubUrl(url) {
            // If it's already a raw URL, return as-is
            if (url.includes('raw.githubusercontent.com')) {
                return url;
            }
            
            // Convert github.com blob URLs to raw URLs
            if (url.includes('github.com') && url.includes('/blob/')) {
                // Pattern: https://github.com/user/repo/blob/branch/path
                // Convert to: https://raw.githubusercontent.com/user/repo/branch/path
                const converted = url
                    .replace('github.com', 'raw.githubusercontent.com')
                    .replace('/blob/', '/');
                console.log('üîÑ Converted GitHub URL:', url, '‚Üí', converted);
                return converted;
            }
            
            // If it's not a GitHub URL, return as-is
            return url;
        }

        // Garage61 API Functions
        async function fetchGarage61Data(carId, trackId) {
            console.log(`üî• fetchGarage61Data called with carId: ${carId}, trackId: ${trackId}`);
            
            const lapTimesSection = document.getElementById('garage61-lap-times');
            const loadingDiv = document.getElementById('lap-times-loading');
            const errorDiv = document.getElementById('lap-times-error');
            const contentDiv = document.getElementById('lap-times-content');
            const tbody = document.getElementById('lap-times-tbody');
            
            console.log('üîç Elements found:', {
                lapTimesSection: !!lapTimesSection,
                loadingDiv: !!loadingDiv,
                errorDiv: !!errorDiv,
                contentDiv: !!contentDiv,
                tbody: !!tbody
            });
            
            // Show loading state
            lapTimesSection.classList.remove('hidden');
            loadingDiv.classList.remove('hidden');
            errorDiv.classList.add('hidden');
            contentDiv.classList.add('hidden');

            try {
                console.log(`Fetching Garage61 data for car ${carId} at track ${trackId}`);
                
                // Call Garage61 API directly
                const response = await callGarage61API(carId, trackId);
                
                console.log('üî• API Response:', response);
                
                if (!response.success) {
                    throw new Error(response.error || 'API call failed');
                }

                // Filter laps by selected drivers
                const filteredLaps = filterLapsByDrivers(response.data);
                
                console.log('üî• Filtered laps:', filteredLaps);
                
                // Group laps by driver and get best lap for each
                const driverBestLaps = getDriverBestLaps(filteredLaps);
                
                console.log('üî• Driver best laps:', driverBestLaps);
                
                // Display the results
                displayLapTimes(driverBestLaps, tbody);
                
                // Show content
                loadingDiv.classList.add('hidden');
                contentDiv.classList.remove('hidden');

            } catch (error) {
                console.error('üö® Garage61 API Error:', error);
                
                // Show error
                loadingDiv.classList.add('hidden');
                document.getElementById('lap-times-error-message').textContent = error.message;
                errorDiv.classList.remove('hidden');
            }
        }

        async function callGarage61API(carId, trackId) {
            const TEAM_NAME = 'radian-motorsport';
            
            const params = new URLSearchParams();
            params.append('cars', carId);
            params.append('tracks', trackId);
            params.append('teams', TEAM_NAME);
            
            const proxyUrl = `/api/garage61/laps?${params.toString()}`;
            
            console.log('üåê Using server proxy URL:', proxyUrl);
            
            const response = await fetch(proxyUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                }
            });

            console.log('üì° Proxy response status:', response.status, response.statusText);

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error || `Proxy Error: ${response.status} ${response.statusText}`);
            }

            const data = await response.json();
            
            console.log('üì¶ Server proxy data received:', {
                total: data.total,
                itemsCount: data.items ? data.items.length : 0,
                firstItem: data.items && data.items.length > 0 ? data.items[0] : null
            });
            
            return {
                success: true,
                data: data.items || [],
                total: data.total || 0
            };
        }

        function filterLapsByDrivers(laps) {
            console.log('üîç DEBUG: filterLapsByDrivers called with:', laps.length, 'laps');
            console.log('üîç DEBUG: selectedDrivers:', selectedDrivers);
            
            if (!selectedDrivers || selectedDrivers.length === 0) {
                console.log('üîç DEBUG: No selected drivers, returning all laps');
                return laps;
            }

            // Get garage61_slug values for selected drivers
            const selectedDriverSlugs = selectedDrivers.map(driver => driver.garage61_slug).filter(slug => slug !== null);
            const selectedDriverNames = selectedDrivers.map(driver => driver.name);

            console.log('üîç DEBUG: Filtering for driver slugs:', selectedDriverSlugs);
            console.log('üîç DEBUG: Filtering for driver names:', selectedDriverNames);
            
            // Show first few laps to see structure
            console.log('üîç DEBUG: Sample lap structure:', laps.slice(0, 2));

            const filtered = laps.filter(lap => {
                const driverSlug = lap.driver ? lap.driver.slug : null;
                const driverName = lap.driver ? lap.driver.name : null;
                
                console.log(`üîç DEBUG: Checking lap - driver: ${driverName}, slug: ${driverSlug}`);
                
                const slugMatch = selectedDriverSlugs.some(slug => 
                    (driverSlug && driverSlug.toLowerCase() === slug.toLowerCase())
                );
                const nameMatch = selectedDriverNames.some(name => 
                    (driverName && name.toLowerCase().includes(driverName.toLowerCase())) ||
                    (driverName && driverName.toLowerCase().includes(name.toLowerCase()))
                );
                
                const matches = slugMatch || nameMatch;
                console.log(`üîç DEBUG: Lap matches: ${matches} (slug: ${slugMatch}, name: ${nameMatch})`);
                return matches;
            });
            
            console.log('üîç DEBUG: Filtered result:', filtered.length, 'laps');
            return filtered;
        }

        function getDriverBestLaps(laps) {
            const driverLaps = {};
            
            laps.forEach(lap => {
                const driverName = lap.driver ? lap.driver.name : 'Unknown';
                
                if (!driverLaps[driverName] || lap.lapTime < driverLaps[driverName].lapTime) {
                    driverLaps[driverName] = lap;
                }
            });
            
            return Object.values(driverLaps).sort((a, b) => a.lapTime - b.lapTime);
        }

        function displayLapTimes(bestLaps, tbody) {
            tbody.innerHTML = '';
            
            if (bestLaps.length === 0) {
                tbody.innerHTML = `
                    <tr class="bg-neutral-750">
                        <td colspan="4" class="py-6 px-6 text-center text-neutral-400 italic">
                            No lap data found for selected drivers at this car/track combination
                        </td>
                    </tr>
                `;
                return;
            }

            bestLaps.forEach((lap, index) => {
                const driverName = lap.driver ? lap.driver.name : 'Unknown';
                const lapTime = formatLapTime(lap.lapTime);
                const fuelUsed = lap.fuelUsed ? lap.fuelUsed.toFixed(1) + 'L' : 'N/A';
                const conditions = getConditionsText(lap);
                const rowClass = index % 2 === 0 ? 'bg-neutral-750' : 'bg-neutral-800';

                tbody.innerHTML += `
                    <tr class="${rowClass} hover:bg-neutral-800 transition-colors duration-200">
                        <td class="py-3 px-6 border-r border-neutral-700 font-semibold text-neutral-200">${driverName}</td>
                        <td class="py-3 px-6 border-r border-neutral-700 text-green-400 font-mono">${lapTime}</td>
                        <td class="py-3 px-6 border-r border-neutral-700 text-neutral-300">${fuelUsed}</td>
                        <td class="py-3 px-6 text-neutral-400 text-sm">${conditions}</td>
                    </tr>
                `;
            });
        }

        function formatLapTime(seconds) {
            if (!seconds || seconds <= 0) return 'N/A';
            
            const minutes = Math.floor(seconds / 60);
            const secs = (seconds % 60).toFixed(3);
            
            return `${minutes}:${secs.padStart(6, '0')}`;
        }

        function getConditionsText(lap) {
            const parts = [];
            
            if (lap.trackTemp) {
                parts.push(`Track: ${lap.trackTemp.toFixed(1)}¬∞C`);
            }
            
            if (lap.trackUsage) {
                parts.push(`Usage: ${lap.trackUsage}%`);
            }
            
            if (lap.clouds) {
                const cloudTypes = { 1: 'Clear', 2: 'Partly', 3: 'Mostly', 4: 'Overcast' };
                parts.push(cloudTypes[lap.clouds] || `Cloud ${lap.clouds}`);
            }
            
            return parts.length > 0 ? parts.join(', ') : 'N/A';
        }

        
        function formatDuration(totalSeconds) {
            if (totalSeconds <= 0) return '0s';
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = Math.floor(totalSeconds % 60);
            
            const parts = [];
            if (hours > 0) parts.push(`${hours}h`);
            if (minutes > 0) parts.push(`${minutes}m`);
            if (seconds > 0) parts.push(`${seconds}s`);
            
            return parts.length > 0 ? parts.join(' ') : '0s';
        }

        function formatTime(date) {
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const seconds = date.getSeconds().toString().padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }
        
        // --- Populating Dropdowns and Lists ---

        function populateDrivers() {
            const select = document.getElementById('driver-select');
            if (!select) {
                console.error('‚ùå Driver select element not found');
                return;
            }
            select.innerHTML = '<option value="">Select a Driver...</option>';
            if (!drivers || drivers.length === 0) {
                console.warn('‚ö†Ô∏è No drivers data available');
                select.innerHTML = '<option value="">No drivers available</option>';
                return;
            }
            
            // Sort drivers alphabetically by name
            const sortedDrivers = [...drivers].sort((a, b) => a.name.localeCompare(b.name));
            
            sortedDrivers.forEach(driver => {
                const option = document.createElement('option');
                option.value = driver.name;
                option.textContent = driver.name;
                select.appendChild(option);
            });
            console.log(`‚úÖ Populated ${drivers.length} drivers (sorted alphabetically)`);
        }
        function populateCars() {
            const select = document.getElementById('car-select');
            if (!select) {
                console.error('‚ùå Car select element not found');
                return;
            }
            select.innerHTML = '<option value="">Select a Car...</option>';
            if (!cars || cars.length === 0) {
                console.warn('‚ö†Ô∏è No cars data available');
                select.innerHTML = '<option value="">No cars available</option>';
                return;
            }
            
            // Sort cars alphabetically by name
            const sortedCars = [...cars].sort((a, b) => a.name.localeCompare(b.name));
            
            sortedCars.forEach(car => {
                const option = document.createElement('option');
                option.value = car.name;
                option.textContent = car.name;
                select.appendChild(option);
            });
            console.log(`‚úÖ Populated ${cars.length} cars (sorted alphabetically)`);
        }
        function populateTracks() {
            const select = document.getElementById('track-select');
            if (!select) {
                console.error('‚ùå Track select element not found');
                return;
            }
            select.innerHTML = '<option value="">Select a Track...</option>';
            if (!tracks || tracks.length === 0) {
                console.warn('‚ö†Ô∏è No tracks data available');
                select.innerHTML = '<option value="">No tracks available</option>';
                return;
            }
            
            // Sort tracks alphabetically by name
            const sortedTracks = [...tracks].sort((a, b) => a.name.localeCompare(b.name));
            
            sortedTracks.forEach(track => {
                const option = document.createElement('option');
                option.value = track.name;
                option.textContent = track.name;
                select.appendChild(option);
            });
            console.log(`‚úÖ Populated ${tracks.length} tracks (sorted alphabetically)`);
        }
        function addDriver() {
            const select = document.getElementById('driver-select');
            const driverName = select.value;
            if (driverName && selectedDrivers.length < 6) {
                const driver = drivers.find(d => d.name === driverName);
                if (driver && !selectedDrivers.includes(driver)) {
                    selectedDrivers.push(driver);
                    renderDriverList();
                    select.value = '';
                }
            }
        }
        function removeDriver(name) {
            selectedDrivers = selectedDrivers.filter(driver => driver.name !== name);
            renderDriverList();
        }
        function renderDriverList() {
            const list = document.getElementById('driver-list');
            list.innerHTML = '';
            selectedDrivers.forEach(driver => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between bg-neutral-800 p-3 rounded-lg shadow-sm';
                li.innerHTML = `<span>${driver.name}</span> <button onclick="removeDriver('${driver.name}')" class="text-red-500 hover:text-red-700 transition-colors duration-200"><i class="fas fa-trash-alt"></i></button>`;
                list.appendChild(li);
            });
        }
        function populateStintTable(avgLapTimeInSeconds, preserveDriverAssignments = false) {
				    const tbody = document.getElementById('stint-table-body');
				    
				    // üîß PRESERVE DRIVER ASSIGNMENTS BEFORE CLEARING TABLE
				    let savedDriverAssignments = {};
				    let savedBackupAssignments = {};
				    
				    if (preserveDriverAssignments && tbody.children.length > 0) {
				        console.log('üíæ Preserving driver assignments...');
				        // Save current driver assignments
				        for (let i = 0; i < 50; i++) {
				            const driverSelect = document.getElementById(`stint-driver-${i}`);
				            const backupSelect = document.getElementById(`stint-backup-driver-${i}`);
				            
				            if (driverSelect && driverSelect.value) {
				                savedDriverAssignments[i] = driverSelect.value;
				            }
				            if (backupSelect && backupSelect.value) {
				                savedBackupAssignments[i] = backupSelect.value;
				            }
				            
				            if (!driverSelect) break;
				        }
				        console.log('üíæ Saved assignments:', savedDriverAssignments);
				    }
				    
				    tbody.innerHTML = '';
				    
				    const raceStartTimeInput = document.getElementById('race-time').value;
				    const practiceQualifyingHours = 0; // Removed qualifying time functionality  
				    const pitStopTime = parseInt(document.getElementById('pit-stop-time').value) || 0;
				    
				    let currentTime;
				    
				    if (isLocalTimeMode) {
				        // LOCAL TIME MODE: Use event start date & time and convert to driver's timezone for display
				        const eventStartTimeInput = document.getElementById('event-start-time').value;
				        const eventStartDateInput = document.getElementById('event-start-date').value;
				        
				        if (eventStartTimeInput && eventStartDateInput) {
				            // Create a base date object using the event date and event start time
				            const [eventHours, eventMinutes] = eventStartTimeInput.split(':').map(Number);
				            const [year, month, day] = eventStartDateInput.split('-').map(Number);
				            
				            // Create date in Europe/London time (event timezone)
				            currentTime = new Date(year, month - 1, day, eventHours, eventMinutes);
				            console.log('üåç Local Time Mode - Event Date & Time:', currentTime.toISOString());
				        } else {
				            // Fallback to race time if no event time/date set
				            const [hours, minutes] = raceStartTimeInput.split(':').map(Number);
				            const today = new Date();
				            currentTime = new Date(today.getFullYear(), today.getMonth(), today.getDate(), hours, minutes);
				            console.log('ÔøΩ Local Time Fallback to Race Time:', currentTime.toISOString());
				        }
				    } else {
				        // RACE TIME MODE: Use race time from page 1 (simulator time)
				        const [hours, minutes] = raceStartTimeInput.split(':').map(Number);
				        const raceDate = document.getElementById('race-date').value;
				        
				        if (raceDate) {
				            const [year, month, day] = raceDate.split('-').map(Number);
				            currentTime = new Date(year, month - 1, day, hours, minutes);
				        } else {
				            const today = new Date();
				            currentTime = new Date(today.getFullYear(), today.getMonth(), today.getDate(), hours, minutes);
				        }
				        console.log('üèÅ Race Time Mode:', currentTime.toISOString());
				    }
				    
				    // Determine which timezone to use for formatting and daylight calculation
				    let displayTimeZone;
				    let daylightCalculationMode;
				    let selectedDriverName = null;
				    
				    if (isLocalTimeMode) {
				        const selectedDriverDropdown = document.getElementById('driver-timezone-dropdown');
				        selectedDriverName = selectedDriverDropdown.value;
				        displayTimeZone = selectedDriverDropdown.options[selectedDriverDropdown.selectedIndex]?.dataset.timezone || 'Europe/London';
				        daylightCalculationMode = 'local'; // Use driver's current local time
				    } else {
				        displayTimeZone = 'UTC'; // Race time is typically UTC
				        daylightCalculationMode = 'track'; // Use track location + simulator time
				    }
				    
				    let currentLap = 1;
				    let driverIndex = 0;
				    
				    for (let i = 0; i < totalStints; i++) {
				        const stintLaps = (i === totalStints - 1) && (lapsInLastStint !== 0) ? lapsInLastStint : lapsPerStint;
				        if (stintLaps <= 0) break;
				    
				        // Store stint start time for daylight calculation
				        const stintStartTime = new Date(currentTime.getTime());
				        
				        // Format the start time for the selected timezone
				        const startTimeString = formatTimeWithTimezone(currentTime, displayTimeZone);
				        
				        const stintDurationSeconds = stintLaps * avgLapTimeInSeconds;
				        currentTime.setSeconds(currentTime.getSeconds() + stintDurationSeconds);
				        
				        // Format the end time for the selected timezone
				        const endTimeString = formatTimeWithTimezone(currentTime, displayTimeZone);
				        
				        const startLap = currentLap;
				        const endLap = startLap + stintLaps - 1;
				        
				        // Get daylight status for stint start time 
				        const daylightStatus = getDaylightStatus(stintStartTime, displayTimeZone, daylightCalculationMode, selectedDriverName);
				        
				        // Create driving stint row
				        const tr = document.createElement('tr');
				        tr.id = `stint-row-${i}`;  // Add ID for easy targeting
				        tr.innerHTML = `
				            <td class="px-1 py-2 text-center text-s text-neutral-200 border-r border-neutral-900">${startTimeString}</td>
				            <td class="px-1 py-2 text-center text-s text-neutral-200 border-r border-neutral-900">${endTimeString}</td>
				            <td class="px-1 py-2 text-center text-s text-neutral-200 border-r border-neutral-900">${startLap}</td>
				            <td class="px-1 py-2 text-center text-s text-neutral-200 border-r border-neutral-900">${endLap}</td>
				            <td class="px-1 py-2 text-center text-s text-neutral-200 border-r border-neutral-900">${stintLaps}</td>
				            <td id="daylight-cell-${i}" class="w-4 px-1 py-2 text-center text-xs font-medium border-r border-neutral-900 ${daylightStatus}"></td>
				            <td class="px-1 py-2 text-center text-s text-neutral-200 border-r border-neutral-900">
				                <select id="stint-driver-${i}" class="w-auto bg-neutral-800 text-neutral-200 p-1 rounded-md border border-neutral-900"></select>
				            </td>
				            <td class="px-1 py-2 text-center text-s text-neutral-200">
				                <select id="stint-backup-driver-${i}" class="w-auto bg-neutral-800 text-neutral-200 p-1 rounded-md border border-neutral-900"></select>
				            </td>
				        `;
				        tbody.appendChild(tr);
				    
				        populateStintDrivers(i, selectedDrivers);
				    
				        currentLap = endLap + 1;
				        driverIndex = (driverIndex + 1) % selectedDrivers.length;
				        
				        // Add pit stop row (except after the last stint)
				        if (i < totalStints - 1) {
				            const pitStartTime = new Date(currentTime);
				            currentTime.setSeconds(currentTime.getSeconds() + pitStopTime);
				            const pitEndTime = new Date(currentTime);
				            
			            const pitStartTimeString = formatTimeWithTimezone(pitStartTime, displayTimeZone);
			            const pitEndTimeString = formatTimeWithTimezone(pitEndTime, displayTimeZone);				            // Format pit stop duration (convert seconds to mm:ss)
				            const pitMinutes = Math.floor(pitStopTime / 60);
				            const pitSeconds = pitStopTime % 60;
				            const pitDurationString = `${pitMinutes.toString().padStart(2, '0')}:${pitSeconds.toString().padStart(2, '0')}`;
				            
		            // Get daylight status for pit stop time
		            const pitDaylightStatus = getDaylightStatus(pitStartTime, displayTimeZone, daylightCalculationMode, selectedDriverName);				            const pitRow = document.createElement('tr');
				            pitRow.classList.add('pit-stop-row');
				            pitRow.innerHTML = `
				                <td class="px-1 py-2 text-center text-xs text-neutral-200 border-r border-neutral-900">${pitStartTimeString}</td>
				                <td class="px-1 py-2 text-center text-xs text-neutral-200 border-r border-neutral-900">${pitEndTimeString}</td>
				                <td class="px-1 py-2 text-center text-xs text-neutral-200 road-rage-font border-r border-neutral-900">PIT</td>
				                <td class="px-1 py-2 text-center text-xs text-neutral-200 road-rage-font border-r border-neutral-900">PIT</td>
				                <td class="px-1 py-2 text-center text-xs text-neutral-200 border-r border-neutral-900">${pitDurationString}</td>
				                <td class="w-4 px-1 py-2 text-center text-xs text-neutral-400 border-r border-neutral-900 ${pitDaylightStatus}"></td>
				                <td class="px-1 py-2 text-center text-xs text-neutral-400 border-r border-neutral-900">-</td>
				                <td class="px-1 py-2 text-center text-s text-neutral-400">-</td>
				            `;
				            tbody.appendChild(pitRow);
				        }
				    }
				    
				    // üîß RESTORE SAVED DRIVER ASSIGNMENTS
				    if (preserveDriverAssignments && Object.keys(savedDriverAssignments).length > 0) {
				        console.log('üîÑ Restoring driver assignments...');
				        setTimeout(() => {
				            // Wait for dropdowns to be populated, then restore assignments
				            Object.keys(savedDriverAssignments).forEach(stintIndex => {
				                const driverSelect = document.getElementById(`stint-driver-${stintIndex}`);
				                if (driverSelect && savedDriverAssignments[stintIndex]) {
				                    driverSelect.value = savedDriverAssignments[stintIndex];
				                    // Trigger color update if that function exists
				                    if (typeof updateStintRowColor === 'function') {
				                        updateStintRowColor(parseInt(stintIndex), savedDriverAssignments[stintIndex], selectedDrivers);
				                    }
				                }
				            });
				            
				            Object.keys(savedBackupAssignments).forEach(stintIndex => {
				                const backupSelect = document.getElementById(`stint-backup-driver-${stintIndex}`);
				                if (backupSelect && savedBackupAssignments[stintIndex]) {
				                    backupSelect.value = savedBackupAssignments[stintIndex];
				                }
				            });
				            
				            console.log('‚úÖ Driver assignments restored successfully!');
				        }, 100); // Small delay to ensure dropdowns are populated
				    }
				    
				    // üåÖ DEBUG: Display daylight times for different timezones
				    debugDaylightTimes();
				}
        
        // üåÖ DEBUG FUNCTION: Display daylight times for different timezones
        function debugDaylightTimes() {
            if (!trackSunriseTime || !trackSunsetTime) {
                console.log('üåÖ No track daylight data available for debugging');
                return;
            }
            
            console.log('üåÖ ======== DAYLIGHT DEBUGGING ========');
            
            // Calculate solar noon from track sunrise/sunset
            const sunriseMinutes = trackSunriseTime.getUTCHours() * 60 + trackSunriseTime.getUTCMinutes();
            const sunsetMinutes = trackSunsetTime.getUTCHours() * 60 + trackSunsetTime.getUTCMinutes();
            const solarNoonMinutes = (sunriseMinutes + sunsetMinutes) / 2;
            const solarNoonHours = Math.floor(solarNoonMinutes / 60);
            const solarNoonMins = Math.floor(solarNoonMinutes % 60);
            
            // Format times - track daylight times are Date objects from server
            const formatTimeForTrack = (dateObj) => {
                return dateObj.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
            };
            
            const formatTimeInTimezone = (dateObj, timezone) => {
                try {
                    return dateObj.toLocaleTimeString('en-US', {
                        timeZone: timezone,
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    });
                } catch (error) {
                    return `${dateObj.getHours().toString().padStart(2, '0')}:${dateObj.getMinutes().toString().padStart(2, '0')} (${timezone})`;
                }
            };
            
            // Track location times (from track's lat/lng + race date)
            console.log('üèÅ RACE TIME (Track Location):');
            console.log(`   Sunrise: ${formatTimeForTrack(trackSunriseTime)}`);
            console.log(`   Midday:  ${formatTimeForTrack(new Date(2000, 0, 1, solarNoonHours, solarNoonMins))}`);
            console.log(`   Sunset:  ${formatTimeForTrack(trackSunsetTime)}`);
            console.log(`   Track Timezone: ${trackTimezone || 'Unknown'}`);
            
            // Event time (Europe/London) - using London coordinates
            console.log('üá¨üáß EVENT TIME (Europe/London):');
            if (londonSunriseTime && londonSunsetTime) {
                const londonNoon = new Date((londonSunriseTime.getTime() + londonSunsetTime.getTime()) / 2);
                console.log(`   Sunrise: ${formatTimeInTimezone(londonSunriseTime, 'Europe/London')}`);
                console.log(`   Midday:  ${formatTimeInTimezone(londonNoon, 'Europe/London')}`);
                console.log(`   Sunset:  ${formatTimeInTimezone(londonSunsetTime, 'Europe/London')}`);
            } else {
                console.log(`   London daylight data not calculated yet`);
            }
            
            // Selected drivers' timezones with their location-specific daylight
            const drivers = getSelectedDrivers();
            if (drivers && drivers.length > 0) {
                console.log('üë• DRIVER TIMEZONES (using driver location daylight):');
                drivers.forEach(driver => {
                    if (driver.timezone) {
                        const driverData = driverDaylightData[driver.name];
                        if (driverData) {
                            console.log(`   ${driver.name} (${driver.timezone}):`);
                            console.log(`     Sunrise: ${formatTimeInTimezone(driverData.sunrise, driver.timezone)}`);
                            console.log(`     Midday:  ${formatTimeInTimezone(new Date((driverData.sunrise.getTime() + driverData.sunset.getTime()) / 2), driver.timezone)}`);
                            console.log(`     Sunset:  ${formatTimeInTimezone(driverData.sunset, driver.timezone)}`);
                        } else {
                            console.log(`   ${driver.name} (${driver.timezone}): Driver daylight data not loaded`);
                        }
                    } else {
                        console.log(`   ${driver.name}: No timezone set`);
                    }
                });
            } else {
                console.log('üë• No drivers selected for timezone debugging');
            }
            
            console.log('üåÖ ===================================');
        }
        
        // üîß NEW FUNCTION: Update times without losing driver assignments
        function updateTimesOnly() {
            console.log('üïí Updating times while preserving driver assignments...');
            
            const carSelect = document.getElementById('car-select');
            const trackSelect = document.getElementById('track-select');
            
            if (!carSelect.value || !trackSelect.value) {
                alert("Please select a car and track first.");
                return;
            }
            
            // Get the current average lap time
            const avgLapTimeMinutes = parseInt(document.getElementById('avg-lap-time-minutes').value) || 0;
            const avgLapTimeSeconds = parseFloat(document.getElementById('avg-lap-time-seconds').value) || 0;
            const lapTimeSliderValue = parseInt(document.getElementById('lap-time-slider').value) || 0;
            
            const baseAvgLapTimeInSeconds = (avgLapTimeMinutes * 60) + avgLapTimeSeconds;
            const adjustedAvgLapTimeInSeconds = baseAvgLapTimeInSeconds + lapTimeSliderValue;
            
            if (adjustedAvgLapTimeInSeconds <= 0) {
                alert("Please set a valid average lap time.");
                return;
            }
            
            // Only update the stint table times, preserving driver assignments
            populateStintTable(adjustedAvgLapTimeInSeconds, true); // true = preserve assignments
        }
        
        async function generateShareLink() {
		    // Capture driver stint assignments
		    const stintDrivers = {};
		    const stintBackupDrivers = {};
		    
		    // Loop through all possible stint driver selects
		    for (let i = 0; i < 50; i++) {
		        const driverSelect = document.getElementById(`stint-driver-${i}`);
		        const backupDriverSelect = document.getElementById(`stint-backup-driver-${i}`);
		        
		        if (driverSelect && driverSelect.value) {
		            stintDrivers[i] = driverSelect.value;
		        }
		        
		        if (backupDriverSelect && backupDriverSelect.value) {
		            stintBackupDrivers[i] = backupDriverSelect.value;
		        }
		        
		        // Stop if we've gone past existing stints
		        if (!driverSelect) break;
		    }
		    
		    const state = {
		        drivers: selectedDrivers.map(d => d.name),
		        car: document.getElementById('car-select').value,
		        track: document.getElementById('track-select').value,
		        raceDurationHours: document.getElementById('race-duration-hours').value,
		        raceDurationMinutes: document.getElementById('race-duration-minutes').value,
		        avgLapTimeMinutes: document.getElementById('avg-lap-time-minutes').value,
		        avgLapTimeSeconds: document.getElementById('avg-lap-time-seconds').value,
		        pitStopTime: document.getElementById('pit-stop-time').value,
		        fuelPerLapInput: document.getElementById('fuel-per-lap-display-input').value,
		        tankCapacityInput: document.getElementById('tank-capacity-display-input').value,
		        fuelSlider: document.getElementById('fuel-slider').value,
		        lapTimeSlider: document.getElementById('lap-time-slider').value,
		        raceStartTime: document.getElementById('race-start-time-page2').value,
		        // Removed practice qualifying time and local time functionality
		        eventStartTimeInput: document.getElementById('event-start-time').value,
		        eventStartDateInput: document.getElementById('event-start-date').value,
		        // timezone: document.getElementById('timezone-select').value, // REMOVED - using driver timezones
		        // summertime: document.getElementById('summertime-checkbox').checked, // REMOVED
		        weatherTempUrl: document.getElementById('weather-temp-url').value,
		        weatherCloudsUrl: document.getElementById('weather-clouds-url').value,
		        // Track daylight data (from track lat/lng + race date)
		        trackSunrise: trackSunriseTime ? trackSunriseTime.toISOString() : null,
		        trackSunset: trackSunsetTime ? trackSunsetTime.toISOString() : null,
		        trackTimezone: trackTimezone,
		        stintDrivers: stintDrivers, // Save stint driver assignments
		        stintBackupDrivers: stintBackupDrivers // Save stint backup driver assignments
		    };

		    try {
		        const response = await fetch('/api/strategies', {
		            method: 'POST',
		            headers: {
		                'Content-Type': 'application/json',
		            },
		            body: JSON.stringify(state),
		        });
		
		        if (!response.ok) {
		            throw new Error('Failed to save strategy.');
		        }
		
		        const data = await response.json();
		        const shareLink = `${window.location.origin}${window.location.pathname}?id=${data.id}`;
		        document.getElementById('share-link-output').value = shareLink;
		        
		        // Store the strategy ID for future updates
		        window.currentStrategyId = data.id;
		        
		        // Show the Save Update button
		        document.getElementById('save-update-btn').classList.remove('hidden');
		
		    } catch (error) {
		        console.error('Error saving strategy:', error);
		        alert('Could not save strategy. Please try again.');
		    }
		}
        
        // Function to update existing strategy
        async function updateShareLink() {
            if (!window.currentStrategyId) {
                alert('No strategy to update. Generate a link first.');
                return;
            }
            
		    // Capture driver stint assignments
		    const stintDrivers = {};
		    const stintBackupDrivers = {};
		    
		    // Loop through all possible stint driver selects
		    for (let i = 0; i < 50; i++) {
		        const driverSelect = document.getElementById(`stint-driver-${i}`);
		        const backupDriverSelect = document.getElementById(`stint-backup-driver-${i}`);
		        
		        if (driverSelect && driverSelect.value) {
		            stintDrivers[i] = driverSelect.value;
		        }
		        
		        if (backupDriverSelect && backupDriverSelect.value) {
		            stintBackupDrivers[i] = backupDriverSelect.value;
		        }
		        
		        // Stop if we've gone past existing stints
		        if (!driverSelect) break;
		    }
            
		    const state = {
		        drivers: selectedDrivers.map(d => d.name),
		        car: document.getElementById('car-select').value,
		        track: document.getElementById('track-select').value,
		        raceDurationHours: document.getElementById('race-duration-hours').value,
		        raceDurationMinutes: document.getElementById('race-duration-minutes').value,
		        avgLapTimeMinutes: document.getElementById('avg-lap-time-minutes').value,
		        avgLapTimeSeconds: document.getElementById('avg-lap-time-seconds').value,
		        pitStopTime: document.getElementById('pit-stop-time').value,
		        fuelPerLapInput: document.getElementById('fuel-per-lap-display-input').value,
		        tankCapacityInput: document.getElementById('tank-capacity-display-input').value,
		        fuelSlider: document.getElementById('fuel-slider').value,
		        lapTimeSlider: document.getElementById('lap-time-slider').value,
		        raceStartTime: document.getElementById('race-start-time-page2').value,
		        // Removed practice qualifying time and local time functionality
		        eventStartTimeInput: document.getElementById('event-start-time').value,
		        eventStartDateInput: document.getElementById('event-start-date').value,
		        // timezone: document.getElementById('timezone-select').value, // REMOVED - using driver timezones
		        // summertime: document.getElementById('summertime-checkbox').checked, // REMOVED
		        weatherTempUrl: document.getElementById('weather-temp-url').value,
		        weatherCloudsUrl: document.getElementById('weather-clouds-url').value,
		        // Track daylight data (from track lat/lng + race date)
		        trackSunrise: trackSunriseTime ? trackSunriseTime.toISOString() : null,
		        trackSunset: trackSunsetTime ? trackSunsetTime.toISOString() : null,
		        trackTimezone: trackTimezone,
		        stintDrivers: stintDrivers, // Save stint driver assignments
		        stintBackupDrivers: stintBackupDrivers // Save stint backup driver assignments
		    };

		    try {
		        const response = await fetch(`/api/strategies/${window.currentStrategyId}`, {
		            method: 'PUT',
		            headers: {
		                'Content-Type': 'application/json',
		            },
		            body: JSON.stringify(state),
		        });
		
		        if (!response.ok) {
		            throw new Error('Failed to update strategy.');
		        }
		        
		        alert('Strategy updated successfully!');
		
		    } catch (error) {
		        console.error('Failed to update strategy:', error);
		        alert('Failed to update strategy. Please try again.');
		    }
		}

        function copyShareLink() {
            const shareLinkOutput = document.getElementById('share-link-output');
            if (shareLinkOutput.value) {
                shareLinkOutput.select();
                navigator.clipboard.writeText(shareLinkOutput.value);
                alert('Share link copied to clipboard!');
            } else {
                alert('Please generate a link first.');
            }
        }

        async function loadState() {
		    const urlParams = new URLSearchParams(window.location.search);
		    const strategyId = urlParams.get('id');
		
		    if (strategyId) {
		        try {
		            const response = await fetch(`/api/strategies/${strategyId}`);
		            if (!response.ok) {
		                throw new Error('Failed to load strategy.');
		            }
		            
		            const state = await response.json();
		
		            // Restore selections
		            selectedDrivers = [];
		            state.drivers.forEach(driverName => {
		                const driver = drivers.find(d => d.name === driverName);
		                if (driver) selectedDrivers.push(driver);
		            });
		            renderDriverList();
		            
		            document.getElementById('car-select').value = state.car;
		            document.getElementById('track-select').value = state.track;
		
		            // Restore inputs on page 2
		            document.getElementById('race-duration-hours').value = state.raceDurationHours;
		            document.getElementById('race-duration-minutes').value = state.raceDurationMinutes;
		            document.getElementById('avg-lap-time-minutes').value = state.avgLapTimeMinutes;
		            document.getElementById('avg-lap-time-seconds').value = state.avgLapTimeSeconds;
		            document.getElementById('pit-stop-time').value = state.pitStopTime;
		            document.getElementById('fuel-per-lap-display-input').value = state.fuelPerLapInput;
		            document.getElementById('tank-capacity-display-input').value = state.tankCapacityInput;
		            
		            document.getElementById('fuel-slider').value = state.fuelSlider;
		            document.getElementById('lap-time-slider').value = state.lapTimeSlider;
		            document.getElementById('race-start-time-page2').value = state.raceStartTime;
		            // Removed practice qualifying time and local time functionality
		            
		            // Restore event start time & date from shared link
		            if (state.eventStartTimeInput) {
		                document.getElementById('event-start-time').value = state.eventStartTimeInput;
		            }
		            if (state.eventStartDateInput) {
		                document.getElementById('event-start-date').value = state.eventStartDateInput;
		            }
		            
		            // Timezone and summertime removed - now using driver-specific timezones
		            
		            // Restore weather image URLs (with backward compatibility)
		            if (state.weatherTempUrl) {
		                document.getElementById('weather-temp-url').value = state.weatherTempUrl;
		            } else if (state.weatherImage1) {
		                document.getElementById('weather-temp-url').value = state.weatherImage1;
		            }
		            
		            if (state.weatherCloudsUrl) {
		                document.getElementById('weather-clouds-url').value = state.weatherCloudsUrl;
		            } else if (state.weatherImage2) {
		                document.getElementById('weather-clouds-url').value = state.weatherImage2;
		            }
		            
            // Trigger weather image display after restoration
            const tempUrl = state.weatherTempUrl || state.weatherImage1;
            const cloudsUrl = state.weatherCloudsUrl || state.weatherImage2;
            if (tempUrl || cloudsUrl) {
                displayWeatherImages(tempUrl, cloudsUrl);
            }
            
            // Restore track daylight data
            if (state.trackSunrise) {
                trackSunriseTime = new Date(state.trackSunrise);
            }
            if (state.trackSunset) {
                trackSunsetTime = new Date(state.trackSunset);
            }
            if (state.trackTimezone) {
                trackTimezone = state.trackTimezone;
            }
            
            document.getElementById('fuel-slider-value').textContent = parseFloat(state.fuelSlider).toFixed(1);
            document.getElementById('lap-time-slider-value').textContent = state.lapTimeSlider;		            // Navigate to page 2 and calculate
		            showPage2();
		            calculateAndShowPage2();
		            
		            // Restore driver stint assignments after stint table is populated
		            setTimeout(() => {
		                if (state.stintDrivers) {
		                    Object.keys(state.stintDrivers).forEach(stintIndex => {
		                        const driverSelect = document.getElementById(`stint-driver-${stintIndex}`);
		                        if (driverSelect) {
		                            driverSelect.value = state.stintDrivers[stintIndex];
		                            // Trigger color update
		                            updateStintRowColor(parseInt(stintIndex), state.stintDrivers[stintIndex], selectedDrivers);
		                        }
		                    });
		                }
		                
		                if (state.stintBackupDrivers) {
		                    Object.keys(state.stintBackupDrivers).forEach(stintIndex => {
		                        const backupDriverSelect = document.getElementById(`stint-backup-driver-${stintIndex}`);
		                        if (backupDriverSelect) {
		                            backupDriverSelect.value = state.stintBackupDrivers[stintIndex];
		                        }
		                    });
		                }
		            }, 1000); // Wait 1 second for stint table to be fully populated
		            
		            // Set the current strategy ID and show Save Update button
		            window.currentStrategyId = strategyId;
		            document.getElementById('save-update-btn').classList.remove('hidden');
		            
		            // Also populate the share link field with current URL
		            document.getElementById('share-link-output').value = window.location.href;
		            
		            // Hide Generate Share Link button and Back button when loading from shared link
		            const generateLinkBtn = document.querySelector('button[onclick="generateShareLink()"]');
		            if (generateLinkBtn) generateLinkBtn.style.display = 'none';
		            
		            const backButton = document.getElementById('back-to-page1-btn');
		            if (backButton) backButton.style.display = 'none';
		            
		            // Hide Admin, Race Details, and Live buttons to prevent navigation
		            const adminBtn = document.querySelector('button[onclick="showAdmin()"]');
		            if (adminBtn) adminBtn.style.display = 'none';
		            
		            const raceDetailsBtn = document.querySelector('button[onclick="showRaceDetails()"]');
		            if (raceDetailsBtn) raceDetailsBtn.style.display = 'none';
		            
		            const liveBtn = document.querySelector('button[onclick="showLive()"]');
		            if (liveBtn) liveBtn.style.display = 'none';
		
		        } catch (error) {
		            //console.error('Error loading strategy:', error);
		            //alert('Could not load strategy from the provided link.');
		        }
		    } else {
		        // If no ID is in the URL, initialize the page as normal
		        showPage1();
		    }
		}
        // --- Admin Functions ---

        async function saveDataToServer() {
            try {
                await fetch('/api/data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ drivers, cars, tracks })
                });
                alert('Data saved successfully!');
            } catch (error) {
                console.error('Failed to save data:', error);
                alert('Could not save data to the server.');
            }
        }
        
        function renderAdminLists() {
            const driverList = document.getElementById('admin-driver-list');
            const carList = document.getElementById('admin-car-list');
            const trackList = document.getElementById('admin-track-list');
            
            driverList.innerHTML = '';
            carList.innerHTML = '';
            trackList.innerHTML = '';

            // Sort all arrays alphabetically by name before rendering
            const sortedDrivers = [...drivers].sort((a, b) => a.name.localeCompare(b.name));
            const sortedCars = [...cars].sort((a, b) => a.name.localeCompare(b.name));
            const sortedTracks = [...tracks].sort((a, b) => a.name.localeCompare(b.name));

            sortedDrivers.forEach(driver => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between bg-neutral-800 p-3 rounded-lg shadow-sm';
                li.innerHTML = `
                    <span>${driver.name}</span>
                    <div class="space-x-2">
                        <button onclick="editDriverAdmin('${driver.name}')" class="text-blue-500 hover:text-blue-700 transition-colors duration-200"><i class="fas fa-edit"></i></button>
                        <button onclick="removeDriverAdmin('${driver.name}')" class="text-red-500 hover:text-red-700 transition-colors duration-200"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `;
                driverList.appendChild(li);
            });

            sortedCars.forEach(car => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between bg-neutral-800 p-3 rounded-lg shadow-sm';
                li.innerHTML = `
                    <span>${car.name}</span>
                    <div class="space-x-2">
                        <button onclick="editCarAdmin('${car.name}')" class="text-blue-500 hover:text-blue-700 transition-colors duration-200"><i class="fas fa-edit"></i></button>
                        <button onclick="removeCarAdmin('${car.name}')" class="text-red-500 hover:text-red-700 transition-colors duration-200"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `;
                carList.appendChild(li);
            });

            sortedTracks.forEach(track => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between bg-neutral-800 p-3 rounded-lg shadow-sm';
                li.innerHTML = `
                    <span>${track.name}</span>
                    <div class="space-x-2">
                        <button onclick="editTrackAdmin('${track.name}')" class="text-blue-500 hover:text-blue-700 transition-colors duration-200"><i class="fas fa-edit"></i></button>
                        <button onclick="removeTrackAdmin('${track.name}')" class="text-red-500 hover:text-red-700 transition-colors duration-200"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `;
                trackList.appendChild(li);
            });
        }
        function resetDriverAdminForm() {
            document.getElementById('new-driver-name').value = '';
            document.getElementById('new-driver-first-name').value = '';
            document.getElementById('new-driver-last-name').value = '';
            document.getElementById('new-driver-garage61-slug').value = '';
            document.getElementById('timezone-search').value = '';
            document.getElementById('new-driver-timezone').classList.add('hidden');
            document.getElementById('add-driver-btn').textContent = 'Add Driver';
            document.getElementById('add-driver-btn').onclick = addDriverAdmin;
        }
        async function addDriverAdmin() {
            const name = document.getElementById('new-driver-name').value;
            const firstName = document.getElementById('new-driver-first-name').value;
            const lastName = document.getElementById('new-driver-last-name').value;
            const garage61_slug = document.getElementById('new-driver-garage61-slug').value;
            const timezone = document.getElementById('timezone-search').value;
            
            console.log('Timezone value being saved:', timezone);
            
            if (name && garage61_slug) { // Only require name and garage61_slug
                drivers.push({ name, firstName, lastName, garage61_slug, timezone });
                await saveDataToServer();
                renderAdminLists();
                populateDrivers();
                resetDriverAdminForm();
            } else {
                alert('Please fill in driver name and garage61 slug fields');
            }
        }
        function editDriverAdmin(name) {
            const driver = drivers.find(d => d.name === name);
            if (driver) {
                document.getElementById('new-driver-name').value = driver.name;
                document.getElementById('new-driver-first-name').value = driver.firstName || '';
                document.getElementById('new-driver-last-name').value = driver.lastName || '';
                document.getElementById('new-driver-garage61-slug').value = driver.garage61_slug || '';
                document.getElementById('timezone-search').value = driver.timezone || '';
                document.getElementById('add-driver-btn').textContent = 'Update Driver';
                document.getElementById('add-driver-btn').onclick = () => updateDriverAdmin(name);
            }
        }
        async function updateDriverAdmin(originalName) {
            const name = document.getElementById('new-driver-name').value;
            const firstName = document.getElementById('new-driver-first-name').value;
            const lastName = document.getElementById('new-driver-last-name').value;
            const garage61_slug = document.getElementById('new-driver-garage61-slug').value;
            const timezone = document.getElementById('timezone-search').value;
            
            console.log('UPDATE: Timezone value being sent:', timezone);
            
            if (name && garage61_slug) { // Only require name and garage61_slug
                try {
                    const response = await fetch(`/api/drivers/${encodeURIComponent(originalName)}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ name, firstName, lastName, garage61_slug, timezone }),
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(errorText);
                    }
                    
                    // Update local drivers array
                    const index = drivers.findIndex(d => d.name === originalName);
                    if (index !== -1) {
                        drivers[index] = { name, firstName, lastName, garage61_slug, timezone };
                    }
                    
                    renderAdminLists();
                    populateDrivers();
                    resetDriverAdminForm();
                    alert('Driver updated successfully!');
                    
                } catch (error) {
                    console.error('Error updating driver:', error);
                    alert('Failed to update driver: ' + error.message);
                }
            } else {
                alert('Please fill in driver name and garage61 slug fields');
            }
        }
        async function removeDriverAdmin(name) {
            if (!confirm(`Are you sure you want to remove ${name}?`)) return;
            try {
                const resp = await fetch(`/api/drivers/${encodeURIComponent(name)}`, { method: 'DELETE' });
                if (!resp.ok && resp.status !== 204) {
                    console.error('Failed to delete driver on server:', resp.status);
                    alert('Server delete failed');
                }
            } catch (e) {
                console.error('Error deleting driver:', e);
            }
            // Update local state and UI
            drivers = drivers.filter(d => d.name !== name);
            renderAdminLists();
            populateDrivers();
        }
        function resetCarAdminForm() {
            document.getElementById('new-car-name').value = '';
            document.getElementById('new-car-garage61-id').value = '';
            document.getElementById('add-car-btn').textContent = 'Add Car';
            document.getElementById('add-car-btn').onclick = addCarAdmin;
        }
        async function addCarAdmin() {
            const name = document.getElementById('new-car-name').value;
            const garage61_id = parseInt(document.getElementById('new-car-garage61-id').value);
            
            if (name && garage61_id) {
                cars.push({ name, garage61_id });
                await saveDataToServer();
                renderAdminLists();
                populateCars();
                resetCarAdminForm();
            } else {
                alert('Please fill in all car fields');
            }
        }
        function editCarAdmin(name) {
            const car = cars.find(c => c.name === name);
            if (car) {
                document.getElementById('new-car-name').value = car.name;
                document.getElementById('new-car-garage61-id').value = car.garage61_id || '';
                document.getElementById('add-car-btn').textContent = 'Update Car';
                document.getElementById('add-car-btn').onclick = () => updateCarAdmin(name);
            }
        }
        async function updateCarAdmin(originalName) {
            const name = document.getElementById('new-car-name').value;
            const garage61_id = parseInt(document.getElementById('new-car-garage61-id').value);
            
            if (name && garage61_id) {
                try {
                    // Find the car to get its current garage61_id for the API call
                    const originalCar = cars.find(c => c.name === originalName);
                    if (!originalCar) {
                        throw new Error('Original car not found');
                    }
                    
                    const response = await fetch(`/api/cars/${encodeURIComponent(originalCar.garage61_id)}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ name, garage61_id }),
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(errorText);
                    }
                    
                    // Update local cars array
                    const index = cars.findIndex(c => c.name === originalName);
                    if (index !== -1) {
                        cars[index] = { name, garage61_id };
                    }
                    
                    renderAdminLists();
                    populateCars();
                    resetCarAdminForm();
                    console.log('‚úÖ Car updated successfully');
                } catch (error) {
                    console.error('‚ùå Error updating car:', error);
                    alert('Failed to update car: ' + error.message);
                }
            } else {
                alert('Please fill in all car fields');
            }
        }
        async function removeCarAdmin(name) {
            if (!confirm(`Are you sure you want to remove ${name}?`)) return;
            const car = cars.find(c => c.name === name);
            if (!car || !car.garage61_id) {
                alert('Cannot delete car: missing garage61_id');
                return;
            }
            try {
                const resp = await fetch(`/api/cars/${encodeURIComponent(car.garage61_id)}`, { method: 'DELETE' });
                if (!resp.ok && resp.status !== 204) {
                    console.error('Failed to delete car on server:', resp.status);
                    alert('Server delete failed');
                }
            } catch (e) {
                console.error('Error deleting car:', e);
            }
            // Update local state and UI
            cars = cars.filter(c => c.name !== name);
            renderAdminLists();
            populateCars();
        }
        function resetTrackAdminForm() {
            document.getElementById('new-track-name').value = '';
            document.getElementById('new-track-garage61-id').value = '';
            document.getElementById('new-track-length').value = '';
            document.getElementById('new-track-latitude').value = '';
            document.getElementById('new-track-longitude').value = '';
            document.getElementById('add-track-btn').textContent = 'Add Track';
            document.getElementById('add-track-btn').onclick = addTrackAdmin;
        }
        async function addTrackAdmin() {
            const name = document.getElementById('new-track-name').value;
            const garage61_id = parseInt(document.getElementById('new-track-garage61-id').value);
            const track_length = parseFloat(document.getElementById('new-track-length').value) || 0.0;
            const latitude = parseFloat(document.getElementById('new-track-latitude').value) || null;
            const longitude = parseFloat(document.getElementById('new-track-longitude').value) || null;
            
            if (name && garage61_id) {
                tracks.push({ name, garage61_id, track_length, latitude, longitude });
                await saveDataToServer();
                renderAdminLists();
                populateTracks();
                resetTrackAdminForm();
            } else {
                alert('Please fill in required track fields (name and garage61_id)');
            }
        }
        function editTrackAdmin(name) {
            const track = tracks.find(t => t.name === name);
            if (track) {
                document.getElementById('new-track-name').value = track.name;
                document.getElementById('new-track-garage61-id').value = track.garage61_id || '';
                document.getElementById('new-track-length').value = track.track_length || '0.0';
                document.getElementById('new-track-latitude').value = track.latitude || '';
                document.getElementById('new-track-longitude').value = track.longitude || '';
                document.getElementById('add-track-btn').textContent = 'Update Track';
                document.getElementById('add-track-btn').onclick = () => updateTrackAdmin(name);
            }
        }
        async function updateTrackAdmin(originalName) {
            const name = document.getElementById('new-track-name').value;
            const garage61_id = parseInt(document.getElementById('new-track-garage61-id').value);
            const track_length = parseFloat(document.getElementById('new-track-length').value) || 0.0;
            const latitude = parseFloat(document.getElementById('new-track-latitude').value) || null;
            const longitude = parseFloat(document.getElementById('new-track-longitude').value) || null;
            
            if (name && garage61_id) {
                try {
                    // Find the track to get its current garage61_id for the API call
                    const originalTrack = tracks.find(t => t.name === originalName);
                    if (!originalTrack) {
                        throw new Error('Original track not found');
                    }
                    
                    const response = await fetch(`/api/tracks/${encodeURIComponent(originalTrack.garage61_id)}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ name, garage61_id, track_length, latitude, longitude }),
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(errorText);
                    }
                    
                    // Update local tracks array
                    const index = tracks.findIndex(t => t.name === originalName);
                    if (index !== -1) {
                        tracks[index] = { name, garage61_id, track_length, latitude, longitude };
                    }
                    
                    renderAdminLists();
                    populateTracks();
                    resetTrackAdminForm();
                    console.log('‚úÖ Track updated successfully');
                } catch (error) {
                    console.error('‚ùå Error updating track:', error);
                    alert('Failed to update track: ' + error.message);
                }
            } else {
                alert('Please fill in required track fields (name and garage61_id)');
            }
        }
        async function removeTrackAdmin(name) {
            const track = tracks.find(t => t.name === name);
            if (!track) {
                alert('Track not found');
                return;
            }
            if (!confirm(`Are you sure you want to remove ${track.name}?`)) return;
            
            try {
                const resp = await fetch(`/api/tracks/${encodeURIComponent(track.garage61_id)}`, { method: 'DELETE' });
                if (!resp.ok && resp.status !== 204) {
                    console.error('Failed to delete track on server:', resp.status);
                    alert('Server delete failed');
                }
            } catch (e) {
                console.error('Error deleting track:', e);
            }
            // Update local state and UI
            tracks = tracks.filter(t => t.garage61_id !== garage61_id);
            renderAdminLists();
            populateTracks();
        }

        // Function to handle time formatting based on the selected time zone
        function formatTimeWithTimezone(date, timeZone) {
            try {
                // DST is now handled automatically by browser's timezone system
                // Summertime checkbox removed - DST handled by IANA timezone data
                const isDST = false; // Not used anymore
                
                // Create a new date object to avoid modifying the original
                let adjustedDate = new Date(date.getTime());
                
                // Add 1 hour if summertime is enabled
                if (isDST) {
                    adjustedDate.setHours(adjustedDate.getHours() + 1);
                }
                
                const options = {
                    timeZone: timeZone,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                };
                return adjustedDate.toLocaleString('en-GB', options);
            } catch (error) {
                console.error('Error in formatTimeWithTimezone:', error);
                // Fallback to basic time formatting
                return date.toISOString().substr(11, 8);
            }
        }

				
		// Function to populate the driver dropdowns for each stint
		function populateStintDrivers(stintIndex, drivers) {
			    const driverSelect = document.getElementById(`stint-driver-${stintIndex}`);
			    const backupDriverSelect = document.getElementById(`stint-backup-driver-${stintIndex}`);

			    // Clear existing options
			    driverSelect.innerHTML = '';
			    backupDriverSelect.innerHTML = '';

			    // Add a default option
			    const defaultOption = document.createElement('option');
			    defaultOption.textContent = "Select...";
			    defaultOption.value = "";
			    driverSelect.appendChild(defaultOption.cloneNode(true));
			    backupDriverSelect.appendChild(defaultOption.cloneNode(true));

			    // Add new options from the selected drivers
			    drivers.forEach(driver => {
			        const option = document.createElement('option');
			        option.value = driver.name;
			        option.textContent = driver.name;
			        driverSelect.appendChild(option);
			        backupDriverSelect.appendChild(option.cloneNode(true)); // Create a copy for the backup
			    });

			    // Add event listener to change row color when driver is selected
			    driverSelect.addEventListener('change', function() {
			        updateStintRowColor(stintIndex, this.value, drivers);
			    });
		}

		// Function to update stint row color based on selected driver
		function updateStintRowColor(stintIndex, driverName, drivers) {
		    const row = document.getElementById(`stint-row-${stintIndex}`);
		    if (!row) return;

		    // Remove all existing driver color classes
		    for (let i = 0; i < 8; i++) {
		        row.classList.remove(`driver-color-${i}`);
		    }
		    row.classList.remove('driver-color-default');

		    // If no driver selected, use default
		    if (!driverName) {
		        row.classList.add('driver-color-default');
		        return;
		    }

		    // Find driver index and apply corresponding color
		    const driverIndex = drivers.findIndex(driver => driver.name === driverName);
		    if (driverIndex !== -1) {
		        row.classList.add(`driver-color-${driverIndex % 8}`);
		    } else {
		        row.classList.add('driver-color-default');
		    }
		}

        function adjustSlider(type, value) {
            let sliderId;
            let displayId;
            let step;

            if (type === 'fuel') {
                sliderId = 'fuel-slider';
                displayId = 'fuel-slider-value';
                step = 0.05;
            } else if (type === 'lapTime') {
                sliderId = 'lap-time-slider';
                displayId = 'lap-time-slider-value';
                step = 0.05;
            } else {
                return;
            }

            const slider = document.getElementById(sliderId);
            let currentValue = parseFloat(slider.value);
            let newValue = currentValue + value;

            // Clamp the new value to the slider's min and max to prevent it from going out of bounds
            newValue = Math.min(Math.max(newValue, parseFloat(slider.min)), parseFloat(slider.max));
            slider.value = newValue;

            // Update the display value
            document.getElementById(displayId).textContent = newValue.toFixed(2);

            // Trigger the calculation to update the strategy
            calculateAndShowPage2();
        }
        
        // Time mode toggle functions
        let isLocalTimeMode = false;
        
        // Initialize race time mode as active
        document.addEventListener('DOMContentLoaded', function() {
            const raceLabel = document.getElementById('race-time-label');
            if (raceLabel) {
                raceLabel.classList.add('time-mode-active');
            }
        });
        
        function toggleTimeMode() {
            const toggleSwitch = document.querySelector('.toggle-switch');
            const slider = document.getElementById('time-toggle-slider');
            const driverSelector = document.getElementById('driver-timezone-selector');
            const raceLabel = document.getElementById('race-time-label');
            const localLabel = document.getElementById('local-time-label');
            
            isLocalTimeMode = !isLocalTimeMode;
            
            if (isLocalTimeMode) {
                toggleSwitch.classList.add('active');
                driverSelector.classList.remove('hidden');
                raceLabel.classList.remove('time-mode-active');
                localLabel.classList.add('time-mode-active');
                populateDriverDropdown();
                // Pre-load daylight data for all drivers
                loadAllDriverDaylightData();
            } else {
                toggleSwitch.classList.remove('active');
                driverSelector.classList.add('hidden');
                raceLabel.classList.add('time-mode-active');
                localLabel.classList.remove('time-mode-active');
            }
            
            // Update stint table with new time mode
            updateStintTableTimes();
            
            updateStintTableTimes();
        }
        
        function getSelectedDrivers() {
            return selectedDrivers || [];
        }
        
        function populateDriverDropdown() {
            const dropdown = document.getElementById('driver-timezone-dropdown');
            const drivers = getSelectedDrivers(); // Get drivers from page 1
            
            dropdown.innerHTML = '<option value="">Select Driver</option>';
            drivers.forEach(driver => {
                const option = document.createElement('option');
                option.value = driver.name;
                option.textContent = `${driver.name} (${driver.timezone || 'No timezone'})`;
                option.dataset.timezone = driver.timezone || '';
                dropdown.appendChild(option);
            });
        }
        
        async function updateStintTableTimes() {
            // Get selected driver and load their daylight data if in local time mode
            if (isLocalTimeMode) {
                const selectedDriverDropdown = document.getElementById('driver-timezone-dropdown');
                const selectedDriverName = selectedDriverDropdown.value;
                const selectedDriverTimezone = selectedDriverDropdown.options[selectedDriverDropdown.selectedIndex]?.dataset.timezone;
                
                if (selectedDriverName && selectedDriverTimezone) {
                    console.log(`üåÖ Loading daylight data for driver ${selectedDriverName} (${selectedDriverTimezone})`);
                    
                    // Get event date for daylight calculation (use event date in local time mode)
                    const eventDate = document.getElementById('event-start-date').value;
                    if (eventDate) {
                        const daylightData = await calculateDriverDaylightTimes(selectedDriverTimezone, eventDate);
                        if (daylightData) {
                            driverDaylightData[selectedDriverName] = daylightData;
                            console.log(`‚úÖ Loaded daylight data for ${selectedDriverName}:`, daylightData);
                        }
                    }
                }
            }
            
            // Get current average lap time and recalculate table
            const avgLapTimeInput = document.getElementById('avg-lap-time');
            if (avgLapTimeInput && avgLapTimeInput.value) {
                const avgLapTimeInSeconds = parseFloat(avgLapTimeInput.value);
                populateStintTable(avgLapTimeInSeconds, true); // true = preserve driver assignments
            }
        }

        // Simple layout toggle - just change container width
        function toggleLayout() {
            const container = document.querySelector('.max-w-4xl');
            const icon = document.getElementById('layout-icon');
            const text = document.getElementById('layout-text');
            
            if (text.textContent === 'Mobile') {
                // Switch to desktop - 2 column layout
                container.classList.add('desktop-mode');
                
                icon.classList.remove('fa-mobile-alt');
                icon.classList.add('fa-desktop');
                text.textContent = 'Desktop';
                
                // If page2 is already shown, set up desktop layout immediately
                const page2 = document.getElementById('page-2');
                if (page2 && !page2.classList.contains('hidden')) {
                    setTimeout(() => setupDesktopLayout(), 100);
                }
            } else {
                // Switch back to mobile
                container.classList.remove('desktop-mode');
                resetMobileLayout();
                
                icon.classList.remove('fa-desktop');
                icon.classList.add('fa-mobile-alt');
                text.textContent = 'Mobile';
            }
        }
        
        // Override showPage2 to handle desktop layout after calculate
        const originalShowPage2 = showPage2;
        showPage2 = function() {
            console.log('showPage2 called');
            originalShowPage2();
            
            // ALWAYS check for desktop mode after any calculate
            setTimeout(() => {
                const container = document.querySelector('.max-w-4xl');
                const toggleText = document.getElementById('layout-text');
                
                console.log('Container:', container);
                console.log('Toggle text:', toggleText ? toggleText.textContent : 'not found');
                
                if (container && toggleText && toggleText.textContent === 'Desktop') {
                    console.log('FORCING desktop layout setup');
                    setupDesktopLayout();
                }
            }, 500);
        };
        
        function setupDesktopLayout() {
            console.log('üî• SETTING UP DESKTOP LAYOUT - FORCING CHANGES');
            
            // FORCE hide the admin containers
            const adminPage = document.getElementById('admin-page');
            const appContainer = document.getElementById('app-container');
            const adminBtn = document.getElementById('admin-btn');
            
            console.log('Admin page found:', !!adminPage);
            console.log('App container found:', !!appContainer);
            
            // FORCE HIDE EVERYTHING
            if (adminPage) {
                adminPage.style.display = 'none !important';
                adminPage.classList.add('hidden');
                console.log('‚úÖ FORCED admin page hidden');
            }
            
            if (appContainer) {
                appContainer.style.display = 'none !important';
                appContainer.classList.add('hidden');
                console.log('‚úÖ FORCED app container hidden');
            }
            
            if (adminBtn) {
                adminBtn.style.display = 'none !important';
                adminBtn.classList.add('hidden');
                console.log('‚úÖ FORCED admin button hidden');
            }
            
            // Make logo smaller
            const logoImg = document.querySelector('img[alt="?"]');
            if (logoImg) {
                logoImg.style.width = '100px !important';
                logoImg.style.height = 'auto';
                console.log('‚úÖ Logo resized');
            }
            
            setupDesktopColumns();
        }
        
        function setupDesktopColumns() {
            const container = document.querySelector('.max-w-4xl');
            
            // Hide admin button
            const adminBtn = document.getElementById('admin-btn');
            if (adminBtn) adminBtn.style.display = 'none';
            
            // Create left column container
            const leftCol = document.createElement('div');
            leftCol.className = 'desktop-left';
            
            // Create right column container  
            const rightCol = document.createElement('div');
            rightCol.className = 'desktop-right';
            
            // Left Column Elements - exactly as you specified
            const carTrackDriversInfo = document.querySelector('#page-2 .p-6.bg-neutral-800.border.border-neutral-700.rounded-lg'); // Car Track and Drivers
            const raceInputs = document.getElementById('race-inputs-container'); // Race Inputs
            const strategySummary = document.getElementById('overall-summary'); // Live Overall Strategy Summary
            const dynamicAdjustments = document.getElementById('sliders-container'); // Dynamic Adjustments
            const shareContainer = document.getElementById('share-link-container'); // Share/Save buttons
            
            // Right Column Elements - exactly as you specified
            const garage61LapTimes = document.getElementById('garage61-lap-times'); // Garage 61 Lap Times
            const stintsTable = document.getElementById('stint-breakdown-display'); // Stints Table
            
            // Move LEFT column elements
            [carTrackDriversInfo, raceInputs, strategySummary, dynamicAdjustments, shareContainer].forEach(el => {
                if (el) {
                    el.classList.remove('hidden');
                    leftCol.appendChild(el);
                }
            });
            
            // Move RIGHT column elements
            [garage61LapTimes, stintsTable].forEach(el => {
                if (el) {
                    el.classList.remove('hidden');
                    rightCol.appendChild(el);
                    
                    // Fix garage61 loading issue - force hide loading if data already exists
                    if (el.id === 'garage61-lap-times') {
                        const loadingInEl = el.querySelector('#lap-times-loading');
                        const contentInEl = el.querySelector('#lap-times-content');
                        const listInEl = el.querySelector('#lap-times-list');
                        
                        if (loadingInEl) loadingInEl.classList.add('hidden');
                        if (contentInEl && listInEl && listInEl.children.length > 0) {
                            contentInEl.classList.remove('hidden');
                        }
                    }
                }
            });
            
            // Add columns to container
            container.appendChild(leftCol);
            container.appendChild(rightCol);
            
            // Hide original page structure
            const pagesToHide = ['planner-page', 'page-2'];
            pagesToHide.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
        }
        
        function resetMobileLayout() {
            const container = document.querySelector('.max-w-4xl');
            const leftCol = container.querySelector('.desktop-left');
            const rightCol = container.querySelector('.desktop-right');
            
            // Show app container again
            const appContainer = document.getElementById('app-container');
            if (appContainer) {
                appContainer.style.display = '';
            }
            
            // Show admin page again
            const adminPage = document.getElementById('admin-page');
            if (adminPage) {
                adminPage.style.display = '';
            }
            
            // Show admin button again
            const adminBtn = document.getElementById('admin-btn');
            if (adminBtn) adminBtn.style.display = '';
            
            // Reset logo size
            const logoImg = document.querySelector('img[alt="?"]');
            if (logoImg) {
                logoImg.style.width = '';
                logoImg.style.height = '';
            }
            
            if (leftCol && rightCol) {
                // Remove columns
                leftCol.remove();
                rightCol.remove();
            }
        }
        
        // üåç TIMEZONE SEARCH FUNCTIONALITY
        let allTimezones = [];
        
        // Timezone to approximate coordinates mapping (for daylight calculations)
        // Using major cities as representative coordinates for each timezone
        function getTimezoneCoordinates(timezone) {
            const timezoneCoords = {
                // North America
                'America/New_York': { lat: 40.7128, lng: -74.0060 }, // NYC
                'America/Chicago': { lat: 41.8781, lng: -87.6298 }, // Chicago
                'America/Denver': { lat: 39.7392, lng: -104.9903 }, // Denver
                'America/Los_Angeles': { lat: 34.0522, lng: -118.2437 }, // LA
                'America/Toronto': { lat: 43.6532, lng: -79.3832 }, // Toronto
                'America/Vancouver': { lat: 49.2827, lng: -123.1207 }, // Vancouver
                'America/Mexico_City': { lat: 19.4326, lng: -99.1332 }, // Mexico City
                
                // Europe
                'Europe/London': { lat: 51.5074, lng: -0.1278 }, // London
                'Europe/Paris': { lat: 48.8566, lng: 2.3522 }, // Paris
                'Europe/Berlin': { lat: 52.5200, lng: 13.4050 }, // Berlin
                'Europe/Rome': { lat: 41.9028, lng: 12.4964 }, // Rome
                'Europe/Madrid': { lat: 40.4168, lng: -3.7038 }, // Madrid
                'Europe/Amsterdam': { lat: 52.3676, lng: 4.9041 }, // Amsterdam
                'Europe/Brussels': { lat: 50.8503, lng: 4.3517 }, // Brussels
                'Europe/Vienna': { lat: 48.2082, lng: 16.3738 }, // Vienna
                'Europe/Stockholm': { lat: 59.3293, lng: 18.0686 }, // Stockholm
                'Europe/Helsinki': { lat: 60.1699, lng: 24.9384 }, // Helsinki
                'Europe/Prague': { lat: 50.0755, lng: 14.4378 }, // Prague
                'Europe/Warsaw': { lat: 52.2297, lng: 21.0122 }, // Warsaw
                'Europe/Budapest': { lat: 47.4979, lng: 19.0402 }, // Budapest
                'Europe/Zurich': { lat: 47.3769, lng: 8.5417 }, // Zurich
                
                // Asia Pacific
                'Asia/Tokyo': { lat: 35.6762, lng: 139.6503 }, // Tokyo
                'Asia/Shanghai': { lat: 31.2304, lng: 121.4737 }, // Shanghai
                'Asia/Hong_Kong': { lat: 22.3193, lng: 114.1694 }, // Hong Kong
                'Asia/Singapore': { lat: 1.3521, lng: 103.8198 }, // Singapore
                'Asia/Seoul': { lat: 37.5665, lng: 126.9780 }, // Seoul
                'Asia/Mumbai': { lat: 19.0760, lng: 72.8777 }, // Mumbai
                'Asia/Dubai': { lat: 25.2048, lng: 55.2708 }, // Dubai
                'Asia/Bangkok': { lat: 13.7563, lng: 100.5018 }, // Bangkok
                'Asia/Manila': { lat: 14.5995, lng: 120.9842 }, // Manila
                'Australia/Sydney': { lat: -33.8688, lng: 151.2093 }, // Sydney
                'Australia/Melbourne': { lat: -37.8136, lng: 144.9631 }, // Melbourne
                'Australia/Perth': { lat: -31.9505, lng: 115.8605 }, // Perth
                'Pacific/Auckland': { lat: -36.8485, lng: 174.7633 }, // Auckland
                
                // South America
                'America/Sao_Paulo': { lat: -23.5505, lng: -46.6333 }, // S√£o Paulo
                'America/Argentina/Buenos_Aires': { lat: -34.6118, lng: -58.3960 }, // Buenos Aires
                'America/Lima': { lat: -12.0464, lng: -77.0428 }, // Lima
                
                // Africa
                'Africa/Cairo': { lat: 30.0444, lng: 31.2357 }, // Cairo
                'Africa/Johannesburg': { lat: -26.2041, lng: 28.0473 }, // Johannesburg
                'Africa/Lagos': { lat: 6.5244, lng: 3.3792 }, // Lagos
                
                // Default fallback
                'UTC': { lat: 51.4769, lng: 0.0005 } // Greenwich
            };
            
            return timezoneCoords[timezone] || timezoneCoords['UTC'];
        }
        
        // Helper function to format time in a specific timezone
        function formatTimeWithTimezone(dateTime, timezone) {
            try {
                return dateTime.toLocaleTimeString('en-GB', {
                    timeZone: timezone,
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            } catch (error) {
                // Fallback to UTC format
                return dateTime.toISOString().substr(11, 8);
            }
        }
        
        // Calculate driver-specific daylight times using their timezone coordinates
        async function calculateDriverDaylightTimes(driverTimezone, raceDate) {
            try {
                const coords = getTimezoneCoordinates(driverTimezone);
                const response = await fetch('/api/daylight', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        latitude: coords.lat,
                        longitude: coords.lng,
                        date: raceDate
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return {
                        sunrise: new Date(data.sunrise),
                        sunset: new Date(data.sunset),
                        timezone: driverTimezone
                    };
                } else {
                    console.warn(`Failed to get daylight data for driver timezone ${driverTimezone}`);
                    return null;
                }
            } catch (error) {
                console.error(`Error calculating daylight for driver timezone ${driverTimezone}:`, error);
                return null;
            }
        }
        
        // Store driver-specific daylight data
        let driverDaylightData = {}; // { driverName: { sunrise, sunset, timezone } }
        
        // Load daylight data for all selected drivers
        async function loadAllDriverDaylightData() {
            const drivers = getSelectedDrivers();
            const eventDate = document.getElementById('event-start-date').value;
            
            if (!eventDate) {
                console.warn('No event date set, cannot load driver daylight data');
                return;
            }
            
            console.log('üåÖ Loading daylight data for all drivers and London...');
            
            // Calculate London daylight for event time display
            await calculateLondonDaylight(eventDate);
            
            for (const driver of drivers) {
                if (driver.timezone) {
                    console.log(`Loading daylight for ${driver.name} (${driver.timezone})`);
                    const daylightData = await calculateDriverDaylightTimes(driver.timezone, eventDate);
                    if (daylightData) {
                        driverDaylightData[driver.name] = daylightData;
                        console.log(`‚úÖ Loaded daylight for ${driver.name}`);
                    }
                }
            }
            
            console.log('üåÖ All daylight data loaded:', { london: { sunrise: londonSunriseTime, sunset: londonSunsetTime }, drivers: driverDaylightData });
        }
        
        // Load all timezones from assets
        async function loadTimezones() {
            try {
                const response = await fetch('/assets/timezones.json');
                allTimezones = await response.json();
                console.log(`Loaded ${allTimezones.length} timezones`);
            } catch (error) {
                console.error('Failed to load timezones:', error);
                // Fallback to basic list
                allTimezones = ['UTC', 'Europe/London', 'America/New_York', 'Australia/Sydney'];
            }
        }
        
        // Setup timezone search
        function setupTimezoneSearch() {
            const searchInput = document.getElementById('timezone-search');
            const dropdown = document.getElementById('new-driver-timezone');
            
            if (!searchInput || !dropdown) return;
            
            // Show dropdown when clicking search input
            searchInput.addEventListener('focus', () => {
                dropdown.classList.remove('hidden');
                filterTimezones('');
            });
            
            // Filter as user types
            searchInput.addEventListener('input', (e) => {
                filterTimezones(e.target.value);
            });
            
            // Select timezone when clicking option
            dropdown.addEventListener('click', (e) => {
                if (e.target.tagName === 'OPTION') {
                    searchInput.value = e.target.value;
                    dropdown.classList.add('hidden');
                    console.log('Selected timezone:', e.target.value);
                }
            });
            
            // Hide dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.add('hidden');
                }
            });
        }
        
        function filterTimezones(search) {
            const dropdown = document.getElementById('new-driver-timezone');
            if (!dropdown) return;
            
            const filtered = allTimezones.filter(tz => 
                tz.toLowerCase().includes(search.toLowerCase())
            );
            
            dropdown.innerHTML = filtered.map(tz => 
                `<option value="${tz}">${tz}</option>`
            ).join('');
            
            // Show dropdown
            dropdown.classList.remove('hidden');
        }
        
        // Initialize timezone search when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            await loadTimezones();
            setupTimezoneSearch();
        });
		
    </script>
	
</body>
</html>

