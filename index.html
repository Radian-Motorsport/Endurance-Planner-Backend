<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Endurance Race Planner</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Road+Rage&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            transition: background-color 0.5s, color 0.5s;
        }
        h1 {
            font-family: 'Road Rage', sans-serif;
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }

        /* Dark Mode Switch CSS */
        .toggle-switch-container {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .toggle-switch-container input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #2196F3;
        }
        input:focus + .slider {
            box-shadow: 0 0 1px #2196F3;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .dark {
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .dark h1 {
            color: #e2e8f0;
        }
        .dark .bg-gray-50 { background-color: #2d3748; }
        .dark .bg-gray-100 { background-color: #4a5568; }
        .dark .bg-white { background-color: #2d3748; }
        .dark .border-gray-200 { border-color: #4a5568; }
        .dark .border-gray-300 { border-color: #4a5568; }
        .dark .text-gray-700 { color: #e2e8f0; }
        .dark .text-gray-800 { color: #e2e8f0; }
        .dark .text-gray-900 { color: #e2e8f0; }
        .dark input, .dark select, .dark textarea {
            background-color: #4a5568;
            border-color: #6b7280;
            color: #e2e8f0;
        }
        .dark .bg-gray-200 { background-color: #4a5568; }
        .dark .divide-gray-200 { border-color: #4a5568; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 transition-colors duration-500">
    <div class="min-h-screen flex flex-col items-center p-6">
        <!-- Header -->
        <header class="w-full max-w-4xl flex justify-between items-center mb-6">
            <h1 class="text-4xl md:text-5xl lg:text-6xl text-gray-800 dark:text-white font-bold tracking-wide">Endurance Planner</h1>
            <div class="flex items-center space-x-4">
                <span class="text-gray-800 dark:text-white">Dark Mode</span>
                <label class="toggle-switch-container">
                    <input type="checkbox" id="darkModeSwitch">
                    <span class="slider"></span>
                </label>
            </div>
        </header>

        <!-- Main Container -->
        <div class="w-full max-w-4xl bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 transition-colors duration-500">

            <!-- Tab Navigation -->
            <div class="flex justify-center space-x-4 mb-8">
                <button id="race-details-btn" onclick="showPlannerPage()" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105 flex items-center space-x-2">
                    <i class="fas fa-car-side"></i> <span>Race Details</span>
                </button>
                <button id="admin-btn" onclick="showAdminPage()" class="bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105 flex items-center space-x-2">
                    <i class="fas fa-user-shield"></i> <span>Admin</span>
                </button>
            </div>

            <!-- Planner Page (Initial View) -->
            <div id="planner-page" class="page-content">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800 dark:text-white">Race Setup</h2>

                <!-- Race Inputs -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <!-- Race Duration -->
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Race Duration</label>
                        <div class="flex space-x-2 mt-1">
                            <input type="number" id="race-duration-hours" value="6" min="0" class="p-2 border rounded w-1/2 dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                            <span class="text-gray-500 dark:text-gray-400 self-center">hours</span>
                            <input type="number" id="race-duration-minutes" value="0" min="0" max="59" class="p-2 border rounded w-1/2 dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                            <span class="text-gray-500 dark:text-gray-400 self-center">minutes</span>
                        </div>
                    </div>

                    <!-- Time Adjustment Slider -->
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                        <label for="time-adjustment-slider" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Total Race Time Adjustment</label>
                        <input type="range" id="time-adjustment-slider" min="-60" max="60" value="0" step="5" class="w-full mt-1">
                        <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400">
                            <span>-60 min</span>
                            <span><span id="time-adjustment-value">0</span> min</span>
                            <span>+60 min</span>
                        </div>
                    </div>

                    <!-- Lap Times & Pit Stop -->
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Average Lap Time</label>
                        <div class="flex space-x-2 mt-1">
                            <input type="number" id="average-lap-time-minutes" value="1" min="0" class="p-2 border rounded w-1/2 dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                            <span class="text-gray-500 dark:text-gray-400 self-center">min</span>
                            <input type="number" id="average-lap-time-seconds" value="45" min="0" max="59" class="p-2 border rounded w-1/2 dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                            <span class="text-gray-500 dark:text-gray-400 self-center">sec</span>
                        </div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mt-4">Average Pit Stop Time (sec)</label>
                        <input type="number" id="average-pit-stop-time" value="30" min="0" class="w-full p-2 border rounded mt-1 dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                    </div>

                    <!-- Fuel & Car -->
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Fuel Per Lap</label>
                        <input type="number" id="fuel-per-lap" value="2.5" step="0.1" min="0" class="w-full p-2 border rounded mt-1 dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mt-4">Fuel Tank Size</label>
                        <input type="number" id="fuel-tank-size" value="100" min="0" class="w-full p-2 border rounded mt-1 dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                    </div>
                </div>

                <!-- Strategy Summary -->
                <div class="mb-6">
                    <h3 class="text-xl font-semibold mb-2 text-gray-800 dark:text-white">Strategy Summary</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-blue-100 dark:bg-blue-900 rounded-lg p-4 text-center">
                            <p class="text-sm font-medium text-blue-700 dark:text-blue-200">Total Laps</p>
                            <p id="total-laps" class="text-3xl font-bold text-blue-900 dark:text-blue-100">0</p>
                        </div>
                        <div class="bg-green-100 dark:bg-green-900 rounded-lg p-4 text-center">
                            <p class="text-sm font-medium text-green-700 dark:text-green-200">Pit Stops</p>
                            <p id="number-of-pit-stops" class="text-3xl font-bold text-green-900 dark:text-green-100">0</p>
                        </div>
                        <div class="bg-yellow-100 dark:bg-yellow-900 rounded-lg p-4 text-center">
                            <p class="text-sm font-medium text-yellow-700 dark:text-yellow-200">Total Pit Time</p>
                            <p id="total-pit-time" class="text-3xl font-bold text-yellow-900 dark:text-yellow-100">0:00</p>
                        </div>
                        <div class="bg-red-100 dark:bg-red-900 rounded-lg p-4 text-center">
                            <p class="text-sm font-medium text-red-700 dark:text-red-200">Total Drivers</p>
                            <p id="total-drivers" class="text-3xl font-bold text-red-900 dark:text-red-100">0</p>
                        </div>
                    </div>
                </div>

                <!-- Driver Management -->
                <h3 class="text-xl font-semibold mb-2 text-gray-800 dark:text-white">Drivers</h3>
                <div class="flex flex-col md:flex-row gap-4 mb-6">
                    <input type="text" id="new-driver-name" placeholder="Enter driver name" class="flex-grow p-2 border rounded dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                    <button id="add-driver-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition duration-200">Add Driver</button>
                </div>
                <div id="driver-list" class="flex flex-wrap gap-2 mb-6">
                    <!-- Driver tags will be added here -->
                </div>

                <!-- Stint Management -->
                <h3 class="text-xl font-semibold mb-2 text-gray-800 dark:text-white">Stints</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Laps Per Stint</label>
                        <input type="number" id="laps-per-stint" value="25" min="1" class="w-full p-2 border rounded mt-1 dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Fuel Left at End of Stint (%)</label>
                        <input type="number" id="fuel-left-percent" value="5" min="0" max="100" class="w-full p-2 border rounded mt-1 dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                    </div>
                </div>

                <!-- Main Action Button -->
                <button id="calculate-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-200">
                    Create Stint Plan
                </button>
            </div>

            <!-- Stint Breakdown Page -->
            <div id="stint-breakdown-page" class="hidden page-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800 dark:text-white">Stint Breakdown</h2>
                    <button id="back-to-planner-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded transition duration-200">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                </div>

                <!-- Time Zone Controls -->
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg shadow-inner p-4 mb-6">
                    <h3 class="text-lg font-medium text-gray-800 dark:text-white mb-2">Time Zone Settings</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
                        <div>
                            <label for="race-start-time" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Race Start Time</label>
                            <input type="time" id="race-start-time" value="13:00" class="w-full p-2 border rounded mt-1 dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                        </div>
                        <div>
                            <label for="timezone-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Time Zone</label>
                            <select id="timezone-select" class="w-full p-2 border rounded mt-1 dark:bg-gray-600 dark:border-gray-500 dark:text-white"></select>
                        </div>
                        <button id="update-timezone-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition duration-200">Update</button>
                    </div>
                </div>

                <!-- Stint Table -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 rounded-lg shadow-md">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Stint #</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Driver</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Start Time</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">End Time</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Laps</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Fuel Left (%)</th>
                            </tr>
                        </thead>
                        <tbody id="stint-table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            <!-- Stint data will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Admin Page -->
            <div id="admin-page" class="hidden page-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800 dark:text-white">Admin Page</h2>
                    <button id="back-to-planner-from-admin-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded transition duration-200">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                </div>
                
                <!-- Admin Tabs -->
                <div class="flex justify-center mb-6 space-x-4">
                    <button id="manage-drivers-tab" onclick="showAdminSection('drivers')" class="py-2 px-4 font-semibold text-gray-800 dark:text-white rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">Manage Drivers</button>
                    <button id="manage-tracks-tab" onclick="showAdminSection('tracks')" class="py-2 px-4 font-semibold text-gray-800 dark:text-white rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">Manage Tracks</button>
                    <button id="manage-cars-tab" onclick="showAdminSection('cars')" class="py-2 px-4 font-semibold text-gray-800 dark:text-white rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">Manage Cars</button>
                </div>

                <!-- Admin sections -->
                <div id="admin-section-drivers" class="admin-section">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-white">Drivers</h3>
                    <div class="flex flex-col md:flex-row gap-4 mb-4">
                        <input type="text" id="new-driver-admin" placeholder="New Driver Name" class="flex-grow p-2 border rounded dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                        <button id="add-driver-admin-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition duration-200">Add Driver</button>
                    </div>
                    <ul id="driver-admin-list" class="space-y-2"></ul>
                </div>

                <div id="admin-section-tracks" class="admin-section hidden">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-white">Tracks</h3>
                    <div class="flex flex-col md:flex-row gap-4 mb-4">
                        <input type="text" id="new-track-admin" placeholder="New Track Name" class="flex-grow p-2 border rounded dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                        <button id="add-track-admin-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition duration-200">Add Track</button>
                    </div>
                    <ul id="track-admin-list" class="space-y-2"></ul>
                </div>

                <div id="admin-section-cars" class="admin-section hidden">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-white">Cars</h3>
                    <div class="flex flex-col md:flex-row gap-4 mb-4">
                        <input type="text" id="new-car-admin" placeholder="New Car Name" class="flex-grow p-2 border rounded dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                        <button id="add-car-admin-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition duration-200">Add Car</button>
                    </div>
                    <ul id="car-admin-list" class="space-y-2"></ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Modal for Messages -->
    <div id="custom-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full mx-4">
            <h3 id="modal-title" class="text-lg font-semibold text-gray-800 dark:text-white mb-4"></h3>
            <p id="modal-message" class="text-gray-600 dark:text-gray-300 mb-6"></p>
            <div class="flex justify-end space-x-2">
                <button id="modal-cancel-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">Cancel</button>
                <button id="modal-confirm-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600">Remove</button>
            </div>
        </div>
    </div>

    <script>
        // Global state for application data
        let drivers = [];
        let tracks = [];
        let cars = [];

        // Global state for calculations
        let totalLaps = 0;
        let lapsPerStint = 0;
        let avgLapTimeTotalSeconds = 0;
        let avgPitStopTime = 0;

        /**
         * Initializes the application by loading data from local storage, setting up event listeners,
         * and rendering the initial UI.
         */
        document.addEventListener('DOMContentLoaded', () => {
            loadDataFromLocalStorage();
            setupEventListeners();
            showPlannerPage(); // Show the main planner page by default
            populateTimezoneOptions();
            
            // Dark mode initialization
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            if (isDarkMode) {
                document.body.classList.add('dark');
                document.getElementById('darkModeSwitch').checked = true;
            }
        });

        /**
         * Sets up all the event listeners for buttons and input fields.
         */
        function setupEventListeners() {
            // Main navigation buttons
            document.getElementById('race-details-btn').addEventListener('click', showPlannerPage);
            document.getElementById('admin-btn').addEventListener('click', showAdminPage);

            // Planner page
            document.getElementById('add-driver-btn').addEventListener('click', addPlannerDriver);
            document.getElementById('calculate-btn').addEventListener('click', createStintPlan);
            document.getElementById('time-adjustment-slider').addEventListener('input', updateTimeAdjustmentDisplay);

            // Stint breakdown page
            document.getElementById('back-to-planner-btn').addEventListener('click', showPlannerPage);
            document.getElementById('update-timezone-btn').addEventListener('click', () => {
                // When the timezone or start time is updated, recalculate the table
                createStintPlan();
            });

            // Admin page
            document.getElementById('back-to-planner-from-admin-btn').addEventListener('click', showPlannerPage);
            document.getElementById('add-driver-admin-btn').addEventListener('click', addAdminDriver);
            document.getElementById('add-track-admin-btn').addEventListener('click', addAdminTrack);
            document.getElementById('add-car-admin-btn').addEventListener('click', addAdminCar);
            document.getElementById('manage-drivers-tab').addEventListener('click', () => showAdminSection('drivers'));
            document.getElementById('manage-tracks-tab').addEventListener('click', () => showAdminSection('tracks'));
            document.getElementById('manage-cars-tab').addEventListener('click', () => showAdminSection('cars'));

            // Dark mode switch
            document.getElementById('darkModeSwitch').addEventListener('change', (e) => {
                if (e.target.checked) {
                    document.body.classList.add('dark');
                    localStorage.setItem('darkMode', 'true');
                } else {
                    document.body.classList.remove('dark');
                    localStorage.setItem('darkMode', 'false');
                }
            });
        }

        /**
         * Switches between different main pages of the application.
         * @param {string} pageId The ID of the page to show.
         */
        function showPage(pageId) {
            const pages = document.querySelectorAll('.page-content');
            pages.forEach(page => page.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');
        }

        /** Shows the main planner page. */
        function showPlannerPage() {
            showPage('planner-page');
        }

        /** Shows the admin page and renders the lists. */
        function showAdminPage() {
            showPage('admin-page');
            showAdminSection('drivers');
            renderAdminLists();
        }

        /** Shows a specific section within the admin page. */
        function showAdminSection(section) {
            const sections = document.querySelectorAll('.admin-section');
            sections.forEach(s => s.classList.add('hidden'));
            document.getElementById(`admin-section-${section}`).classList.remove('hidden');

            const tabs = document.querySelectorAll('#admin-page button[id$="-tab"]');
            tabs.forEach(tab => tab.classList.remove('bg-gray-200', 'dark:bg-gray-700'));
            document.getElementById(`manage-${section}-tab`).classList.add('bg-gray-200', 'dark:bg-gray-700');
        }

        /**
         * Adds a driver to the planner page's driver list.
         */
        function addPlannerDriver() {
            const driverName = document.getElementById('new-driver-name').value.trim();
            if (driverName && !drivers.includes(driverName)) {
                drivers.push(driverName);
                document.getElementById('new-driver-name').value = '';
                renderDriverTags();
                updateSummary();
            }
        }

        /**
         * Renders the driver tags on the planner page.
         */
        function renderDriverTags() {
            const driverListEl = document.getElementById('driver-list');
            driverListEl.innerHTML = '';
            drivers.forEach(driver => {
                const tag = document.createElement('div');
                tag.className = 'flex items-center bg-blue-500 text-white rounded-full px-3 py-1 text-sm font-semibold';
                tag.innerHTML = `<span>${driver}</span><button class="ml-2 font-bold hover:text-red-300" onclick="removePlannerDriver('${driver}')">&times;</button>`;
                driverListEl.appendChild(tag);
            });
        }

        /**
         * Removes a driver from the planner page's list.
         * @param {string} driverName The name of the driver to remove.
         */
        function removePlannerDriver(driverName) {
            drivers = drivers.filter(d => d !== driverName);
            renderDriverTags();
            updateSummary();
        }

        /**
         * Recalculates and displays the strategy summary.
         */
        function updateSummary() {
            const raceHours = parseInt(document.getElementById('race-duration-hours').value) || 0;
            const raceMinutes = parseInt(document.getElementById('race-duration-minutes').value) || 0;
            const timeAdjustment = parseInt(document.getElementById('time-adjustment-slider').value) || 0;
            const totalRaceMinutes = (raceHours * 60) + raceMinutes + timeAdjustment;

            const avgLapTimeMinutes = parseInt(document.getElementById('average-lap-time-minutes').value) || 0;
            const avgLapTimeSeconds = parseInt(document.getElementById('average-lap-time-seconds').value) || 0;
            const lapsPerStint = parseInt(document.getElementById('laps-per-stint').value) || 0;
            const fuelPerLap = parseFloat(document.getElementById('fuel-per-lap').value) || 0;
            const fuelTankSize = parseFloat(document.getElementById('fuel-tank-size').value) || 0;

            const totalRaceSeconds = totalRaceMinutes * 60;
            const avgLapTimeTotalSeconds = (avgLapTimeMinutes * 60) + avgLapTimeSeconds;
            const totalDrivers = drivers.length;

            let totalLapsCalculated = 0;
            let numberOfPitStops = 0;

            if (avgLapTimeTotalSeconds > 0) {
                totalLapsCalculated = Math.floor(totalRaceSeconds / avgLapTimeTotalSeconds);

                if (fuelPerLap > 0 && fuelTankSize > 0) {
                    const lapsPerTank = Math.floor(fuelTankSize / fuelPerLap);
                    if (lapsPerTank > 0) {
                        numberOfPitStops = Math.floor(totalLapsCalculated / lapsPerTank);
                        if (totalLapsCalculated % lapsPerTank === 0 && totalLapsCalculated > 0) {
                             numberOfPitStops--;
                        }
                    }
                }
            }
            
            const avgPitStopTime = parseInt(document.getElementById('average-pit-stop-time').value) || 0;
            const totalPitTimeSeconds = numberOfPitStops * avgPitStopTime;
            const totalPitTimeMinutes = Math.floor(totalPitTimeSeconds / 60);
            const totalPitTimeRemainingSeconds = totalPitTimeSeconds % 60;

            document.getElementById('total-laps').textContent = totalLapsCalculated;
            document.getElementById('number-of-pit-stops').textContent = numberOfPitStops;
            document.getElementById('total-pit-time').textContent = `${totalPitTimeMinutes}:${String(totalPitTimeRemainingSeconds).padStart(2, '0')}`;
            document.getElementById('total-drivers').textContent = totalDrivers;
        }

        /**
         * Updates the display for the time adjustment slider.
         */
        function updateTimeAdjustmentDisplay() {
            const adjustment = document.getElementById('time-adjustment-slider').value;
            document.getElementById('time-adjustment-value').textContent = adjustment;
            updateSummary();
        }

        /**
         * Creates and displays the stint plan table.
         */
        function createStintPlan() {
            // Get values from planner page
            const raceHours = parseInt(document.getElementById('race-duration-hours').value) || 0;
            const raceMinutes = parseInt(document.getElementById('race-duration-minutes').value) || 0;
            const timeAdjustment = parseInt(document.getElementById('time-adjustment-slider').value) || 0;
            const totalRaceMinutes = (raceHours * 60) + raceMinutes + timeAdjustment;
            const avgLapTimeMinutes = parseInt(document.getElementById('average-lap-time-minutes').value) || 0;
            const avgLapTimeSeconds = parseInt(document.getElementById('average-lap-time-seconds').value) || 0;
            lapsPerStint = parseInt(document.getElementById('laps-per-stint').value) || 0;
            const fuelPerLap = parseFloat(document.getElementById('fuel-per-lap').value) || 0;
            const fuelTankSize = parseFloat(document.getElementById('fuel-tank-size').value) || 0;
            avgPitStopTime = parseInt(document.getElementById('average-pit-stop-time').value) || 0;
            
            // Calculate total laps and other stats
            const totalRaceSeconds = totalRaceMinutes * 60;
            avgLapTimeTotalSeconds = (avgLapTimeMinutes * 60) + avgLapTimeSeconds;
            
            if (avgLapTimeTotalSeconds === 0) {
                 showMessage("Calculation Error", "Average lap time cannot be zero.");
                return;
            }

            totalLaps = Math.floor(totalRaceSeconds / avgLapTimeTotalSeconds);
            if (lapsPerStint === 0) {
                lapsPerStint = Math.floor(fuelTankSize / fuelPerLap);
                if (lapsPerStint === 0) {
                     showMessage("Calculation Error", "Laps per stint cannot be zero. Please check fuel usage or tank size.");
                    return;
                }
            }

            const numberOfStints = Math.ceil(totalLaps / lapsPerStint);
            const totalDrivers = drivers.length;
            const stintTableBody = document.getElementById('stint-table-body');
            stintTableBody.innerHTML = ''; // Clear previous data

            // Get timezone and start time from breakdown page
            const raceStartTimeStr = document.getElementById('race-start-time').value;
            const timezone = document.getElementById('timezone-select').value;
            const [startHour, startMinute] = raceStartTimeStr.split(':').map(Number);
            const now = new Date();
            const raceStartDateTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), startHour, startMinute);
            let currentTime = new Date(raceStartDateTime.getTime());
            
            for (let i = 0; i < numberOfStints; i++) {
                const stintNumber = i + 1;
                const currentDriver = drivers[i % totalDrivers];
                const lapsInThisStint = (i === numberOfStints - 1) ? (totalLaps - (i * lapsPerStint)) : lapsPerStint;

                const stintDurationSeconds = lapsInThisStint * avgLapTimeTotalSeconds;
                const stintEndDateTime = new Date(currentTime.getTime() + stintDurationSeconds * 1000);
                
                const fuelLeftPercent = ((fuelTankSize - (lapsInThisStint * fuelPerLap)) / fuelTankSize) * 100;
                
                const row = stintTableBody.insertRow();
                row.className = 'hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">${stintNumber}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${currentDriver || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${formatDateTime(currentTime, timezone)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${formatDateTime(stintEndDateTime, timezone)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${lapsInThisStint}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${fuelLeftPercent.toFixed(1)}%</td>
                `;
                
                // Add pit stop time to the start of the next stint
                currentTime = new Date(stintEndDateTime.getTime() + avgPitStopTime * 1000);
            }
            showPage('stint-breakdown-page');
        }

        /**
         * Formats a Date object to a human-readable time string for a given timezone.
         * @param {Date} date The date object to format.
         * @param {string} timeZone The IANA time zone name (e.g., 'America/New_York').
         * @returns {string} The formatted date and time string.
         */
        function formatDateTime(date, timeZone) {
            const options = { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                day: '2-digit',
                month: 'short',
                hour12: false,
                timeZone
            };
            return date.toLocaleString('en-US', options);
        }

        /**
         * Populates the timezone select dropdown with common timezones.
         */
        function populateTimezoneOptions() {
            const timezoneSelect = document.getElementById('timezone-select');
            const timezones = [
                'UTC', 'GMT', 'America/New_York', 'America/Los_Angeles', 'Europe/London',
                'Europe/Berlin', 'Asia/Tokyo', 'Asia/Shanghai', 'Australia/Sydney', 'Australia/Melbourne'
            ];
            
            const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            if (!timezones.includes(userTimezone)) {
                timezones.unshift(userTimezone);
            }

            timezoneSelect.innerHTML = '';
            timezones.forEach(tz => {
                const option = document.createElement('option');
                option.value = tz;
                option.textContent = tz;
                timezoneSelect.appendChild(option);
            });
            timezoneSelect.value = userTimezone;
        }

        /**
         * Displays a custom modal with a title and message.
         * @param {string} title The title of the modal.
         * @param {string} message The message to display.
         */
        function showMessage(title, message, isConfirm = false, onConfirm = () => {}) {
            const modal = document.getElementById('custom-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            
            const confirmBtn = document.getElementById('modal-confirm-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');

            if (isConfirm) {
                confirmBtn.classList.remove('hidden');
                cancelBtn.classList.remove('hidden');
                confirmBtn.onclick = () => { onConfirm(); modal.classList.add('hidden'); };
                cancelBtn.onclick = () => { modal.classList.add('hidden'); };
            } else {
                confirmBtn.classList.add('hidden');
                cancelBtn.classList.add('hidden');
            }

            modal.classList.remove('hidden');
        }


        // --- Admin Page Functions ---

        /**
         * Adds a driver to the admin list and saves to local storage.
         */
        function addAdminDriver() {
            const newDriverName = document.getElementById('new-driver-admin').value.trim();
            if (newDriverName && !drivers.includes(newDriverName)) {
                drivers.push(newDriverName);
                saveDataToLocalStorage();
                document.getElementById('new-driver-admin').value = '';
                renderAdminLists();
            }
        }

        /**
         * Adds a track to the admin list and saves to local storage.
         */
        function addAdminTrack() {
            const newTrackName = document.getElementById('new-track-admin').value.trim();
            if (newTrackName && !tracks.includes(newTrackName)) {
                tracks.push(newTrackName);
                saveDataToLocalStorage();
                document.getElementById('new-track-admin').value = '';
                renderAdminLists();
            }
        }

        /**
         * Adds a car to the admin list and saves to local storage.
         */
        function addAdminCar() {
            const newCarName = document.getElementById('new-car-admin').value.trim();
            if (newCarName && !cars.includes(newCarName)) {
                cars.push(newCarName);
                saveDataToLocalStorage();
                document.getElementById('new-car-admin').value = '';
                renderAdminLists();
            }
        }
        
        /**
         * Removes a driver from the admin list and local storage.
         * @param {string} driverName The name of the driver to remove.
         */
        function removeAdminDriver(driverName) {
            showMessage(
                "Confirm Removal",
                `Are you sure you want to remove ${driverName}?`,
                true,
                () => {
                    drivers = drivers.filter(d => d !== driverName);
                    saveDataToLocalStorage();
                    renderAdminLists();
                }
            );
        }
        
        /**
         * Removes a track from the admin list and local storage.
         * @param {string} trackName The name of the track to remove.
         */
        function removeAdminTrack(trackName) {
            showMessage(
                "Confirm Removal",
                `Are you sure you want to remove ${trackName}?`,
                true,
                () => {
                    tracks = tracks.filter(t => t !== trackName);
                    saveDataToLocalStorage();
                    renderAdminLists();
                }
            );
        }
        
        /**
         * Removes a car from the admin list and local storage.
         * @param {string} carName The name of the car to remove.
         */
        function removeAdminCar(carName) {
             showMessage(
                "Confirm Removal",
                `Are you sure you want to remove ${carName}?`,
                true,
                () => {
                    cars = cars.filter(c => c !== carName);
                    saveDataToLocalStorage();
                    renderAdminLists();
                }
            );
        }

        /**
         * Renders the lists for drivers, tracks, and cars on the admin page.
         */
        function renderAdminLists() {
            renderList('driver-admin-list', drivers, removeAdminDriver);
            renderList('track-admin-list', tracks, removeAdminTrack);
            renderList('car-admin-list', cars, removeAdminCar);
        }
        
        /**
         * Generic function to render a list of items with remove buttons.
         * @param {string} listId The ID of the `ul` element.
         * @param {Array<string>} items The array of strings to display.
         * @param {function(string): void} removeHandler The function to call when an item is removed.
         */
        function renderList(listId, items, removeHandler) {
            const listEl = document.getElementById(listId);
            listEl.innerHTML = '';
            items.forEach(item => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between p-2 border-b border-gray-200 dark:border-gray-700';
                li.innerHTML = `
                    <span class="text-gray-800 dark:text-white">${item}</span>
                    <div class="flex items-center space-x-2">
                         <button class="text-red-500 hover:text-red-700 transition-colors duration-200" onclick="removeHandler('${item}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                listEl.appendChild(li);
            });
        }


        // --- Local Storage Functions ---

        /**
         * Saves the current application data to local storage.
         */
        function saveDataToLocalStorage() {
            localStorage.setItem('drivers', JSON.stringify(drivers));
            localStorage.setItem('tracks', JSON.stringify(tracks));
            localStorage.setItem('cars', JSON.stringify(cars));
        }

        /**
         * Loads application data from local storage.
         */
        function loadDataFromLocalStorage() {
            const storedDrivers = localStorage.getItem('drivers');
            const storedTracks = localStorage.getItem('tracks');
            const storedCars = localStorage.getItem('cars');

            if (storedDrivers) {
                drivers = JSON.parse(storedDrivers);
            }
            if (storedTracks) {
                tracks = JSON.parse(storedTracks);
            }
            if (storedCars) {
                cars = JSON.parse(storedCars);
            }
        }
    </script>
</body>
</html>
