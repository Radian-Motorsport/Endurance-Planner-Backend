<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Road+Rage&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.5s, color 0.5s;
            background-color: #808080;
        }
        h1 {
            font-family: 'RoadRage', sans-serif;
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        /* Dark Mode Switch CSS */
        .toggle-switch-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 100;
        }
        .toggle-label {
            width: 50px;
            height: 26px;
            background-color: #ccc;
            display: block;
            border-radius: 9999px;
            position: relative;
            cursor: pointer;
            transition: background-color 0.4s;
        }
        .toggle-label:after {
            content: '';
            width: 20px;
            height: 20px;
            background-color: white;
            border-radius: 9999px;
            position: absolute;
            top: 3px;
            left: 3px;
            transition: all 0.4s;
        }
        input:checked + .toggle-label {
            background-color: #2196F3;
        }
        input:checked + .toggle-label:after {
            left: calc(100% - 3px);
            transform: translateX(-100%);
        }
        select, option, input, number, li {
            color: #000000;
            background-color: #FFFFFF;
        }
        #darkModeSwitch {
            display: none;
        }
        /* --- Dark Mode Color Overrides --- */
        .dark .max-w-4xl {
            background-color: #1e1e1e;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.25);
        }
        .dark h1, .dark h2, .dark h3, .dark .text-gray-800 { color: #ffffff; }
        .dark p, .dark label, .dark .text-gray-600, .dark .text-gray-700 { color: #a0a0a0; }
        .dark .bg-white { background-color: #1e1e1e; }
        .dark .bg-gray-50, .dark .bg-gray-200 { background-color: #2a2a2a; border-color: #333333; }
        .dark .bg-gray-300 { background-color: #a0a0a0; color: #1e1e1e; }
        .dark .bg-blue-600 { background-color: #2b6cb0; }
        .dark .bg-purple-600 { background-color: #6b46c1; }
        .dark .bg-green-600 { background-color: #2f855a; }
        .dark .bg-blue-50, .dark .bg-blue-100 { background-color: #2a4365; border-color: #2c5282; }
        .dark .text-blue-800 { color: #90cdf4; }
        .dark .bg-purple-100 { background-color: #44337a; border-color: #553c9a; }
        .dark .text-purple-800 { color: #d6bcfa; }
        .dark .border-gray-200, .dark .border-gray-300 { border-color: #4a4a4a; }
        .dark .text-gray-900 { color: #ffffff; }
        .dark select, .dark input, .dark textarea, .dark li {
            background-color: #2a2a2a;
            font-weight: bold;
            border-color: #4a4a4a;
            color: #ffffff;
        }
        .dark option, .dark number {
            background-color: #2a2a2a;
            color: #ffffff;
        }
        .dark li {
            background-color: #2a2a2a;
            color: #ffffff;
        }
        @font-face {
            font-family: 'RoadRage';
            src: url('https://radian-motorsport.github.io/Endurance-Planner-Backend/RoadRage.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }
        .road-rage-font {
            font-family: 'RoadRage', sans-serif;
        }
        
        .text-outline {
            text-shadow:
                -1px -1px 0 #000,
                1px -1px 0 #000,
                -1px 1px 0 #000,
                1px 1px 0 #000;
        }
        select {
            max-width: 100%;
            box-sizing: border-box;
        }
        /* Custom Styles for Live Planner */
        .live-planner-controls {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .live-planner-controls label {
            display: block;
            font-size: 0.9em;
            text-align: left;
            margin-bottom: 2px;
        }
        .live-planner-controls div {
            min-width: 150px;
        }
        .live-planner-info p { margin: 5px 0; }
        #countdown-timer { font-size: 2em; font-weight: bold; color: rgb(255, 255, 255); }
        .dark #countdown-timer { color: #48bb78; }
        .dark #live-stint-table th { background-color: #333333; color: #a0a0a0; }
        .dark #live-stint-table td { background-color: #1e1e1e; border-color: #4a4a4a; }
    </style>
</head>
<body>

<div class="max-w-4xl mx-auto bg-white p-6 md:p-10 rounded-xl shadow-lg transition-colors duration-500 space-y-6">

    

                    <div id="race-inputs-container" class="p-6 bg-gray-50 border border-gray-200 rounded-lg">
                    <h3 class="text-xl mb-4 text-gray-800 road-rage-font">Live Race Inputs</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="flex flex-col">
                            <label class="text-sm font-medium text-gray-700">Live Race Remaining</label>
                            <div class="flex items-center mt-1 space-x-2">
                                <input type="number" id="live-race-duration-hours" placeholder="Hours" class="p-2 border border-gray-300 rounded-lg text-gray-800 bg-white w-20 text-center focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                                <span class="text-gray-600">h</span>
                                <input type="number" id="live-race-duration-minutes" placeholder="Minutes" class="p-2 border border-gray-300 rounded-lg text-gray-800 bg-white w-20 text-center focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                                <span class="text-gray-600">m</span>
                            </div>
                        </div>
                        <div class="flex flex-col">
                            <label class="text-sm font-medium text-gray-700">Live Avg. Lap Time</label>
                            <div class="flex items-center mt-1 space-x-2">
                                <input type="number" id="live-avg-lap-time-minutes" placeholder="Minutes" class="p-2 border border-gray-300 rounded-lg text-gray-800 bg-white w-20 text-center focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                                <span class="text-gray-600">min</span>
                                <input type="number" id="live-avg-lap-time-seconds" placeholder="Seconds" class="p-3 border border-gray-300 rounded-lg text-gray-800 bg-white w-20 text-center focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                                <span class="text-gray-600">sec</span>
                            </div>
                        </div>
                        <div class="flex flex-col">
                            <label for="live-fuel-per-lap-display-input" class="text-sm font-medium text-gray-700">Live Fuel Use per Lap (L)</label>
                            <input type="number" id="live-fuel-per-lap-display-input" class="mt-1 p-2 border border-gray-300 rounded-lg text-gray-800 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                        </div>
                        <div class="flex flex-col">
                            <label for="live-tank-capacity-display-input" class="text-sm font-medium text-gray-700">Live Fuel Tank Size (L)</label>
                            <input type="number" id="live-tank-capacity-display-input" class="mt-1 p-2 border border-gray-300 rounded-lg text-gray-800 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                        </div>
                        <div class="flex flex-col">
                            <label for="live-pit-stop-time" class="text-sm font-medium text-gray-700 dark:text-gray-200">Standard Pit Stop Time (seconds)</label>
                            <input type="number" id="live-pit-stop-time" value="30" min="0" class="mt-1 p-2 border border-gray-300 rounded-lg text-gray-800 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 mb-6">
                        </div>
                        <div class="mt-4 flex justify-end">
                            <button id="calculate-page3-button" onclick="handleRecalculation()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200 transform hover:scale-105 mb-6">
                                Calculate
                            </button>
                        </div>
                    </div>
                </div>

    <div class="p-6 bg-gray-100 border border-gray-200 rounded-lg mb-6">
        <h3 class="text-xl mb-4 text-gray-800 road-rage-font"></h3>
        <div class="live-planner-controls">
            <button id="live-start-stop-button" onclick="toggleRace()" class="flex-1 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105">Start Race</button>
            <button id="live-pit-exit-button" onclick="simulatePitExit()" class="flex-1 bg-orange-500 text-gray-800 font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105" disabled>Pit Exit</button>
        </div>
    </div>

    <div id="live-overall-summary" class="p-6 bg-blue-100 border border-blue-200 rounded-lg mb-6">
    <h3 class="text-xl font- mb-4 text-blue-800 road-rage-font mb-8">Live Overall Strategy Summary</h3>
    <div class="grid grid-cols-4 md:grid-cols-4 lg:grid-cols-4 gap-4 text-blue-800">
        <div>
            <div class="flex flex-col items-center">
                <i class="fa-solid fa-flag-checkered fa-2xl text-blue-800 mb-4"></i>
                <span id="live-est-laps-display" class="font-semibold text-lg text-blue-800"></span>
                <span class="text-sm mb-4">Est. Laps</span>
            </div>
        </div>
        <div>
            <div class="flex flex-col items-center">
                <i class="fa-solid fa-hourglass-half fa-2xl text-blue-800 mb-4"></i>
                <span id="live-stint-duration-display" class="font-semibold text-lg text-blue-800"></span>
                <span class="text-sm mb-4">Stint Duration</span>
            </div>
        </div>
        <div>
            <div class="flex flex-col items-center">
                <i class="fa-solid fa-flag fa-2xl text-blue-800 mb-4"></i>
                <span id="live-laps-per-stint-display" class="font-semibold text-lg text-blue-800"></span>
                <span class="text-sm mb-4">Laps per Stint</span>
            </div>
        </div>
        <div>
            <div class="flex flex-col items-center">
                <i class="fa-solid fa-hand fa-2xl text-blue-800 mb-4"></i>
                <span id="live-pit-stops-display" class="font-semibold text-lg text-blue-800"></span>
                <span class="text-sm mb-4">Pit Stops</span>
            </div>
        </div>
        <div>
            <div class="flex flex-col items-center">
                <i class="fa-solid fa-gas-pump fa-2xl text-blue-800 mb-4"></i>
                <span id="live-total-fuel-display" class="font-semibold text-lg text-blue-800"></span>
                <span class="text-sm mb-4">Total Fuel</span>
            </div>
        </div>
        <div>
            <div class="flex flex-col items-center">
                <i class="fa-solid fa-droplet fa-2xl text-blue-800 mb-4"></i>
                <span id="live-fuel-per-lap-display" class="font-semibold text-lg text-blue-800"></span>
                <span class="text-sm mb-4">Fuel per Lap</span>
            </div>
        </div>
        <div>
            <div class="flex flex-col items-center">
                <i class="fa-solid fa-stopwatch fa-2xl text-blue-800 mb-4"></i>
                <div class="flex items-baseline space-x-1">
                    <span id="live-lap-time-minutes-display" class="font-semibold text-lg text-blue-800">00</span>
                    <span class="text-sm">m</span>
                    <span id="live-lap-time-seconds-display" class="font-semibold text-lg text-blue-800">00</span>
                    <span class="text-sm">s</span>
                </div>
                <span class="text-sm mt-1">Lap Time</span>
            </div>
        </div>
        <div>
            <div class="flex flex-col items-center">
                <i class="fa-solid fa-stopwatch fa-2xl text-blue-800 mb-4"></i>
                <span id="live-pit-stop-duration-display" class="font-semibold text-lg text-blue-800"></span>
                <span class="text-sm mb-4">Pit Stop Duration</span>
            </div>
        </div>
    </div>
</div>
    

    <div id="live-sliders-container" class="p-6 bg-gray-50 border border-gray-200 rounded-lg mb-6">
    <h3 class="text-xl font- mb-4 text-gray-800 road-rage-font">Live Dynamic Adjustments</h3>
    
    <div class="flex flex-col space-y-4">
        
        <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
            <div class="flex-grow w-full">
                <label for="fuel-slider" class="text-sm font-medium text-gray-700">Adjust Fuel per Lap</label>
                <div class="flex items-center mt-1 space-x-2">
                    <button class="adjust-button text-gray-500 hover:text-gray-900" data-target="fuel-slider" data-step="-0.05">
                        <i class="fa-solid fa-minus"></i>
                    </button>
                    <input type="range" id="fuel-slider" min="-2.0" max="2.0" value="0.0" step="0.05" class="w-full">
                    <button class="adjust-button text-gray-500 hover:text-gray-900" data-target="fuel-slider" data-step="0.05">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                    <span id="live-fuel-slider-value" class="text-gray-900 font-mono text-sm w-12 text-right">0.0</span>
                </div>
            </div>
            
            <div class="flex-grow w-full">
                <label for="live-lap-time-adjustment-slider" class="text-sm font-medium text-gray-700">Adjust Lap Time</label>
                <div class="flex items-center mt-1 space-x-2">
                    <button class="adjust-button text-gray-500 hover:text-gray-900" data-target="live-lap-time-adjustment-slider" data-step="-0.1">
                        <i class="fa-solid fa-minus"></i>
                    </button>
                    <input type="range" id="live-lap-time-adjustment-slider" min="-5" max="5" value="0.0" step="0.1" class="w-full">
                    <button class="adjust-button text-gray-500 hover:text-gray-900" data-target="live-lap-time-adjustment-slider" data-step="0.1">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                    <span id="live-lap-time-slider-value" class="text-gray-900 font-mono text-sm w-12 text-right">0.0</span>
                </div>
            </div>
        </div>

        <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
            <div class="flex-grow w-full">
                <label class="text-sm font-medium text-gray-700">Pit Stop Time</label>
                <div class="flex items-center mt-1 space-x-2">
                    <input type="number" id="live-pit-stop-time-minutes" placeholder="Minutes" value="0" class="p-2 border border-gray-300 rounded-lg text-gray-800 bg-white w-20 text-center focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                    <span class="text-gray-600">min</span>
                    <input type="number" id="live-pit-stop-time-seconds" placeholder="Seconds" value="30" class="p-3 border border-gray-300 rounded-lg text-gray-800 bg-white w-20 text-center focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                    <span class="text-gray-600">sec</span>
                </div>
            </div>

            <div class="flex-grow w-full">
                <label class="text-sm font-medium text-gray-700">Repair Time</label>
                <div class="flex flex-col space-y-2 mt-1">
                    <div class="flex items-center space-x-2">
                        <input type="number" id="live-extra-pit-time-minutes" placeholder="Minutes" value="0" class="p-2 border border-gray-300 rounded-lg text-gray-800 bg-white w-20 text-center focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                        <span class="text-gray-600">min</span>
                        <input type="number" id="live-extra-pit-time-seconds" placeholder="Seconds" value="0" class="p-3 border border-gray-300 rounded-lg text-gray-800 bg-white w-20 text-center focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                        <span class="text-gray-600">sec</span>
                    </div>
                    
                </div>
            </div>
        
        </div>
        <div class="flex space-x-2 mt-2">
            <button id="repair-complete-button" class="p-2 flex-1 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-200 text-xs">Repair Complete (Pitstop Over)</button>            
            <button id="add-repair-time-button" class="p-2 flex-1 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition duration-200 text-xs">Add Repair Time</button>
                        
        </div>
    </div>
</div>
   
   
            <div id="timers" class="hidden">
                    <div>
                    <p class="flex justify-between items-center bg-gray-200 text-black py-3 px-6 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105 mb-6">
                        <span>TIME REMAINING</span>
                        <span id="countdown-timer" class="absolute left-1/2 -translate-x-1/2 !text-4xl !text-green-600">00:00:00</span>
                    </p>
                    <p class="flex justify-between items-center bg-gray-200 text-black text-sm py-3 px-6 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105 mb-6">
                        <span>NEXT STOP</span>
                        <span id="next-pitstop-time" class="absolute left-1/2 -translate-x-1/2 text-xl !text-orange-500">00:00:00</span>
                    </p>
                    <p id="in-pit-display" class="flex justify-between items-center bg-orange-500 text-black text-sm py-3 px-6 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105 mb-6 hidden">
                        <span class="flex-grow text-center text-xl !text-white">IN PIT</span>
                        <h2 id="pit-timer-countdown" class="hidden text-3xl font-bold text-center text-bg-orange-500"></h2>
                    </p>
                    <div id="pit-exit-banner" class="hidden text-2xl font-bold text-center bg-green-600 text-white p-4 rounded-lg z-50 shadow-lg">PIT EXIT</div>
                </div>                    

            </div> 

            <div class="flex flex-col items-center mt-4 text-sm font-semibold text-gray-800">
                    <div>
                        Current Stint: <span id="current-stint-display">1</span>
                    </div>
                    <div>
                        Active Pit Stop: <span id="current-pit-display">0</span>
                    </div>
                </div>
                <div id="live-table" class="hidden">     
                    <table id="live-stint-table" class="min-w-full divide-y divide-gray-200 border border-gray-300 rounded-lg mt-6">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="px-1 py-3 text-center text-m font-medium text-gray-700 uppercase tracking-wider border-r border-gray-300">Stint</th>
                                <th class="px-1 py-3 text-center text-m font-medium text-gray-700 uppercase tracking-wider border-r border-gray-300">Start Time</th>
                                <th class="px-1 py-3 text-center text-m font-medium text-gray-700 uppercase tracking-wider border-r border-gray-300">End Time</th>
                                <th class="px-1 py-3 text-center text-m font-medium text-gray-700 uppercase tracking-wider border-r border-gray-300">Stint Duration</th>
                                <th class="px-1 py-3 text-center text-m font-medium text-gray-700 uppercase tracking-wider border-r border-gray-300">Stint Laps</th>
                                <th class="px-1 py-3 text-center text-m font-medium text-gray-700 uppercase tracking-wider border-r border-gray-300">Fuel Per Stint (L)</th>
                            </tr>
                        </thead>
                        <tbody id="live-stint-table-body" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div> 
                  
</div>
<script>
    
// Global variables to manage the race state
let liveTimerInterval = null;
let liveRaceRemainingSeconds = 0;
let liveStintStartTimestamp = 0;
let liveStintDurationSeconds = 0;
let isRaceRunning = false;
let completedStints = [];
let stintNumber = 1;
let pitStopTime = 0;
let isPitting = false;
let currentStintActive = 1;
let currentPitActive = 0; 
let livePitRemainingSeconds = 0;


// This function formats time from seconds into HH:MM:SS format
function formatTime(totalSeconds) {
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = Math.floor(totalSeconds % 60);
    const pad = (num) => String(num).padStart(2, '0');
    return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
}

// This function formats time from seconds into separate minutes and seconds, including decimals
function formatLapTime(totalSeconds) {
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = (totalSeconds % 60).toFixed(1); // Keep one decimal place
    
    const paddedMinutes = String(minutes).padStart(2, '0');
    const paddedSeconds = String(seconds).padStart(2, '0');

    return {
        minutes: paddedMinutes,
        seconds: paddedSeconds
    };
}

// This function starts the race timer
function startRace() {
    const hours = parseInt(document.getElementById('live-race-duration-hours').value) || 0;
    const minutes = parseInt(document.getElementById('live-race-duration-minutes').value) || 0;
    
    liveRaceRemainingSeconds = (hours * 3600) + (minutes * 60);
    
    if (liveRaceRemainingSeconds <= 0) {
        console.error("Please enter a valid race duration.");
        return;
    }

    clearInterval(liveTimerInterval);
    liveStintStartTimestamp = Date.now();
    isRaceRunning = true;
    isPitting = false;
    
    completedStints = [];
    stintNumber = 1;
    currentStintActive = 1;
    currentPitActive = 0;
    livePitRemainingSeconds = 0;

    updateStatusDisplays(); 
    
    calculateStintDuration();
    populateStintTableFromLiveInputs(liveRaceRemainingSeconds);

    liveTimerInterval = setInterval(updateTimer, 1000);
    
    const startStopButton = document.getElementById('live-start-stop-button');
    startStopButton.textContent = 'Stop Race';
    startStopButton.classList.add('bg-red-600', 'hover:bg-red-700');
    startStopButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
    
    // The button is now always enabled, as requested
    document.getElementById('live-pit-exit-button').disabled = false;
    document.getElementById('race-inputs-container').classList.add('hidden');
    document.getElementById('in-pit-display').classList.add('hidden');
    document.getElementById('live-sliders-container').classList.remove('hidden');
    document.getElementById('timers').classList.remove('hidden');

    const pitTimerElement = document.getElementById('pit-timer-countdown');
    if (pitTimerElement) {
        pitTimerElement.classList.add('hidden');
    }
}

// This function stops the race timer
function stopRace() {
    clearInterval(liveTimerInterval);
    isRaceRunning = false;
    isPitting = false;
    const startStopButton = document.getElementById('live-start-stop-button');
    startStopButton.textContent = 'Start Race';
    startStopButton.classList.remove('bg-red-600', 'hover:bg-red-700');
    startStopButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
    
    document.getElementById('live-pit-exit-button').disabled = true;
    document.getElementById('race-inputs-container').classList.remove('hidden');
    document.getElementById('in-pit-display').classList.add('hidden');
    document.getElementById('live-sliders-container').classList.add('hidden');
    document.getElementById('timers').classList.add('hidden');     

    const pitTimerElement = document.getElementById('pit-timer-countdown');
    if (pitTimerElement) {
        pitTimerElement.classList.add('hidden');
    }
}

// This function toggles between starting and stopping the race
function toggleRace() {
    const startStopButton = document.getElementById('live-start-stop-button');
    if (startStopButton.textContent === 'Start Race') {
        startRace();
    } else {
        stopRace();
    }
}

// This function recalculates the stint duration based on inputs and sliders
function calculateStintDuration() {
    const fuelTankSize = parseFloat(document.getElementById('live-tank-capacity-display-input').value) || 0;
    let fuelUsePerLap = parseFloat(document.getElementById('live-fuel-per-lap-display-input').value) || 0;
    const avgLapTimeMinutes = parseInt(document.getElementById('live-avg-lap-time-minutes').value) || 0;
    const avgLapTimeSeconds = parseFloat(document.getElementById('live-avg-lap-time-seconds').value) || 0;

    const fuelSliderAdjustment = parseFloat(document.getElementById('fuel-slider').value) || 0;
    fuelUsePerLap += fuelSliderAdjustment;
    const lapTimeSliderAdjustment = parseFloat(document.getElementById('live-lap-time-adjustment-slider').value) || 0;
    const avgLapTimeInSeconds = ((avgLapTimeMinutes * 60) + avgLapTimeSeconds) + lapTimeSliderAdjustment;

    const pitStopMinutes = parseInt(document.getElementById('live-pit-stop-time-minutes').value) || 0;
    const pitStopSeconds = parseInt(document.getElementById('live-pit-stop-time-seconds').value) || 0;
    const extraPitMinutes = parseInt(document.getElementById('live-extra-pit-time-minutes').value) || 0;
    const extraPitSeconds = parseInt(document.getElementById('live-extra-pit-time-seconds').value) || 0;
    pitStopTime = (pitStopMinutes * 60) + pitStopSeconds + (extraPitMinutes * 60) + extraPitSeconds;

    if (fuelTankSize > 0 && fuelUsePerLap > 0 && avgLapTimeInSeconds > 0) {
        const lapsPerStint = Math.floor(fuelTankSize / fuelUsePerLap);
        liveStintDurationSeconds = lapsPerStint * avgLapTimeInSeconds;
    } else {
        liveStintDurationSeconds = 0;
    }
}

// NEW: This is the automatic pit entry function (can also be used for a "Pit Now" button)
function simulateAutomaticPitEntry() {
    // Record the completed stint
    const currentStintDuration = Math.floor((Date.now() - liveStintStartTimestamp) / 1000);
    const avgLapTimeInSeconds = (parseInt(document.getElementById('live-avg-lap-time-minutes').value) * 60) + (parseFloat(document.getElementById('live-avg-lap-time-seconds').value));
    const currentStintLaps = avgLapTimeInSeconds > 0 ? Math.floor(currentStintDuration / avgLapTimeInSeconds) : 0;
    const fuelUsePerLap = parseFloat(document.getElementById('live-fuel-per-lap-display-input').value) || 0;
    const currentStintFuel = currentStintLaps * fuelUsePerLap;

    completedStints.push({
        stintNumber: stintNumber,
        stintDuration: currentStintDuration,
        stintLaps: currentStintLaps,
        stintFuel: currentStintFuel
    });

    stintNumber++;
    currentStintActive++;
    
    // Start the pit cycle
    isPitting = true;
    currentPitActive++; // Correctly increments the pit counter
    livePitRemainingSeconds = pitStopTime;
    
    updateStatusDisplays();

    document.getElementById('in-pit-display').classList.remove('hidden');
    const pitTimerElement = document.getElementById('pit-timer-countdown');
    if (pitTimerElement) {
        pitTimerElement.classList.remove('hidden');
    }
    
    // Recalculate and re-render the table
    populateStintTableFromLiveInputs(liveRaceRemainingSeconds);
}


// NEW: This is the manual pit exit button function for unplanned stops
function simulatePitExit() {
    if (!isRaceRunning) return;

    // Record the unplanned pit stop and recalculate the race
    const currentStintDuration = Math.floor((Date.now() - liveStintStartTimestamp) / 1000);
    const avgLapTimeInSeconds = (parseInt(document.getElementById('live-avg-lap-time-minutes').value) * 60) + (parseFloat(document.getElementById('live-avg-lap-time-seconds').value));
    const currentStintLaps = avgLapTimeInSeconds > 0 ? Math.floor(currentStintDuration / avgLapTimeInSeconds) : 0;
    const fuelUsePerLap = parseFloat(document.getElementById('live-fuel-per-lap-display-input').value) || 0;
    const currentStintFuel = currentStintLaps * fuelUsePerLap;

    completedStints.push({
        stintNumber: stintNumber,
        stintDuration: currentStintDuration,
        stintLaps: currentStintLaps,
        stintFuel: currentStintFuel
    });
    stintNumber++;
    currentStintActive++;
    currentPitActive++;
    
    // A manual pit stop means the on-track stint starts NOW
    isPitting = false;
    
    // Show the new pit exit banner for 10 seconds
    const pitExitBanner = document.getElementById('pit-exit-banner');
    if (pitExitBanner) {
        pitExitBanner.classList.remove('hidden');
        setTimeout(() => {
            pitExitBanner.classList.add('hidden');
        }, 10000); // 10000 milliseconds = 10 seconds
    }

    // This line was removed: currentPitActive = 0;
    liveStintStartTimestamp = Date.now();
    
    document.getElementById('in-pit-display').classList.add('hidden');
    const pitTimerElement = document.getElementById('pit-timer-countdown');
    if (pitTimerElement) {
        pitTimerElement.classList.add('hidden');
    }
    
    // Reset the repair time inputs when the pit stop ends
    document.getElementById('live-extra-pit-time-minutes').value = 0;
    document.getElementById('live-extra-pit-time-seconds').value = 0;
    
    // IMPORTANT: We now recalculate the entire plan based on the NEW remaining race time.
    populateStintTableFromLiveInputs(liveRaceRemainingSeconds);
    updateStatusDisplays();
}


// The core timer function
function updateTimer() {
    const now = Date.now();
    
    // The main race clock always runs
    liveRaceRemainingSeconds = Math.max(0, liveRaceRemainingSeconds - 1);
    document.getElementById('countdown-timer').textContent = formatTime(liveRaceRemainingSeconds);

    if (isPitting) {
        // Pit countdown logic for the automatic cycle
        livePitRemainingSeconds = Math.max(0, livePitRemainingSeconds - 1);
        const pitTimerElement = document.getElementById('pit-timer-countdown');
        if (pitTimerElement) {
            pitTimerElement.textContent = formatTime(livePitRemainingSeconds);
        }

        if (livePitRemainingSeconds <= 0) {
            // Pit countdown is over, automatically start the next stint
            isPitting = false;
            document.getElementById('in-pit-display').classList.add('hidden');
            if (pitTimerElement) {
                pitTimerElement.classList.add('hidden');
            }
            liveStintStartTimestamp = Date.now();
            populateStintTableFromLiveInputs(liveRaceRemainingSeconds);

            // Reset the repair time inputs when the pit stop ends
            document.getElementById('live-extra-pit-time-minutes').value = 0;
            document.getElementById('live-extra-pit-time-seconds').value = 0;
        }
    } else {
        // On-track stint countdown logic
        const elapsed = Math.floor((now - liveStintStartTimestamp) / 1000);
        const stintTimeRemaining = Math.max(0, liveStintDurationSeconds - elapsed);
        document.getElementById('next-pitstop-time').textContent = formatTime(stintTimeRemaining);
        
        // Automatic pit trigger
        if (stintTimeRemaining <= 0 && liveRaceRemainingSeconds > 0) {
            simulateAutomaticPitEntry();
        }
    }
    
    if (liveRaceRemainingSeconds <= 0) {
        clearInterval(liveTimerInterval);
        document.getElementById('countdown-timer').textContent = "Race Finished!";
        document.getElementById('live-pit-exit-button').disabled = true;
        document.getElementById('race-inputs-container').classList.remove('hidden');
        document.getElementById('in-pit-display').classList.add('hidden');
        const pitTimerElement = document.getElementById('pit-timer-countdown');
        if (pitTimerElement) {
            pitTimerElement.classList.add('hidden');
        }
    }
}

// This function is the "brain" of the live planner, now with persistent stints.
function populateStintTableFromLiveInputs(raceDurationInSeconds) {
    const avgLapTimeMinutes = parseInt(document.getElementById('live-avg-lap-time-minutes').value) || 0;
    const avgLapTimeSeconds = parseFloat(document.getElementById('live-avg-lap-time-seconds').value) || 0;
    // Removed the incorrect pit stop time calculation here.
    let fuelUsePerLap = parseFloat(document.getElementById('live-fuel-per-lap-display-input').value) || 0;
    const fuelTankSize = parseFloat(document.getElementById('live-tank-capacity-display-input').value) || 0;

    const fuelSliderAdjustment = parseFloat(document.getElementById('fuel-slider').value) || 0;
    fuelUsePerLap += fuelSliderAdjustment;

    const lapTimeSliderAdjustment = parseFloat(document.getElementById('live-lap-time-adjustment-slider').value) || 0;
    const avgLapTimeInSeconds = ((avgLapTimeMinutes * 60) + avgLapTimeSeconds) + lapTimeSliderAdjustment;

    if (raceDurationInSeconds <= 0 || avgLapTimeInSeconds <= 0 || fuelUsePerLap <= 0 || fuelTankSize <= 0) {
        document.getElementById('live-overall-summary').classList.add('hidden');
        document.getElementById('live-table').classList.add('hidden');
        document.getElementById('live-sliders-container').classList.add('hidden');
        document.getElementById('live-stint-table-body').innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">Please enter valid positive values for all race inputs.</td></tr>';
        return;
    }

    const lapsPerStint = Math.floor(fuelTankSize / fuelUsePerLap);
    const stintDurationSeconds = lapsPerStint * avgLapTimeInSeconds;
    const totalLaps = Math.floor(raceDurationInSeconds / avgLapTimeInSeconds);
    const totalStints = Math.ceil(raceDurationInSeconds / (stintDurationSeconds + pitStopTime));
    
    if (totalStints <= 0) {
        document.getElementById('live-stint-table-body').innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">No stints to display. Please adjust inputs.</td></tr>';
        document.getElementById('live-overall-summary').classList.add('hidden');
        document.getElementById('live-table').classList.add('hidden');
        document.getElementById('live-sliders-container').classList.add('hidden');
        return;
    }

    document.getElementById('live-est-laps-display').textContent = totalLaps;
    document.getElementById('live-stint-duration-display').textContent = formatTime(stintDurationSeconds);
    document.getElementById('live-laps-per-stint-display').textContent = lapsPerStint;
    document.getElementById('live-pit-stops-display').textContent = Math.max(0, totalStints - 1);
    document.getElementById('live-total-fuel-display').textContent = (totalLaps * fuelUsePerLap).toFixed(2) + ' L';
    document.getElementById('live-fuel-per-lap-display').textContent = fuelUsePerLap.toFixed(2) + ' L';
    // Get the formatted minutes and seconds using the new helper function
    const formattedLapTime = formatLapTime(avgLapTimeInSeconds);

    // Update the new HTML elements with the correct values
    document.getElementById('live-lap-time-minutes-display').textContent = formattedLapTime.minutes;
    document.getElementById('live-lap-time-seconds-display').textContent = formattedLapTime.seconds;
    document.getElementById('live-pit-stop-duration-display').textContent = pitStopTime + ' sec';
    
    const tbody = document.getElementById('live-stint-table-body');
    tbody.innerHTML = '';
    
    let currentTimeSeconds = 0;
    
    completedStints.forEach((stint, index) => {
        const stintStart = currentTimeSeconds;
        const stintEnd = stintStart + stint.stintDuration;
        const pitStart = stintEnd;
        const pitEnd = pitStart + pitStopTime;
        const pitNumberForTable = index + 1;

        const stintRow = document.createElement('tr');
        stintRow.innerHTML = `
            <td class="px-1 py-4 text-center text-l text-gray-500 border-r border-gray-300 dark:border-gray-500 font-bold">${stint.stintNumber}</td>
            <td class="px-1 py-4 text-center text-l text-gray-500 border-r border-gray-300 dark:border-gray-500">${formatTime(stintStart)}</td>
            <td class="px-1 py-4 text-center text-l text-gray-500 border-r border-gray-300 dark:border-gray-500">${formatTime(stintEnd)}</td>
            <td class="px-1 py-4 text-center text-l text-gray-500 border-r border-gray-300 dark:border-gray-500">${formatTime(stint.stintDuration)}</td>
            <td class="px-1 py-4 text-center text-l text-gray-500 border-r border-gray-300 dark:border-gray-500">${stint.stintLaps}</td>
            <td class="px-1 py-4 text-center text-l text-gray-500 border-r border-gray-300 dark:border-gray-500">${stint.stintFuel.toFixed(2)} L</td>
        `;
        tbody.appendChild(stintRow);

        const pitRow = document.createElement('tr');
        if (isPitting && pitNumberForTable === currentPitActive) {
            pitRow.classList.add('bg-orange-200', 'dark:bg-orange-700');
            pitRow.classList.remove('bg-gray-100', 'dark:bg-gray-700');
        } else {
            pitRow.classList.add('bg-gray-100', 'dark:bg-gray-700');
        }

        pitRow.classList.add('text-xs');
        pitRow.innerHTML = `
            <td class="px-1 py-2 text-center border-r border-gray-300 dark:border-gray-500 road-rage-font text-gray-800 dark:text-white">PIT</td>
            <td class="px-1 py-2 text-center border-r border-gray-300 dark:border-gray-500 text-gray-800 dark:text-white">${formatTime(pitStart)}</td>
            <td class="px-1 py-2 text-center border-r border-gray-300 dark:border-gray-500 text-gray-800 dark:text-white">${formatTime(pitEnd)}</td>
            <td class="px-1 py-2 text-center border-r border-gray-300 dark:border-gray-500 text-gray-800 dark:text-white">${formatTime(pitStopTime)}</td>
            <td class="px-1 py-2 text-center border-r border-gray-300 dark:border-gray-500 text-gray-800 dark:text-white">-</td>
            <td class="px-1 py-2 text-center border-r border-gray-300 dark:border-gray-500 text-gray-800 dark:text-white">-</td>
        `;
        tbody.appendChild(pitRow);

        currentTimeSeconds = pitEnd;
    });

    const remainingStintsCount = Math.ceil(raceDurationInSeconds / (stintDurationSeconds + pitStopTime));
    
    for (let i = 0; i < remainingStintsCount; i++) {
        const stintLaps = Math.min(lapsPerStint, totalLaps - (i * lapsPerStint));
        const currentStintDuration = stintLaps * avgLapTimeInSeconds;
        const stintFuel = stintLaps * fuelUsePerLap;

        if (stintLaps <= 0) break;

        const stintNumberForTable = i + completedStints.length + 1;
        const startTimeFormatted = formatTime(currentTimeSeconds);
        
        currentTimeSeconds += currentStintDuration;
        
        const endTimeFormatted = formatTime(currentTimeSeconds);
        
        const stintRow = document.createElement('tr');
        stintRow.classList.add('bg-white', 'dark:bg-gray-800');
        
        if (!isPitting && stintNumberForTable === currentStintActive) {
            stintRow.classList.add('bg-yellow-100', 'dark:bg-yellow-800');
        }
        
        stintRow.innerHTML = `
            <td class="px-1 py-4 text-center text-m text-gray-500 border-r border-gray-300 dark:border-gray-500 font-bold">${stintNumberForTable}</td>
            <td class="px-1 py-4 text-center text-m text-gray-500 border-r border-gray-300 dark:border-gray-500">${startTimeFormatted}</td>
            <td class="px-1 py-4 text-center text-m text-gray-500 border-r border-gray-300 dark:border-gray-500">${endTimeFormatted}</td>
            <td class="px-1 py-4 text-center text-m text-gray-500 border-r border-gray-300 dark:border-gray-500">${formatTime(currentStintDuration)}</td>
            <td class="px-1 py-4 text-center text-m text-gray-500 border-r border-gray-300 dark:border-gray-500">${stintLaps}</td>
            <td class="px-1 py-4 text-center text-m text-gray-500 border-r border-gray-300 dark:border-gray-500">${stintFuel.toFixed(2)} L</td>
        `;
        tbody.appendChild(stintRow);

        if (i < remainingStintsCount - 1) {
            const pitStartTimeFormatted = endTimeFormatted;
            currentTimeSeconds += pitStopTime;
            const pitEndTimeFormatted = formatTime(currentTimeSeconds);
            
            const pitRow = document.createElement('tr');
            pitRow.classList.add('bg-gray-100', 'dark:bg-gray-700', 'text-sm');
            
            pitRow.innerHTML = `
                <td class="px-1 py-2 text-center border-r border-gray-300 dark:border-gray-500 road-rage-font text-gray-800 dark:text-white">PIT</td>
                <td class="px-1 py-2 text-center border-r border-gray-300 dark:border-gray-500 text-gray-800 dark:text-white">${pitStartTimeFormatted}</td>
                <td class="px-1 py-2 text-center border-r border-gray-300 dark:border-gray-500 text-gray-800 dark:text-white">${pitEndTimeFormatted}</td>
                <td class="px-1 py-2 text-center border-r border-gray-300 dark:border-gray-500 text-gray-800 dark:text-white">${formatTime(pitStopTime)}</td>
                <td class="px-1 py-2 text-center border-r border-gray-300 dark:border-gray-500 text-gray-800 dark:text-white">-</td>
                <td class="px-1 py-2 text-center border-r border-gray-300 dark:border-gray-500 text-gray-800 dark:text-white">-</td>
            `;
            tbody.appendChild(pitRow);
        }
    }
    
    document.getElementById('live-overall-summary').classList.remove('hidden');
    document.getElementById('live-sliders-container').classList.remove('hidden');
    document.getElementById('live-table').classList.remove('hidden');
}

// Function to handle all recalculations
function handleRecalculation() {
    calculateStintDuration();
    let raceDurationForCalculation = 0;
    if (isRaceRunning) {
        raceDurationForCalculation = liveRaceRemainingSeconds;
    } else {
        const hours = parseInt(document.getElementById('live-race-duration-hours').value) || 0;
        const minutes = parseInt(document.getElementById('live-race-duration-minutes').value) || 0;
        raceDurationForCalculation = (hours * 3600) + (minutes * 60);
    }
    populateStintTableFromLiveInputs(raceDurationForCalculation);
}

// Event handlers for inputs and sliders
function setupEventHandlers() {
    const liveFuelSlider = document.getElementById('fuel-slider');
    const liveFuelSliderValue = document.getElementById('live-fuel-slider-value');
    const liveLapTimeAdjustmentSlider = document.getElementById('live-lap-time-adjustment-slider');
    const liveLapTimeAdjustmentSliderValue = document.getElementById('live-lap-time-slider-value');
    const addRepairTimeButton = document.getElementById('add-repair-time-button');
    const repairCompleteButton = document.getElementById('repair-complete-button');

    document.getElementById('calculate-page3-button').addEventListener('click', handleRecalculation);

    const otherInputs = document.querySelectorAll('#live-avg-lap-time-minutes, #live-avg-lap-time-seconds, #live-fuel-per-lap-display-input, #live-tank-capacity-display-input, #live-pit-stop-time-minutes, #live-pit-stop-time-seconds, #live-extra-pit-time-minutes, #live-extra-pit-time-seconds');
    otherInputs.forEach(input => {
        input.addEventListener('input', handleRecalculation);
    });

    if (liveFuelSlider) {
        liveFuelSlider.addEventListener('input', () => {
            liveFuelSliderValue.textContent = parseFloat(liveFuelSlider.value).toFixed(1);
            handleRecalculation();
        });
    }

    if (liveLapTimeAdjustmentSlider) {
        liveLapTimeAdjustmentSlider.addEventListener('input', () => {
            liveLapTimeAdjustmentSliderValue.textContent = liveLapTimeAdjustmentSlider.value;
            handleRecalculation();
        });
    }

    if (addRepairTimeButton) {
        addRepairTimeButton.addEventListener('click', addRepairTime);
    }
    
    // New event listener for the repair complete button
    if (repairCompleteButton) {
        repairCompleteButton.addEventListener('click', completeRepair);
    }
    
    handleRecalculation();
}

document.addEventListener('DOMContentLoaded', setupEventHandlers);

// Function to end the pit stop immediately
function completeRepair() {
    if (isRaceRunning && isPitting) {
        livePitRemainingSeconds = 0;
        console.log("Repair complete. Pit stop ended manually.");
        alert("Repair complete. Pit stop will end in less than one second.");
        document.getElementById('in-pit-display').classList.add('hidden');
        const pitTimerElement = document.getElementById('pit-timer-countdown');
        if (pitTimerElement) {
            pitTimerElement.classList.add('hidden');
        }
        // Reset the repair time inputs when the pit stop ends
        document.getElementById('live-extra-pit-time-minutes').value = 0;
        document.getElementById('live-extra-pit-time-seconds').value = 0;
    } else {
        alert("Cannot complete repair: The race is not running or the car is not in the pit.");
    }
}

// Function to add repair time to the live pit countdown
function addRepairTime() {
    // Get the minutes and seconds from the repair time inputs
    const extraMinutes = parseInt(document.getElementById('live-extra-pit-time-minutes').value) || 0;
    const extraSeconds = parseInt(document.getElementById('live-extra-pit-time-seconds').value) || 0;
    
    const repairTimeInSeconds = (extraMinutes * 60) + extraSeconds;

    // Check if a race is running and the car is currently in the pit
    if (isRaceRunning && isPitting) {
        livePitRemainingSeconds += repairTimeInSeconds;
        console.log(`Added ${repairTimeInSeconds} seconds to the pit timer.`);
        alert(`Added ${repairTimeInSeconds} seconds to the pit timer.`);
    } else {
        alert("Cannot add repair time: The race is not running or the car is not in the pit.");
    }
}

// Function to update the visual displays
function updateStatusDisplays() {
    document.getElementById('current-stint-display').textContent = currentStintActive;
    document.getElementById('current-pit-display').textContent = currentPitActive;
}


document.addEventListener('DOMContentLoaded', () => {
    const adjustButtons = document.querySelectorAll('.adjust-button');

    adjustButtons.forEach(button => {
        button.addEventListener('click', () => {
            const sliderId = button.dataset.target;
            const step = parseFloat(button.dataset.step);
            const slider = document.getElementById(sliderId);

            if (slider) {
                let currentValue = parseFloat(slider.value);
                let newValue = currentValue + step;

                // Clamp the new value to stay within the slider's min/max range
                newValue = Math.max(parseFloat(slider.min), Math.min(parseFloat(slider.max), newValue));

                slider.value = newValue;
                
                // Manually trigger an input event to update the display
                const event = new Event('input', { bubbles: true });
                slider.dispatchEvent(event);
            }
        });
    });
});

</script>
</body>
</html>